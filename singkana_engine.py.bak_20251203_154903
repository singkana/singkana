"""
SingKANA β 用の超シンプルなスタブエンジン。
- OpenAI など外部APIは一切呼ばない
- 例外が出てもサービス全体は落とさない
- app_web.py から呼ばれる関数だけを提供する
"""

from __future__ import annotations

import datetime
from pathlib import Path
from typing import List, Dict

# ===== ログ出力先 =====
LOG_DIR = Path("Logs")
LOG_DIR.mkdir(exist_ok=True)

CONVERT_LOG = LOG_DIR / "convert.log"
FEEDBACK_LOG = LOG_DIR / "feedback.log"


class SingKanaError(Exception):
    """SingKANA 専用の業務エラー（app_web 側でハンドリングされる想定）。"""
    pass


def _safe_log(path: Path, message: str) -> None:
    """ログ周りで失敗してもサービス自体は落とさない安全ログ関数。"""
    try:
        ts = datetime.datetime.now().isoformat(timespec="seconds")
        with path.open("a", encoding="utf-8") as f:
            f.write(f"[{ts}] {message}\n")
    except Exception:
        # ここで例外を握りつぶすことで、本体ロジックに絶対に波及させない
        pass


# ===== 初期化フック =====

def init_engine() -> None:
    """
    本番ではモデルや外部 API を初期化するためのフック。
    今はログに一行書くだけの no-op。
    """
    _safe_log(CONVERT_LOG, "init_engine called (stub)")


# ===== なんちゃって変換ロジック =====

def convert_lyrics(lyrics: str) -> List[Dict[str, str]]:
    """
    歌詞テキストを行ごとに EN / KA ペアにする超ダミー変換。
    - 空行はスキップ
    - 連続スペースは 1 個にまとめる
    - KA 側は小文字＋スペース整形しただけ
    """
    lines: List[Dict[str, str]] = []

    for raw in lyrics.splitlines():
        text = raw.strip()
        if not text:
            continue

        # なんちゃって変換：スペース整形＋小文字化
        kana = " ".join(text.split()).lower()

        lines.append({"en": text, "kana": kana})

    _safe_log(CONVERT_LOG, f"convert_lyrics: lines={len(lines)}")
    return lines


# ===== フィードバック保存 =====

def save_feedback(text: str) -> None:
    """
    ユーザーからのフィードバックをログに残すだけのスタブ。
    """
    snippet = text.replace("\n", " ")
    if len(snippet) > 120:
        snippet = snippet[:120] + "…"

    _safe_log(FEEDBACK_LOG, f"feedback: {snippet}")
