<!doctype html>
<html lang="ja">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WV3GHF7D');</script>
  <!-- End Google Tag Manager -->
  <!-- =========================================================
  0) Basics
  ========================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>SingKANA | 歌詞を歌いやすい読みへ変換（ローマ字・カタカナ）</title>
  <meta name="description" content="歌詞テキストを、歌いやすい読み（ローマ字/カタカナ）と区切りに整形。ブレスは無音検出による目安を表示。※現段階では音源同期/BPM解析は未対応。" />
  
  <!-- (任意) canonical / OG / twitter は本番で追加推奨 -->
  <!-- <link rel="canonical" href="https://singkana.com/" /> -->


  <!-- =========================================================
  SEO / AEO Boost (Canonical, OpenGraph, Twitter, Robots, Hreflang)
  ========================================================== -->
  <link rel="canonical" href="https://singkana.com/" />

  <!-- 基本 -->
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="application-name" content="SingKANA" />

  <!-- Favicon (iOS Safari対策: フル指定 + キャッシュ分離 ?v=3) -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="shortcut icon" href="/assets/favicon/favicon.ico?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16.png?v=3">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch.png?v=3">

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="SingKANA" />
  <meta property="og:title" content="SingKANA | 歌詞を歌いやすい読みへ変換（ローマ字・カタカナ）" />
  <meta property="og:description" content="歌詞テキストを、歌いやすい読み（ローマ字/カタカナ）と区切りに整形。ブレスは無音検出による目安を表示。※現段階では音源同期/BPM解析は未対応。" />
  <meta property="og:url" content="https://singkana.com/" />
  <meta property="og:image" content="https://singkana.com/ogp.png?v=jp-c9c8c34" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="ja_JP" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="SingKANA | 歌詞を歌いやすい読みへ変換（ローマ字・カタカナ）" />
  <meta name="twitter:description" content="歌詞テキストを、歌いやすい読み（ローマ字/カタカナ）と区切りに整形。ブレスは無音検出による目安を表示。※現段階では音源同期/BPM解析は未対応。" />
  <meta name="twitter:image" content="https://singkana.com/ogp.png?v=jp-c9c8c34" />
  <meta name="twitter:site" content="@SingKANA_ai" />

  <!-- 言語（将来 en ページができたら追加） -->
  <link rel="alternate" href="https://singkana.com/" hreflang="ja" />
  <link rel="alternate" href="https://en.singkana.com/" hreflang="en" />
  <link rel="alternate" href="https://singkana.com/" hreflang="x-default" />

  <!-- =========================================================
  2) Theme / CSS (first: your theme switch, then Tailwind, then custom)
  ========================================================== -->
  <link rel="stylesheet" href="/assets/themes/theme.switch.css" />
  <script defer src="/assets/js/theme_manager.js"></script>

  <link rel="stylesheet" href="/assets/app.css?v=20260216" />

  <!-- Studio CSS -->
  <style>
    /* 横はみ出し対策（装飾のabsolute要素など） */
    html, body { overflow-x: hidden; }

    /* Hero demo: make it feel “interactive” */
    .hero-demo-wave span{
      display: block;
      width: 3px;
      border-radius: 999px;
      background: rgba(138, 93, 255, 0.75);
      opacity: 0.9;
      animation: heroWave 1.6s ease-in-out infinite;
      transform-origin: bottom;
    }
    .hero-demo-wave span:nth-child(2){ animation-delay: .12s; opacity: .75; }
    .hero-demo-wave span:nth-child(3){ animation-delay: .24s; opacity: .85; }
    .hero-demo-wave span:nth-child(4){ animation-delay: .36s; opacity: .65; }
    .hero-demo-wave span:nth-child(5){ animation-delay: .48s; opacity: .9; }
    .hero-demo-wave span:nth-child(6){ animation-delay: .60s; opacity: .7; }
    .hero-demo-wave span:nth-child(7){ animation-delay: .72s; opacity: .85; }
    .hero-demo-wave span:nth-child(8){ animation-delay: .84s; opacity: .6; }
    .hero-demo-wave span:nth-child(9){ animation-delay: .96s; opacity: .8; }
    .hero-demo-wave span:nth-child(10){ animation-delay: 1.08s; opacity: .7; }
    @keyframes heroWave{
      0%,100%{ transform: scaleY(0.35); }
      50%{ transform: scaleY(1); }
    }

    .hero-demo-caret{
      display: inline-block;
      width: 6px;
      height: 12px;
      border-radius: 999px;
      background: rgba(110, 231, 183, 0.9);
      box-shadow: 0 0 18px rgba(110,231,183,0.45);
      vertical-align: -2px;
      animation: heroCaret 1.2s ease-in-out infinite;
    }
    @keyframes heroCaret{
      0%,100%{ opacity: .25; }
      50%{ opacity: 1; }
    }

    /* スマホ専用レイアウト最適化 */
    @media (max-width: 767px) {
      /* Hero: 1画面完結 */
      #hero {
        /* 以前は縦中央寄せで“上の空白”が出やすかったので、上寄せにする */
        min-height: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 0.75rem;
      }
      
      /* カードUI: padding削減（Studio配下のみ） */
      #studio .rounded-2xl,
      #studio .rounded-3xl {
        padding: 0.75rem !important;
      }

      /* 結果エリア: 未変換時は高さ制限（JSで is-placeholder を付与） */
      #studio #result-panel.is-placeholder {
        min-height: auto !important;
        max-height: 4rem;
        padding: 0.5rem;
      }
      
      /* フッター直前: 余白削減 */
      #cta-bottom {
        padding-top: 1rem !important;
        margin-bottom: 0.5rem;
      }
    }
    
    .error-banner {
      display: none;
      background: #ffe5e8;
      color: #a4001d;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .tab-btn {
      flex: 1;
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid transparent;
      color: #e5e7eb;
      background: transparent;
      transition: all 0.15s ease;
    }
    .tab-btn.active {
      background: rgba(148, 163, 255, 0.18);
      border-color: rgba(165, 180, 252, 0.6);
      color: #e0f2fe;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
    }

    .result-panel {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 10px;
      max-height: 320px;
      overflow: auto;
      font-size: 13px;
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.18), rgba(15, 23, 42, 0.95));
    }

    .result-block {
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }
    .result-block:hover {
      background: rgba(30, 64, 175, 0.3);
      border-color: rgba(129, 140, 248, 0.6);
    }
    .result-block.active {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(196, 181, 253, 0.95);
      box-shadow: 0 0 0 1px rgba(196, 181, 253, 0.75);
    }
    .line-head {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .result-en {
      font-size: 13px;
      color: #e5e7eb;
      white-space: pre-wrap;
    }
    .result-ka {
      font-size: 12px;
      color: #e9d5ff;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
      margin-top: 4px;
    }
    .result-ka .mk { font-weight: 700; }
    .result-ka .mk-breath { color: #cbd5f5; opacity: 0.9; }
    .result-ka .mk-up { color: #fde68a; }
    .result-ka .mk-down { color: #e2e8f0; opacity: 0.85; }
    .result-ka .mk-liaison { color: #cbd5f5; padding: 0 0.15em; }
    .result-ka .mk-eli { opacity: 0.75; }
    .result-ka .mk-paren { opacity: 0.6; }
    .result-ka .mk-gap { display: inline-block; width: 0.25em; }
    .feedback-status {
      font-size: 11px;
      margin-top: 4px;
    }

    .mini-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.35);
      color: #e5e7eb;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .mini-btn:hover { background: rgba(148,163,255,0.15); border-color: rgba(165,180,252,0.7); }
    .mini-select {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(2, 6, 23, 0.35);
      color: #e5e7eb;
      outline: none;
    }
    .mini-hint {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }

    /* details/summary（上級例文）のマーカーを消す（スコープ限定・グローバル汚染ゼロ） */
    details.advanced-examples > summary { list-style: none; cursor: pointer; -webkit-user-select: none; user-select: none; }
    details.advanced-examples > summary::-webkit-details-marker { display: none; }
    details.advanced-examples .mini-hint { opacity: 0.85; }

    /* ===== Glass Visual ===== */
    .hero-visual{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:600px;
      padding-top: 6px;
      padding-bottom: 24px;
    }

    .glass-wrap{
      position:relative;
      width: min(640px, 92vw);
      aspect-ratio: 640 / 600;
      height: auto;
      max-height: 600px;
      perspective: 900px;
      user-select: none;
      cursor: pointer;
      touch-action: manipulation;
    }

    .glass-float{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      animation: floaty 7.2s ease-in-out infinite;
      will-change: transform;
    }

    .flip-card{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      transform: translate3d(var(--glass-move-x, 0px), var(--glass-move-y, 0px), 0px)
        rotateX(var(--glass-tilt-x, 0deg)) rotateY(var(--glass-tilt-y, 0deg));
      backface-visibility: hidden;
      will-change: transform;
    }

    .flip-inner{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      transition: transform .85s cubic-bezier(.2,.85,.25,1);
      will-change: transform;
    }

    .flip-face{
      position:absolute;
      inset:0;
      backface-visibility: hidden;
    }

    .flip-back{
      transform: rotateY(180deg);
    }

    /* ===== Flip behavior ===== */
    /* PC: 3D flip is allowed only when .is-flipped is set */
    .flip-card.is-flipped .flip-inner{
      transform: rotateY(180deg);
    }

    /* タッチ端末では tilt/move を固定（=変な角度にならない） */
    @media (hover: none), (pointer: coarse){
      .flip-card{
        transform: none !important;
      }
      .glass-float{
        animation: none;
      }
    }

    /* Mobile: disable 3D transforms; swap faces by display */
    @media (max-width: 768px){
      .flip-inner{
        transform: none !important;
        transition: none !important;
      }

      .flip-face{ display: none; }
      .flip-card .flip-front{ display: block; }
      .flip-card.is-flipped .flip-front{ display: none; }
      .flip-card.is-flipped .flip-back{ display: block; }

      /* iOSの描画安定化（保険） */
      .flip-face{ backface-visibility: visible; }
      .flip-back{ transform: none !important; }
    }

    .glass-card{
      position:absolute;
      inset:0;
      border-radius: 24px;
      background:
        radial-gradient(120% 140% at 20% 10%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%),
        radial-gradient(140% 120% at 80% 90%, rgba(186,104,255,.14), rgba(255,255,255,0) 55%),
        rgba(20,22,35,.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        0 20px 60px rgba(0,0,0,.45),
        0 0 0 1px rgba(186,104,255,.08) inset;
      overflow:hidden;
      transform-style:preserve-3d;
      backface-visibility: hidden;
    }

    .glass-card::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 26px;
      background: conic-gradient(
        from 180deg,
        rgba(186,104,255,.0),
        rgba(186,104,255,.35),
        rgba(92,180,255,.22),
        rgba(255,190,92,.18),
        rgba(186,104,255,.35),
        rgba(186,104,255,.0)
      );
      filter: blur(10px);
      opacity:.55;
      transform: translateZ(-1px);
      pointer-events:none;
    }

    .glass-sheen{
      position:absolute;
      inset:-40%;
      background: linear-gradient(120deg,
        rgba(255,255,255,0) 40%,
        rgba(255,255,255,.22) 50%,
        rgba(255,255,255,0) 60%
      );
      transform: translateX(-32%) rotate(12deg);
      animation: sheen 7.5s ease-in-out infinite;
      mix-blend-mode: screen;
      z-index: 2;
      pointer-events:none;
    }

    .glass-noise{
      position:absolute; inset:0;
      opacity:.12;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size:260px 260px;
      mix-blend-mode: overlay;
      pointer-events:none;
      z-index: 1;
    }

    .glass-ui{
      position:absolute;
      inset:0;
      padding: 26px 28px;
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      gap:10px;
      color: rgba(255,255,255,.92);
      z-index: 3;
      transform: translateZ(20px);
      transform-origin: center;
      backface-visibility: hidden;
      text-rendering: geometricPrecision;
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: 0.01em;
    }

    /* ===== HERO Live Mock Density Tuning ===== */
    .glass-wrap::before{
      content:"";
      position:absolute;
      inset: 1px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      pointer-events:none;
      z-index: 1;
    }

    .glass-wrap .hero-demo-header{
      margin-bottom: 10px !important;
    }
    .glass-wrap .hero-demo-kicker{
      opacity: .65;
    }
    .glass-wrap .hero-demo-title{
      font-size: 14px !important;
      letter-spacing: .02em;
    }
    .glass-wrap .hero-demo-badges{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 6px !important;
    }
    .glass-wrap .hero-demo-badges-row{
      display:flex;
      align-items:center;
      gap: 8px !important;
    }
    .glass-wrap .hero-demo-tags{
      gap: 8px !important;
      transform: scale(.96);
      transform-origin: left top;
      opacity: .9;
      width: 100%;
      justify-content: space-between;
    }
    .glass-wrap .hero-demo-tags-left{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .glass-wrap .hero-demo-tags-right{
      margin-left: auto;
      display:flex;
      align-items:center;
    }

    .glass-wrap .hero-demo-label{
      font-size: 10px !important;
      opacity: .65;
      margin-bottom: 6px !important;
    }

    .glass-wrap .hero-demo-lyrics,
    .glass-wrap .hero-demo-output{
      padding: 12px 12px !important;
      border-radius: 16px !important;
      margin-bottom: 10px !important;
    }

    .glass-wrap .hero-demo-output .hero-demo-mode{
      font-size: 10px !important;
      opacity: .8;
    }
    .glass-wrap .hero-demo-output .hero-demo-kana{
      font-size: 15px !important;
      line-height: 1.35 !important;
      letter-spacing: .03em;
    }

    .glass-wrap .hero-demo-bottom{
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 10px !important;
    }
    .glass-wrap .hero-demo-panel{
      padding: 10px 10px !important;
      border-radius: 16px !important;
      min-height: 96px !important;
      opacity: .88;
    }
    .glass-wrap .hero-demo-panel .hero-demo-label{
      font-size: 10px !important;
      opacity: .7;
      margin-bottom: 6px !important;
    }
    .glass-wrap .hero-demo-btn{
      padding: 7px 10px !important;
      border-radius: 999px !important;
      font-size: 10px !important;
    }
    .glass-wrap .hero-demo-wave{
      transform: scale(.92);
      transform-origin: right center;
      opacity: .85;
    }
    .glass-wrap .hero-demo-meter{
      opacity: .8;
      transform: scale(.88);
      transform-origin: right center;
      margin-right: 2px;
    }
    .glass-wrap .hero-demo-meter span{
      background: rgba(110,231,183,0.9);
      box-shadow: 0 0 10px rgba(110,231,183,0.35);
    }

    /* ホバーで裏返さない（裏面が空で消える事故防止） */
    /* 反転はクリック/タップでの明示操作のみ */


    @keyframes floaty{
      0%,100% { transform: translateY(0px); }
      50%     { transform: translateY(-8px); }
    }

    @keyframes sheen{
      0%,100% { transform: translateX(-32%) rotate(12deg); opacity:.55; }
      50%     { transform: translateX(32%) rotate(12deg);  opacity:.82; }
    }

    @media (max-width: 1024px){
      .hero-visual{ min-height: 520px; }
      .glass-wrap{ width: min(560px, 92vw); }
      .glass-ui{ transform: translateZ(20px); padding: 18px 16px; }
    }

    @media (max-width: 768px){
      .hero-visual{ min-height: 360px; }
      .glass-wrap{ width: min(360px, 92vw); max-height: none; }
      .glass-ui{ transform: translateZ(20px); padding: 18px 16px; }
    }

    @media (max-width: 900px){
      .glass-wrap{
        width: min(520px, 92vw);
      }
      .glass-ui{
        padding: 18px 16px;
      }
    }

    @media (min-width: 1024px){
      .hero-right{ margin-left: -40px; }
      .hero-left{ max-width: 560px; }
    }

    @media (prefers-reduced-motion: reduce){
      .glass-float, .glass-sheen{ animation:none !important; }
    }
  </style>

  <!-- =========================================================
  Structured Data (JSON-LD) for SEO/AEO
  ========================================================== -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebSite",
        "@id": "https://singkana.com/#website",
        "url": "https://singkana.com/",
        "name": "SingKANA",
        "description": "英語歌詞を“歌えるかな表記”に変換するAIスタジオ。発音ガイド、ブレス位置、ロングトーン、ニュアンスまで可視化。",
        "inLanguage": "ja"
      },
      {
        "@type": "SoftwareApplication",
        "@id": "https://singkana.com/#app",
        "name": "SingKANA",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Web",
        "url": "https://singkana.com/",
        "description": "英語歌詞を“歌えるかな表記”に変換。発音ガイド/ブレス/ロングトーンまで可視化して練習と収録を効率化。",
        "offers": [
          {
            "@type": "Offer",
            "name": "Free (Basic)",
            "price": "0",
            "priceCurrency": "JPY",
            "availability": "https://schema.org/InStock",
            "url": "https://singkana.com/#pricing"
          },
          {
            "@type": "Offer",
            "name": "Pro",
            "price": "980",
            "priceCurrency": "JPY",
            "availability": "https://schema.org/InStock",
            "url": "https://singkana.com/#pricing"
          }
        ]
      },
      {
        "@type": "FAQPage",
        "@id": "https://singkana.com/#faq",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "著作権は大丈夫ですか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "SingKANAは歌詞テキストの“かな変換”を行うツールです。歌詞そのものの権利は権利者に帰属します。利用規約と法令の範囲で、個人の練習用途を想定してご利用ください。"
            }
          },
          {
            "@type": "Question",
            "name": "スマホだけでも使えますか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "はい。ブラウザで利用できます。推奨は最新版のChrome / Safari / Edgeです。"
            }
          },
          {
            "@type": "Question",
            "name": "フィードバック送信はどこに届きますか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "フィードバックは開発チームに直接届きます（Discord連携）。改善に活用させていただきます。"
            }
          }
        ]
      }
    ]
  }
  </script>


</head>

<body data-theme="dark" class="bg-slate-950 text-slate-100 antialiased overflow-x-hidden">
  
  <div class="sk-disclaimer" style="font-size:12px;opacity:.85;margin:10px 0;">※現段階では音源同期/BPM解析は未対応（テキスト入力ベース）。</div>
<!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WV3GHF7D"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- 背景 -->
  <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 h-80 w-80 rounded-full bg-singkana-500/40 blur-3xl"></div>
    <div class="absolute top-40 -left-40 h-96 w-96 rounded-full bg-fuchsia-500/30 blur-3xl"></div>
    <div class="absolute bottom-[-10rem] right-[-5rem] h-80 w-80 rounded-full bg-cyan-400/20 blur-3xl"></div>
  </div>

  <!-- ヘッダ -->
  <header class="border-b border-white/5 bg-slate-950/70 backdrop-blur-sm sticky top-0 z-30">
    <div class="mx-auto max-w-7xl 2xl:max-w-[1440px] px-4 py-3 md:py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img
          src="/assets/favicon/favicon-32.png"
          alt="SingKANA"
          class="h-7 w-7 rounded-xl"
        />
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-lg font-semibold tracking-wide">SingKANA</span>
            <!-- 開発者モードバッジ（条件付き表示） -->
            <span id="dev-pro-badge" class="hidden rounded-full border border-amber-400/50 bg-amber-500/20 px-2 py-0.5 text-[9px] font-medium text-amber-200 uppercase tracking-[0.1em]">
            </span>
          </div>
          <p class="text-xs text-slate-400">歌詞かな変換 AI スタジオ</p>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-7 text-sm text-slate-200">
        <a href="#about" class="hover:text-singkana-200 transition">SingKANAとは</a>
        <a href="#features" class="hover:text-singkana-200 transition">機能</a>
        <a href="/guide/features.html" class="hover:text-singkana-200 transition">機能ガイド</a>
        <a href="#how-it-works" class="hover:text-singkana-200 transition">使い方</a>
        <a href="#pricing" class="hover:text-singkana-200 transition">料金</a>
        <a href="#faq" class="hover:text-singkana-200 transition">FAQ</a>
        <a href="https://en.singkana.com" target="_blank" rel="noopener" class="hover:text-singkana-200 transition border-l border-white/10 pl-4 ml-2">
          English Version
        </a>
        <a href="#studio" class="rounded-full border border-singkana-400/70 bg-slate-950/80 px-4 py-1.5 text-xs font-semibold text-singkana-100 shadow-soft hover:bg-singkana-500/10 hover:shadow-glow transition">
          かな変換を試す
        </a>
      </nav>
    </div>
  </header>

  <!-- =========================================================
  MAIN
  （導線の鉄則：Hero → 問題 → About → 機能 → 使い方 → 体験（Studio） → 価格 → FAQ → CTA）
  ========================================================== -->
  <main class="mx-auto max-w-7xl 2xl:max-w-[1440px] px-4 pb-24 pt-6 md:pt-8 space-y-28">

    <!-- HERO -->
    <section id="hero" class="grid gap-8 md:gap-10 lg:gap-14 lg:grid-cols-2 lg:items-center">
      <div class="space-y-4 md:space-y-6 hero-left">
        <!-- スマホ: 最小限の情報のみ表示 -->
        <div class="md:hidden space-y-4">
          <h1 class="text-2xl font-semibold leading-tight text-slate-50">
            英語の歌詞を、歌いやすい「かな発音」に変換するAI<br />
            <span class="bg-gradient-to-r from-singkana-200 via-fuchsia-200 to-cyan-200 bg-clip-text text-transparent">
              ― SingKANA
            </span>
          </h1>
          
          <div class="flex flex-col gap-2">
            <a href="#studio"
              class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-3 text-base font-semibold text-white shadow-glow hover:brightness-110 transition">
              無料でかな変換を試す
              <span class="text-sm">▶</span>
            </a>
          </div>
        </div>

        <!-- PC: 詳細情報を表示 -->
        <div class="hidden md:block space-y-6">
          <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 shadow-soft backdrop-blur-xs">
            <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
            好きな曲を「読めない」から一瞬で「歌える」に。
          </div>

          <div class="space-y-4">
            <h1 class="text-4xl lg:text-5xl font-semibold leading-tight text-slate-50">
              英語の歌詞を、歌いやすい「かな発音」に変換するAI<br />
              <span class="bg-gradient-to-r from-singkana-200 via-fuchsia-200 to-cyan-200 bg-clip-text text-transparent">
                ― SingKANA（シンカナ）
              </span>
            </h1>

          <!-- サブヘッド（H2相当・人間向け） -->
          <h2 class="text-xl md:text-2xl font-medium text-slate-200 leading-relaxed">
            聞こえたまま、口が動く。<br />
            ネイティブの発音を"歌える日本語"に。
          </h2>

          <!-- 説明文（リード文｜SEO本文に食い込ませる） -->
          <div class="space-y-3 text-sm md:text-base text-slate-300 leading-relaxed">
            <p>
              SingKANA（シンカナ）は、<strong class="text-singkana-100">英語の歌詞を、日本人が実際に歌いやすい「かな発音」に変換するAIサービス</strong>です。
            </p>
            <p>
              学校英語のカタカナ発音ではなく、<strong class="text-singkana-100">音のつながり・脱落・強弱を考慮した"歌唱専用"の発音表記</strong>を生成。
            </p>
            <p>
              英語の歌を歌いたい人、「歌ってみた」動画を作る人、正確な発音で表現力を高めたいシンガーのために設計されています。
            </p>
          </div>
        </div>

        <!-- 機能要約（AI・検索エンジンが拾いやすい構造） -->
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400 mb-2">主な機能</p>
          <ul class="space-y-1.5 text-sm text-slate-300">
            <li class="flex items-start gap-2">
              <span class="text-singkana-400 mt-0.5">•</span>
              <span>英語歌詞を <strong class="text-singkana-100">歌唱向けかな発音</strong> に自動変換</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-singkana-400 mt-0.5">•</span>
              <span>ネイティブ発音を意識した <strong class="text-singkana-100">音変化・リエゾン対応</strong></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-singkana-400 mt-0.5">•</span>
              <span>ブラウザ完結・インストール不要</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-singkana-400 mt-0.5">•</span>
              <span>無料で試せる / 詳細表示・PDF出力・比較モードはPro対応</span>
            </li>
          </ul>
        </div>

        <!-- 権威性・独自性（SAO対策で重要） -->
        <div class="rounded-2xl border border-singkana-400/30 bg-slate-900/50 p-4">
          <p class="text-sm font-semibold text-singkana-100 mb-1">SingKANAは「翻訳ツール」ではありません。</p>
          <p class="text-xs text-slate-300">歌うために設計された、発音特化AIです。</p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
            <span class="font-semibold text-singkana-100">“歌えるかな表記”</span>
          <a href="#studio"
            class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition">
            無料でかな変換を試す
            <span class="text-xs">▶</span>
          </a>
        </div>

        <p class="text-[11px] text-slate-400">
          ブラウザだけで完結 / PC・スマホ対応 / FreeはBasic固定・Proは歌いやすさ最適化
        </p>
      </div>
    </div>

      <!-- Demo / Visual（PCで右側を“体験”で埋める） -->
      <div class="relative w-full max-w-xl lg:max-w-none lg:w-[640px] lg:justify-self-end hero-right">
        <div class="absolute -top-6 -left-4 h-20 w-20 rounded-full border border-slate-500/30 bg-gradient-to-br from-slate-900/10 via-slate-900/40 to-slate-900/80 blur-2xl"></div>
        <div class="absolute -bottom-10 -right-6 h-28 w-28 rounded-full bg-gradient-to-tr from-fuchsia-500/30 via-singkana-400/20 to-cyan-300/20 blur-3xl"></div>

        <!-- Right Visual (Glass) -->
        <div class="hero-visual">
          <div class="glass-wrap" id="glassWrap" aria-hidden="true">
            <div class="glass-float">
              <div class="flip-card" id="glassCard">
                <div class="flip-inner">
                  <div class="flip-face flip-front">
                    <div class="glass-card">
                      <div class="glass-sheen"></div>
                      <div class="glass-noise"></div>
                      <div class="glass-ui">
                        <div class="flex items-center justify-between mb-3 hero-demo-header">
                          <div class="space-y-0.5">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-300/80 hero-demo-kicker">Before</p>
                            <p class="text-sm font-semibold hero-demo-title">Original Lyrics</p>
                          </div>
                          <div class="hero-demo-badges">
                            <div class="hero-demo-badges-row">
                              <span class="inline-flex items-center rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                                EN Text
                              </span>
                              <span class="hidden sm:inline-flex items-center rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                                Readable
                              </span>
                            </div>
                          </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mb-2 hero-demo-tags">
                          <div class="hero-demo-tags-left">
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                              意味は分かる
                            </span>
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                              でも歌えない
                            </span>
                          </div>
                        </div>

                        <div class="grid gap-3 text-[11px]">
                          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-3 hero-demo-lyrics">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5 hero-demo-label">Original Lyrics</p>
                            <p class="text-slate-200 leading-relaxed">
                              Put your <span class="underline decoration-dotted">heart</span> on the line, we’ll be <span class="underline decoration-dotted">flying</span> tonight...
                            </p>
                          </div>

                          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-3 hero-demo-panel">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5 hero-demo-label">Problem</p>
                            <p class="text-slate-200 leading-relaxed">
                              読めるけど、歌うと詰まる
                            </p>
                            <div class="mt-2 flex flex-wrap gap-1.5">
                              <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">発音</span>
                              <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">リズム</span>
                            </div>
                          </div>

                          <p class="text-[10px] text-slate-400">
                            ※ 同じ歌詞でも「歌える形」に落ちない
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="flip-face flip-back">
                    <div class="glass-card">
                      <div class="glass-sheen"></div>
                      <div class="glass-noise"></div>
                      <div class="glass-ui">
                        <div class="flex items-center justify-between mb-3 hero-demo-header">
                          <div class="space-y-0.5">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-300/80 hero-demo-kicker">After</p>
                            <p class="text-sm font-semibold hero-demo-title">SingKANA Studio</p>
                          </div>
                          <div class="hero-demo-badges">
                            <div class="hero-demo-badges-row">
                              <span class="inline-flex items-center gap-1.5 rounded-full border border-emerald-400/30 bg-emerald-500/10 px-2 py-1 text-[10px] text-emerald-200">
                                <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                                Online
                              </span>
                              <span class="hidden sm:inline-flex items-center rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                                No install
                              </span>
                            </div>
                          </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mb-2 hero-demo-tags">
                          <div class="hero-demo-tags-left">
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                              <span class="hero-demo-caret"></span>
                              行タップでハイライト
                            </span>
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                              <span class="h-1.5 w-1.5 rounded-full bg-singkana-300"></span>
                              BR / HLD / VIB
                            </span>
                            <span class="hidden sm:inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-slate-950/40 px-2 py-1 text-[10px] text-slate-300">
                              出力：Free=Basic / Pro=Natural（自動最適化）
                            </span>
                          </div>
                          <div class="hero-demo-tags-right">
                            <div class="hero-demo-meter hero-demo-wave flex items-end gap-1 h-3" aria-hidden="true">
                              <span style="height:4px"></span>
                              <span style="height:7px"></span>
                              <span style="height:5px"></span>
                              <span style="height:9px"></span>
                              <span style="height:6px"></span>
                              <span style="height:10px"></span>
                              <span style="height:5px"></span>
                              <span style="height:8px"></span>
                            </div>
                          </div>
                        </div>

                        <div class="grid gap-3 text-[11px]">
                          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-3 hero-demo-lyrics">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5 hero-demo-label">Original Lyrics</p>
                            <p class="text-slate-200">
                              Put your <span class="underline decoration-dotted">heart</span> on the line, we’ll be <span class="underline decoration-dotted">flying</span> tonight...
                            </p>
                          </div>

                          <div class="rounded-2xl border border-singkana-400/40 bg-gradient-to-br from-slate-900/90 via-slate-900/70 to-slate-900/90 p-3 shadow-glow hero-demo-output">
                            <p class="text-[10px] uppercase tracking-[0.16em] text-slate-300 mb-1.5 hero-demo-label">SingKANA Output</p>
                            <div class="grid grid-cols-[1fr_auto] gap-2 items-start">
                              <p class="font-medium text-slate-100 leading-relaxed hero-demo-kana">
                                <span class="inline-flex items-center gap-2 rounded-lg bg-singkana-500/15 border border-singkana-400/30 px-2 py-1 hero-demo-mode">
                                  <span class="text-[10px] uppercase tracking-[0.16em] text-singkana-200">Natural</span>
                                </span>
                                <br />
                                プッ ユア <span class="text-singkana-200">ハート</span> オン ザ ライン<br />
                                ウィー ビー <span class="text-singkana-200">フライイン</span> トゥナイッ
                              </p>
                              <div class="hidden sm:flex flex-col items-end gap-1">
                                <div class="hero-demo-wave flex items-end gap-1 h-6">
                                  <span style="height:6px"></span>
                                  <span style="height:12px"></span>
                                  <span style="height:8px"></span>
                                  <span style="height:16px"></span>
                                  <span style="height:10px"></span>
                                  <span style="height:18px"></span>
                                  <span style="height:9px"></span>
                                  <span style="height:14px"></span>
                                  <span style="height:7px"></span>
                                  <span style="height:12px"></span>
                                </div>
                                <p class="text-[10px] text-slate-400">voice guide</p>
                              </div>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-1.5">
                              <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">BR</span>
                              <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">HLD</span>
                              <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">VIB</span>
                              <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">SLD</span>
                            </div>
                          </div>

                          <div class="grid gap-3 sm:grid-cols-2 hero-demo-bottom">
                            <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-3 hero-demo-panel">
                              <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5 hero-demo-label">EN → かな</p>
                              <p class="text-slate-200 leading-relaxed">
                                プッ ユア ハート オン ザ ライン<br />
                                ウィー ビー フライイン トゥナイッ
                              </p>
                              <div class="mt-2 flex flex-wrap gap-1.5">
                                <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">歌唱向け</span>
                                <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">音変化</span>
                              </div>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-3 hero-demo-panel">
                              <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5 hero-demo-label">Export</p>
                              <p class="text-slate-200 leading-relaxed">
                                Copy / TXT / SRT（簡易）<br />
                                行タップでハイライト
                              </p>
                              <div class="mt-2 flex flex-wrap gap-1.5">
                                <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">1クリック</span>
                                <span class="rounded-full bg-slate-950/50 px-2 py-0.5 text-[9px] text-slate-200 border border-white/10 hero-demo-btn">台本化</span>
                              </div>
                            </div>
                          </div>

                          <p class="text-[10px] text-slate-400">
                            ※ 実際の変換結果は楽曲やモードによって異なります。
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 問題 -->
    <section id="problems" class="space-y-6">
      <h2 class="text-xl md:text-2xl font-semibold">
        歌いたい曲がある。<br class="hidden md:block" />
        でも「発音わからない」で止まってしまうあなたへ。
      </h2>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">英語歌詞のカタカナ起こしが地獄</p>
          <p class="text-xs text-slate-300">歌詞サイトを見ながら、一行ずつカタカナを書いていくだけで、練習前に疲れてしまう。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">発音・ブレス・ニュアンスが掴めない</p>
          <p class="text-xs text-slate-300">どこで息継ぎするか、どこを伸ばすか、どこを強く歌うかが分からず、不安なまま歌うことになる。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">歌ってみた制作の準備が面倒すぎる</p>
          <p class="text-xs text-slate-300">台本用に整理しているうちに録音時間がなくなる。本当は本番に時間を使いたい。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">「歌える日本語」に落ちてこない</p>
          <p class="text-xs text-slate-300">翻訳や普通の表記だとリズムが崩れる。耳では分かるのに口に乗らない。</p>
        </div>
      </div>
      <p class="text-sm text-slate-200">
        これ、全部 <span class="font-semibold text-singkana-100">SingKANA が代わりにやります。</span>
      </p>
    </section>

    <!-- About -->
    <section id="about" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">
        言語の壁を越えて歌える、<br class="hidden md:block" />
        “歌詞翻訳ではない” 新しい体験。
      </h2>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed">
        SingKANA は英語歌詞を日本語かなに変換するだけのツールではありません。<br />
        <span class="font-semibold text-singkana-100">声が自然に乗る「歌いやすさ」</span>を基準に、
        発音バランス / 音節の区切り / 歌い方のニュアンスを整える音楽特化AIです。
      </p>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed">
        目指すのは「読める」ではなく <span class="font-semibold text-singkana-100">“歌えるかな”</span>。
        直訳や普通のカタカナより、声に出したときの気持ちよさを優先します。
      </p>
    </section>

    <!-- Features -->
    <section id="features" class="space-y-6">
      <h2 class="text-xl md:text-2xl font-semibold">SingKANA の主な機能</h2>

      <div class="grid gap-5 md:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">01 / Kana Engine</p>
          <h3 class="text-sm font-semibold text-slate-50">歌いやすさ優先のかな変換エンジン</h3>
          <p class="text-xs text-slate-300 leading-relaxed">文章としての正しさより、歌ったときに読みと区切りが追いやすいことを重視。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">02 / Marking</p>
          <h3 class="text-sm font-semibold text-slate-50">カラオケ風 “歌い方マーク”</h3>
          <p class="text-xs text-slate-300 leading-relaxed">本文は読みやすく保ちつつ、下段チップでガイドを表示（段階適用）。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">03 / Web Studio</p>
          <h3 class="text-sm font-semibold text-slate-50">ブラウザだけで即利用</h3>
          <p class="text-xs text-slate-300 leading-relaxed">PC・スマホ対応。思い立った瞬間に変換して歌える。</p>
        </div>
      </div>
    </section>

    <!-- How -->
    <section id="how-it-works" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">使い方は、シンプルに 3 ステップ</h2>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 01</p>
          <h3 class="text-sm font-semibold text-slate-50">歌詞を用意</h3>
          <p class="text-xs text-slate-300">歌詞テキストをコピペ（ファイルUPは今後）。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 02</p>
          <h3 class="text-sm font-semibold text-slate-50">ワンクリックでかな変換</h3>
          <p class="text-xs text-slate-300">ボタンを押すだけ。数秒で“歌えるかな歌詞”が完成。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 03</p>
          <h3 class="text-sm font-semibold text-slate-50">そのまま練習 or 収録へ</h3>
          <p class="text-xs text-slate-300">コピー/TXT/SRTで台本としてすぐ使える。</p>
        </div>
      </div>
    </section>

    <!-- Pricing -->
    <section id="pricing" class="space-y-6">
      <div class="flex items-end justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl md:text-2xl font-semibold text-slate-50">料金プラン</h2>
          <p class="text-sm text-slate-300 mt-2">
            Free は <span class="font-semibold text-slate-100">Basic固定</span>。Pro は <span class="font-semibold text-singkana-100">Natural（歌いやすさ最適化）</span> が利用できます。
          </p>
        </div>

        <a href="#studio"
          class="rounded-full border border-white/15 bg-slate-950/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
          まず無料で試す（Basic）
        </a>
      </div>

      <div class="grid md:grid-cols-3 gap-4 items-stretch">
        <div class="md:h-full grid grid-cols-1 md:grid-rows-2 gap-4">
          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 shadow-soft h-full flex flex-col">
            <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Free</p>
            <p class="text-sm text-slate-300 mt-2">まずは体験したい方向け。</p>
            <div class="mt-4">
              <p class="text-2xl font-semibold text-slate-50">¥0</p>
              <p class="text-[11px] text-slate-400 mt-1">Basic 固定</p>
            </div>
            <ul class="mt-4 space-y-2 text-xs text-slate-200">
              <li>✅ Basic（直訳寄りで読みやすい）</li>
              <li>✅ PDF One-Shot（¥300/回）</li>
              <li>✅ 比較UIで歌いにくさを確認</li>
              <li class="text-slate-400">❌ 歌いやすさ最適化（Natural）はPro</li>
            </ul>
            <a href="#studio"
              class="mt-auto inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition">
              まず無料で試す
            </a>
          </div>

          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 shadow-soft h-full flex flex-col">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">One-Shot</p>
                <p class="text-sm text-slate-300 mt-2">まず1曲だけ試したい方向け（Freeユーザー向け）。</p>
              </div>
              <span class="rounded-full border border-white/15 bg-slate-100/10 px-2.5 py-1 text-[10px] font-semibold text-slate-200 whitespace-nowrap">PDF練習シート</span>
            </div>
            <div class="mt-4 rounded-xl border border-white/10 bg-slate-900/50 p-3">
              <p class="text-2xl font-semibold text-slate-50">¥300</p>
              <p class="text-[11px] text-slate-400 mt-0.5">1回限り・買い切り（サブスク不要）</p>
            </div>
            <ul class="mt-4 space-y-2 text-xs text-slate-200">
              <li>✅ 決済後すぐにPDFをダウンロード</li>
              <li>✅ QRコード付きで友達にもシェア可能</li>
              <li>✅ Stripe安全決済（カード情報は当社非保持）</li>
            </ul>
            <a href="#studio"
              class="mt-auto inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition">
              PDFを1回購入して試す（¥300）
            </a>
            <a href="/guide/features.html"
              class="mt-2 inline-flex w-full items-center justify-center rounded-xl bg-transparent px-4 py-2 text-xs font-semibold text-slate-200 border border-white/10 hover:bg-slate-100/10 transition">
              使い方とPDF見本を見る
            </a>
          </div>
        </div>

        <div class="rounded-2xl border border-singkana-400/30 bg-slate-950/60 p-5 shadow-glow h-full">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-singkana-100">Pro</p>
          <p class="text-sm text-slate-300 mt-2">本格的に歌える形に仕上げたい方向け。</p>
          <p id="pro-checkout-status" class="text-[10px] text-slate-400 mt-1"></p>

          <!-- 価格表示（月額/年額） -->
          <div class="mt-4 space-y-3">
            <div class="rounded-xl border border-singkana-400/20 bg-slate-900/50 p-3">
              <div class="flex items-baseline justify-between gap-2">
                <div>
                  <p class="text-2xl font-semibold text-slate-50">¥980</p>
                  <p class="text-[11px] text-slate-400 mt-0.5">月額 / 無制限変換</p>
                </div>
                <button
                  type="button"
                  onclick="startCheckout('pro_month')"
                  class="rounded-lg bg-singkana-500/90 px-3 py-1.5 text-[11px] font-semibold text-white border border-singkana-300/30 hover:bg-singkana-500 transition whitespace-nowrap">
                  選択
                </button>
              </div>
            </div>
            <div class="rounded-xl border border-emerald-400/30 bg-emerald-500/10 p-3 relative">
              <span class="absolute -top-2 left-3 rounded-full bg-emerald-500 px-2 py-0.5 text-[9px] font-semibold text-white">2か月分お得</span>
              <div class="flex items-baseline justify-between gap-2 mt-1">
                <div>
                  <p class="text-2xl font-semibold text-emerald-100">¥9,600</p>
                  <p class="text-[11px] text-emerald-300/80 mt-0.5">年額（月額換算¥800）</p>
                </div>
                <button
                  type="button"
                  onclick="startCheckout('pro_year')"
                  class="rounded-lg bg-emerald-500/90 px-3 py-1.5 text-[11px] font-semibold text-white border border-emerald-300/30 hover:bg-emerald-500 transition whitespace-nowrap">
                  選択
                </button>
              </div>
            </div>
          </div>

          <ul class="mt-4 space-y-2 text-xs text-slate-200">
            <li>✅ AI発音補正（GPTによる歌唱発音の自動補正）</li>
            <li>✅ 歌唱最適化（精密）モード</li>
            <li>✅ 無制限変換（回数制限なし）</li>
            <li>✅ One-Shot PDF（¥300買い切り）にも対応</li>
            <li>✅ Singability 表示</li>
            <li>✅ ブロック境界（息継ぎ位置）表示</li>
            <li>✅ 制作・録音用途に最適</li>
          </ul>

          <button
            id="pro-checkout-btn"
            type="button"
            onclick="startCheckout('pro_month')"
            class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-singkana-500/90 px-4 py-2 text-xs font-semibold text-white border border-singkana-300/30 hover:bg-singkana-500 transition">
            今すぐProで歌える
          </button>
          
          <p class="text-[10px] text-slate-400 mt-2 text-center">
            ✅ いつでも解約可能
          </p>

          <div id="pro-active-badge" class="hidden mt-5 w-full rounded-xl border-2 border-emerald-400/50 bg-emerald-500/20 px-4 py-3 text-xs font-semibold text-emerald-100 text-center shadow-glow">
            ✅ Pro 有効中
            <p class="text-[10px] text-emerald-300/80 mt-1 font-normal">いつでも解約可能</p>
          </div>

          <button
            id="billing-portal-btn"
            type="button"
            onclick="openBillingPortal()"
            class="hidden mt-3 inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition disabled:opacity-60 disabled:cursor-not-allowed">
            請求管理（解約・カード変更）
          </button>
          <p id="billing-portal-status" class="text-[10px] text-slate-400 mt-1"></p>

          <div class="mt-3 rounded-xl border border-white/10 bg-slate-900/40 p-3">
            <p class="text-[11px] font-semibold text-slate-100">別ブラウザへ引き継ぐ</p>

            <div id="transfer-issue-box" class="hidden mt-2">
              <button
                type="button"
                onclick="issueTransferCode()"
                class="inline-flex w-full items-center justify-center rounded-lg bg-slate-100/10 px-3 py-2 text-[11px] font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition disabled:opacity-60 disabled:cursor-not-allowed">
                引き継ぎコードを発行（10分・1回限り）
              </button>
              <p id="transfer-issue-status" class="text-[10px] text-slate-400 mt-1"></p>
              <p id="transfer-code-display" class="text-sm font-mono text-emerald-200 mt-1"></p>
            </div>

            <div class="mt-3">
              <label class="text-[10px] text-slate-400">引き継ぎコードを入力</label>
              <div class="mt-1 flex gap-2">
                <input id="transfer-code-input" type="text" inputmode="latin" placeholder="例: ABCD2345EF"
                  class="w-full rounded-lg bg-slate-950/60 border border-white/10 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-500" />
                <button type="button" onclick="claimTransferCode()"
                  class="rounded-lg bg-emerald-500/90 px-3 py-2 text-[11px] font-semibold text-white border border-emerald-300/30 hover:bg-emerald-500 transition whitespace-nowrap">
                  引き継ぐ
                </button>
              </div>
              <p id="transfer-claim-status" class="text-[10px] text-slate-400 mt-1"></p>
            </div>
          </div>

          <p class="text-[11px] text-slate-400 mt-2">
            ※ 決済後、自動でProが有効になります
          </p>
          
          <div id="pro-preorder-section" class="mt-4 pt-4 border-t border-singkana-400/20">
            <p class="text-[11px] font-semibold text-singkana-200 mb-1">
              🎁 協力テスター特典
            </p>
            <p class="text-[10px] text-slate-400 leading-relaxed">
              採用されたフィードバックで、期限付きのPro特典（14日）を付与します。
            </p>
            <p class="text-[10px] text-slate-500 mt-1">※ 特典は審査・条件達成後に付与されます（例：採用フィードバック3件）。</p>
            <a href="#"
              onclick="openWaitlistModal(); return false;"
              class="mt-3 inline-flex w-full items-center justify-center rounded-xl bg-singkana-500/20 px-4 py-2 text-xs font-semibold text-singkana-100 border border-singkana-400/40 hover:bg-singkana-500/25 transition">
              協力テスターに応募（Pro 14日）
            </a>
          </div>
        </div>

        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 shadow-soft h-full">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Studio / School</p>
          <p class="text-sm text-slate-300 mt-2">教室・スタジオ導入向け。</p>
          <ul class="mt-4 space-y-2 text-xs text-slate-200">
            <li>✅ 複数人運用</li>
            <li>✅ 管理・請求の一括化</li>
            <li>✅ カスタム要件相談</li>
          </ul>
          <a href="mailto:singkana.official@gmail.com"
            class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition">
            お問い合わせ
          </a>
        </div>
      </div>

      <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-5">
        <p class="text-sm font-semibold text-slate-50">Free と Pro の違い</p>
        <div class="mt-4 overflow-x-auto">
          <table class="min-w-[560px] w-full text-xs">
            <thead>
              <tr class="text-slate-400">
                <th class="text-left py-2 pr-3 font-semibold">項目</th>
                <th class="text-left py-2 pr-3 font-semibold">Free</th>
                <th class="text-left py-2 pr-3 font-semibold">Pro</th>
              </tr>
            </thead>
            <tbody class="text-slate-200">
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">価格</td><td class="py-2 pr-3">¥0</td><td class="py-2 pr-3">¥980/月</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">PDF練習シート（単品）</td><td class="py-2 pr-3">¥300/回（One-Shot）</td><td class="py-2 pr-3">利用可（＋Pro機能）</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">変換回数</td><td class="py-2 pr-3">制限なし</td><td class="py-2 pr-3">無制限</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">変換モード</td><td class="py-2 pr-3">Basic（固定）</td><td class="py-2 pr-3">Natural（固定・自動最適化）</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">AI発音補正</td><td class="py-2 pr-3">—</td><td class="py-2 pr-3">✅</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">難所の内部強化</td><td class="py-2 pr-3">—</td><td class="py-2 pr-3">✅（自動）</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">Singability</td><td class="py-2 pr-3">—</td><td class="py-2 pr-3">✅</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">録音・制作向け</td><td class="py-2 pr-3">△</td><td class="py-2 pr-3">◎</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">よくある質問</h2>
      <div class="space-y-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. 著作権は大丈夫ですか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            SingKANA は「歌詞テキストのかな変換」ツールです。歌詞そのものの権利は権利者に帰属します。利用規約と法令の範囲で使用してください。
          </p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. スマホだけでも使えますか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            はい。ブラウザで使えます。推奨は最新版の Chrome / Safari / Edge。
          </p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. フィードバック送信はどこに届きますか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            フィードバックは開発チームに直接届きます（Discord連携）。改善に活用させていただきます。
          </p>
        </div>
      </div>
    </section>

    <!-- Studio -->
    <section id="studio" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">かな変換スタジオ</h2>
      <p class="text-sm text-slate-300">
        下のスタジオで、実際に英語の歌詞を「歌えるかな」に変換してみてください。
      </p>

      <div class="mt-2 rounded-3xl border border-singkana-400/40 bg-slate-950/80 p-5 shadow-glow">
        <p class="text-sm text-slate-200 font-semibold mb-2">SingKANA</p>
        <p class="text-xs text-slate-400 mb-4">
          変換処理はお使いのブラウザ内のみで行われます（※現在の仕様）。
        </p>

        <div id="error-banner" class="error-banner"></div>

        <div class="grid gap-4 md:grid-cols-2">
          <!-- 左：入力 -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-4 space-y-3">
            <h3 class="text-sm font-semibold text-slate-50">歌詞入力</h3>

            <div class="space-y-1">
              <label for="song-title" class="block text-xs text-slate-200">1. 曲名（任意）</label>
              <input
                id="song-title"
                type="text"
                placeholder="例）golden"
                class="w-full rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80"
              />
            </div>

            <div class="space-y-1">
              <label for="lyrics-input" class="block text-xs text-slate-200">2. 歌詞を貼り付け</label>
              <textarea
                id="lyrics-input"
                placeholder="I was a ghost, I was alone, hah&#10;..."
                class="w-full min-h-[160px] rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80 font-mono leading-relaxed"
              ></textarea>
            </div>

            <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 space-y-2">
              <div class="text-[11px] font-semibold text-slate-100">用途プリセット（準備を最短化）</div>
              <div class="flex flex-col md:flex-row gap-2">
                <button type="button"
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-900/80 px-4 py-1.5 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                  onclick="applyUseCasePreset('utawaku')">
                  🎤 歌枠
                </button>
                <button type="button"
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-900/80 px-4 py-1.5 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                  onclick="applyUseCasePreset('cover')">
                  🎧 カバー制作
                </button>
              </div>
            </div>

            <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2">
              <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-2">
                <button type="button" class="mini-btn w-full md:w-auto" onclick="saveStudioState()">💾 保存</button>
                <button type="button" class="mini-btn w-full md:w-auto" onclick="restoreStudioState()">↩ 復元</button>
                <button type="button" class="mini-btn w-full md:w-auto" onclick="clearStudioState()">🧹 クリア</button>
              </div>

              <span class="hidden md:inline mx-1 h-4 w-px bg-white/15"></span>

              <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-2">
                <details class="advanced-examples w-full md:w-auto">
                  <summary class="advanced-examples__summary mini-btn w-full md:w-auto cursor-pointer select-none">🧪 上級例文（英語のつまずき）</summary>
                  <div class="mt-2 flex flex-col md:flex-row md:items-center gap-2 md:gap-2">
                    <label class="mini-hint hidden md:inline">例文：</label>
                    <button type="button" class="mini-btn w-full md:w-auto" onclick="insertExample('fast')" title="弱形・リダクション（gonna/wanna系）">⚡ 弱形</button>
                    <button type="button" class="mini-btn w-full md:w-auto" onclick="insertExample('consonant')" title="子音クラスタ（子音が連続するところ）">🔤 子音クラスタ</button>
                    <button type="button" class="mini-btn w-full md:w-auto" onclick="insertExample('vowel')" title="母音を伸ばす（ロングトーン）">🎵 母音伸ばし</button>
                  </div>
                  <p class="mini-hint mt-2">
                    ※ これは「設定」ではなく、つまずきやすい例文を挿入するショートカットです。
                  </p>
                </details>
              </div>

              <span class="hidden md:inline mx-1 h-4 w-px bg-white/15"></span>

              <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-2">
                <label class="mini-hint hidden md:inline">テンプレ：</label>
                <button type="button" class="mini-btn w-full md:w-auto" onclick="applyTemplate('chorus')" title="まずはこれ。サビ練習用の汎用テンプレを挿入します。">📌 サビ練習（汎用）</button>
                <select id="template-select" class="mini-select w-full md:w-auto" onchange="applyTemplateFromSelect(true)">
                  <option value="">選択…</option>
                  <option value="warmup">ウォームアップ（短文）</option>
                  <option value="chorus">サビ練習（汎用）</option>
                  <option value="speech">語尾・子音の練習</option>
                </select>
              </div>

              <!-- 右寄せは親が制御（ml-auto爆弾を避ける） -->
              <span class="hidden md:block flex-1"></span>
              <span id="studio-status" class="text-[11px] text-slate-400 md:text-right"></span>
            </div>

            <button
              class="primary-btn inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-5 py-2 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition"
              type="button"
              onclick="convertLyrics()"
            >
              <span class="icon text-xs">▶</span>
              <span>この歌詞で変換する</span>
            </button>

            <p class="text-[11px] text-slate-400 mt-3 leading-relaxed">
              基本変換は端末内のみで処理されます。Pro AI発音補正利用時のみサーバーへ送信されます。<br />
              商用楽曲の歌詞は著作権で保護されています。本サービスは<strong>個人の練習用途</strong>を想定しています。
            </p>
          </div>

          <!-- 右：結果 -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-4 space-y-3">
            <div class="flex gap-2 mb-1">
              <button class="tab-btn active" data-tab="result">変換結果</button>
              <button class="tab-btn" data-tab="feedback">フィードバック</button>
            </div>

            <div id="tab-result" class="tab-panel active space-y-2">
              <p class="text-[11px] text-slate-400">
                各行をタップすると、その行だけハイライトされ、音声読み上げでかなを再生します（対応ブラウザのみ）。
              </p>

              <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2">
                <div class="flex flex-col md:flex-row md:items-center gap-2">
                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-950/50 px-3 py-1 text-[10px] font-medium text-slate-300 border border-slate-700/70 hover:bg-slate-900/70 transition w-full md:w-auto"
                    onclick="copyKanaOnly()">📋 かなだけコピー</button>

                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-950/50 px-3 py-1 text-[10px] font-medium text-slate-300 border border-slate-700/70 hover:bg-slate-900/70 transition w-full md:w-auto"
                    onclick="copyEnKana()">📋 EN+かなコピー</button>

                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-950/50 px-3 py-1 text-[10px] font-medium text-slate-300 border border-slate-700/70 hover:bg-slate-900/70 transition w-full md:w-auto"
                    onclick="downloadTxt()">⬇ TXT</button>

                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-950/50 px-3 py-1 text-[10px] font-medium text-slate-300 border border-slate-700/70 hover:bg-slate-900/70 transition w-full md:w-auto"
                    onclick="downloadSrt()">⬇ SRT(簡易)</button>

                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-950/50 px-3 py-1 text-[10px] font-medium text-slate-300 border border-slate-700/70 hover:bg-slate-900/70 transition w-full md:w-auto"
                    onclick="downloadPdfSheet()">⬇ PDF</button>
                  <span class="text-[10px] text-slate-500 md:ml-1">補助出力（コピー/TXT/SRT/PDF）</span>
                </div>

                <div class="w-full md:w-auto rounded-lg border border-white/10 bg-slate-950/40 px-3 py-2 text-[10px] text-slate-300 leading-relaxed">
                  <div class="font-semibold text-slate-100">変換モードは自動最適化</div>
                  <div class="mt-1">Free: Basic（直訳寄り） / Pro: Natural（歌いやすさ優先）</div>
                  <div class="text-slate-400">難しい箇所は内部で強化処理されます（手動モード選択は廃止）。</div>
                </div>

                <span class="hidden md:inline mx-1 h-4 w-px bg-white/15"></span>

                <div class="flex flex-col md:flex-row md:items-center gap-2">
                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition w-full md:w-auto"
                    onclick="prevLine()">◀ 前</button>

                  <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition w-full md:w-auto"
                    onclick="nextLine()">次 ▶</button>

                  <label class="inline-flex items-center gap-2 text-[11px] text-slate-300 select-none w-full md:w-auto justify-center md:justify-start">
                    <input id="auto-scroll" type="checkbox" class="accent-indigo-400" checked />
                    自動追従
                  </label>
                </div>

                <!-- 右寄せは親が制御（ml-auto爆弾を避ける） -->
                <span class="hidden md:block flex-1"></span>
                <span id="export-status" class="text-[11px] text-slate-400 text-center md:text-right"></span>
              </div>

              <div id="result-panel" class="result-panel" style="min-height: auto;">
                <p style="font-size:12px;color:#cbd5f5;margin:0;">
                  歌詞を入力して「この歌詞で変換する」を押すと、ここに結果が表示されます。
                </p>
              </div>

              <div id="next-action-bar" class="rounded-2xl border border-singkana-400/35 bg-gradient-to-r from-singkana-500/10 to-fuchsia-500/10 p-3">
                <div class="text-[12px] font-semibold text-singkana-100">次のアクション</div>
                <div class="text-[11px] text-slate-300 mt-0.5">歌枠の準備を一気に終わらせる</div>
                <div class="mt-2 flex flex-col md:flex-row gap-2">
                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-4 py-2 text-[12px] font-semibold text-white shadow-glow hover:brightness-110 transition w-full md:w-auto"
                    onclick="primaryCtaPdf()">
                    📄 PDF練習シートを作る
                  </button>
                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-xl border border-white/20 bg-slate-900/80 px-4 py-2 text-[12px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                    onclick="primaryCtaSheet()">
                    🗂 Sheetを開く / 共有する
                  </button>
                </div>
              </div>

              <!-- Coach V0 panel (Pro) -->
              <div id="coach-panel" class="mt-3 rounded-2xl border border-white/10 bg-slate-950/40 p-3 space-y-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="text-xs font-semibold text-slate-100">Coach V0（録音チェック）</div>
                  <div class="text-[10px] text-slate-400">Pro機能 / 30-60秒推奨</div>
                </div>
                <p class="text-[10px] text-slate-400 leading-relaxed">
                  ユーザー自身の録音のみ解析します。原曲音源のアップロード解析は対象外です。<br />
                  返すのは傾向と候補（提案）であり、正解の断定ではありません。
                </p>

                <div id="coach-locked" class="rounded-xl border border-amber-300/30 bg-amber-500/10 p-2 text-[11px] text-amber-100">
                  Coach V0はProで利用できます。
                  <button type="button"
                    class="ml-2 inline-flex items-center justify-center gap-1 rounded-full bg-amber-300/15 border border-amber-200/40 px-3 py-1 text-[10px] font-semibold hover:bg-amber-300/25 transition"
                    onclick="startCheckout('pro_month')">
                    Proで使う
                  </button>
                </div>

                <div id="coach-controls" class="hidden space-y-2">
                  <div class="flex flex-col md:flex-row md:flex-wrap gap-2">
                    <button id="coach-record-btn" type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-indigo-500 to-violet-500 px-4 py-2 text-[11px] font-semibold text-white shadow-glow hover:brightness-110 transition w-full md:w-auto"
                      onclick="toggleCoachRecording()">
                      ● 録音開始
                    </button>
                    <button id="coach-analyze-btn" type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-900/80 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-indigo-300/70 hover:text-indigo-100 transition w-full md:w-auto disabled:opacity-40 disabled:cursor-not-allowed"
                      onclick="analyzeCoachRecording()" disabled>
                      解析する
                    </button>
                    <button id="coach-clear-btn" type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-900/80 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-slate-300/70 transition w-full md:w-auto disabled:opacity-40 disabled:cursor-not-allowed"
                      onclick="clearCoachRecording()" disabled>
                      クリア
                    </button>
                  </div>
                  <audio id="coach-audio-preview" controls class="hidden w-full"></audio>
                  <div id="coach-status" class="text-[11px] text-slate-400"></div>
                  <div id="coach-result" class="hidden rounded-xl border border-white/10 bg-slate-950/50 p-2 text-[11px] text-slate-200"></div>
                </div>
              </div>

              <!-- UGC Panel (always visible; freeでも出す) -->
              <div id="ugc-panel" class="mt-3 rounded-2xl border border-white/10 bg-slate-950/40 p-3 space-y-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="text-xs font-semibold text-slate-100">UGC素材（投稿用）</div>
                  <div class="text-[10px] text-slate-400">保存/コピーして使える素材を自動生成</div>
                </div>

                <div class="flex flex-col md:flex-row md:flex-wrap gap-2">
                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-4 py-2 text-[11px] font-semibold text-white shadow-glow hover:brightness-110 transition w-full md:w-auto"
                    onclick="ugcGenerate()">
                    🖼 UGC用画像を生成（1080×1920）
                  </button>

                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-950/60 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                    onclick="ugcCopyScript('6s')">
                    📋 台本コピー（6秒）
                  </button>
                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-950/60 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                    onclick="ugcCopyScript('8s')">
                    📋 台本コピー（8秒）
                  </button>
                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-950/60 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                    onclick="ugcCopyScript('15s')">
                    📋 台本コピー（15秒）
                  </button>

                  <button type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-full border border-white/15 bg-slate-950/60 px-4 py-2 text-[11px] font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition w-full md:w-auto"
                    onclick="ugcCopyLink()">
                    🔗 拡散リンクをコピー
                  </button>
                </div>

                <div id="ugc-status" class="text-[11px] text-slate-400"></div>

                <div class="grid gap-2 md:grid-cols-2">
                  <div class="rounded-xl border border-white/10 bg-slate-950/40 p-2">
                    <div class="text-[10px] text-slate-400 mb-1">生成画像プレビュー</div>
                    <a id="ugc-image-link" href="#" target="_blank" rel="noopener" class="hidden underline text-[11px] text-singkana-200">画像を開く</a>
                    <img id="ugc-image-preview" class="hidden mt-2 w-full rounded-lg border border-white/10" alt="UGC image preview" />
                  </div>
                  <div class="rounded-xl border border-white/10 bg-slate-950/40 p-2 space-y-2">
                    <div class="text-[10px] text-slate-400">台本（自動生成）</div>
                    <textarea id="ugc-script-box" rows="6"
                      class="w-full rounded-lg border border-white/10 bg-slate-950/30 p-2 text-[11px] text-slate-100 placeholder:text-slate-600 font-mono"
                      readonly placeholder="ここに台本が表示されます（生成後）"></textarea>
                  </div>
                </div>

                <div class="rounded-xl border border-white/10 bg-slate-950/40 p-2">
                  <div class="text-[10px] text-slate-400 mb-2">投稿URLを提出（任意）</div>
                  <div class="flex flex-col md:flex-row gap-2">
                    <select id="ugc-platform"
                      class="rounded-full bg-slate-950/60 border border-slate-600 px-3 py-2 text-[11px] text-slate-100 w-full md:w-auto">
                      <option value="tiktok">TikTok</option>
                      <option value="ig">Instagram</option>
                      <option value="yt">YouTube</option>
                      <option value="other">Other</option>
                    </select>
                    <input id="ugc-post-url" type="url" placeholder="https://..."
                      class="flex-1 rounded-full border border-white/15 bg-slate-950/60 px-4 py-2 text-[11px] text-slate-100 placeholder:text-slate-500" />
                    <button type="button"
                      class="inline-flex items-center justify-center gap-2 rounded-full bg-white/10 px-4 py-2 text-[11px] font-semibold text-slate-100 border border-white/10 hover:bg-white/15 transition w-full md:w-auto"
                      onclick="ugcSubmitPost()">
                      📮 提出
                    </button>
                  </div>
                  <div id="ugc-submit-status" class="text-[11px] text-slate-400 mt-1"></div>
                </div>
              </div>
            </div>

            <div id="tab-feedback" class="tab-panel hidden">
              <p class="text-xs font-semibold text-slate-100 mb-1">フィードバック</p>
              <p class="text-[11px] text-slate-400 mb-2">
                ※歌詞そのもののコピー＆ペーストはお控えください（行番号＋コメント推奨）。
              </p>
              <textarea
                id="feedback-text"
                placeholder="例）#12 の「believe」のところ、もう少し伸ばした表記だと歌いやすい。"
                class="w-full min-h-[120px] rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80"
              ></textarea>
              <button
                class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-4 py-1.5 text-xs font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                type="button"
                onclick="sendFeedback()"
              >
                <span class="icon text-xs">✉</span>
                <span>フィードバックを送信</span>
              </button>
              <div id="feedback-status" class="feedback-status text-[11px] text-slate-300 mt-1"></div>

              <div class="text-[11px] text-slate-400 mt-3">
                <a href="/tokusho.html" target="_blank" rel="noopener" class="underline">特定商取引法に基づく表記</a> ・
                <a href="/terms.html" target="_blank" rel="noopener" class="underline">利用規約</a> ・
                <a href="/privacy.html" target="_blank" rel="noopener" class="underline">プライバシーポリシー</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section id="cta-bottom" class="space-y-3 md:space-y-4 pt-4 md:pt-8 border-t border-white/10">
      <h2 class="text-xl md:text-2xl font-semibold">「歌いたい」を、今日「歌えた」に変える。</h2>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed hidden md:block">
        英語が読めなくても、発音が苦手でも、あなたの声はもっと自由に歌える。<br />
        SingKANA は <span class="font-semibold text-singkana-100">“音楽と言語の境界線” を溶かす</span>ためのAIです。
      </p>
      <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2 md:gap-3">
        <a href="#studio"
          class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition">
          無料でかな変換を試す
        </a>
        <a href="#hero"
          class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-950/80 px-5 py-2 text-xs font-medium text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
          ページの先頭に戻る
        </a>
      </div>
    </section>
  </main>

  <footer class="border-t border-white/10 bg-slate-950/80">
    <div class="mx-auto max-w-7xl 2xl:max-w-[1440px] px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-2">
      <p class="text-[11px] text-slate-500">© <span id="year">2026</span> SingKANA. All rights reserved.</p>
      <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <a href="/tokusho.html" target="_blank" rel="noopener" class="text-[11px] text-slate-400 hover:text-singkana-200 transition">特定商取引法に基づく表記</a>
          <a href="/terms.html" target="_blank" rel="noopener" class="text-[11px] text-slate-400 hover:text-singkana-200 transition">利用規約</a>
          <a href="/privacy.html" target="_blank" rel="noopener" class="text-[11px] text-slate-400 hover:text-singkana-200 transition">プライバシーポリシー</a>
        </div>
        <div class="flex items-center gap-4">
          <a href="https://en.singkana.com" target="_blank" rel="noopener" class="text-[11px] text-slate-400 hover:text-singkana-200 transition">
            Global users? Check English LP here →
          </a>
          <a href="/lp/whitepaper.html" target="_blank" rel="noopener" class="text-[11px] text-slate-500 hover:text-singkana-200 transition underline underline-offset-2 decoration-slate-500/60 px-1 py-0.5">
            Powered by Sovereign Cognitive Architecture.
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- =========================================================
  Scripts (bottom)
  - core.js (依存)
  - page scripts (あなたのロジックを整理して1箇所に集約)
  ========================================================== -->
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Language Detection & Auto-Redirect (英語ユーザーをen.singkana.comへ) -->
  <script>
    (function() {
      // URLパラメータで ?lang=ja があればリダイレクトしない
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('lang') === 'ja') {
        return;
      }
      
      // ブラウザ言語が英語系の場合、en.singkana.comへリダイレクト
      const browserLang = navigator.language || navigator.userLanguage;
      const isEnglish = browserLang.startsWith('en');
      
      // 現在のドメインが singkana.com で、英語ユーザーの場合のみリダイレクト
      if (isEnglish && window.location.hostname === 'singkana.com' && !window.location.hostname.includes('en.')) {
        window.location.href = 'https://en.singkana.com' + window.location.pathname + window.location.search;
      }
    })();
  </script>

  <!-- クライアントサイド変換エンジン -->
  <script src="/singkana_core.js"></script>

  <script>
    // =========================
    // Global State
    // =========================
    window.currentConvertedLines = [];  // 結果再描画のためグローバル保持
    window.activeIndex = -1;
    window.__lastGptApplied = false;
    window.__lastConvertMeta = null;
    let currentActiveBlock = null;

    // =========================
    // Plan Gate (Free / Pro)
    // =========================
    const PLAN = {
      tier: "free", // "free" | "pro"
      devProOverride: false, // 開発者モードフラグ
      effectiveMode: "basic" // server-side fixed: free=basic / pro=natural
    };

    function isPro() {
      return PLAN.tier === "pro";
    }

    function setProCheckoutStatus(msg) {
      const el = document.getElementById("pro-checkout-status");
      if (!el) return;
      el.textContent = msg || "";
    }

    let __checkoutInFlight = false;
    let __portalInFlight = false;
    let __sheetCheckoutInFlight = false;
    const SHEET_CHECKOUT_DRAFT_KEY = "singkana_sheet_checkout_draft_v1";
    const COACH_MAX_SECONDS = 60;
    let __coachMediaRecorder = null;
    let __coachStream = null;
    let __coachChunks = [];
    let __coachAudioBlob = null;
    let __coachRecording = false;
    let __coachAutoStopTimer = null;
    let __coachAnalyzeInFlight = false;

    function syncProCtas() {
      const buyBtn = document.getElementById("pro-checkout-btn");
      const proBadge = document.getElementById("pro-active-badge");
      const portalBtn = document.getElementById("billing-portal-btn");
      const portalStatus = document.getElementById("billing-portal-status");
      const proStartBtn = document.getElementById("pro-start-btn");
      const preorderSection = document.getElementById("pro-preorder-section");
      const transferIssueBox = document.getElementById("transfer-issue-box");

      if (isPro()) {
        if (buyBtn) buyBtn.classList.add("hidden");
        if (proBadge) proBadge.classList.remove("hidden");
        if (portalBtn) portalBtn.classList.remove("hidden");
        if (proStartBtn) proStartBtn.classList.add("hidden");
        // Pro時に「準備中/先行登録」系CTAが残ると矛盾するので必ず隠す
        if (preorderSection) preorderSection.classList.add("hidden");
        if (transferIssueBox) transferIssueBox.classList.remove("hidden");
        setProCheckoutStatus("現在 Pro です");
      } else {
        if (buyBtn) buyBtn.classList.remove("hidden");
        if (proBadge) proBadge.classList.add("hidden");
        if (portalBtn) portalBtn.classList.add("hidden");
        if (proStartBtn) proStartBtn.classList.remove("hidden");
        if (preorderSection) preorderSection.classList.remove("hidden");
        if (transferIssueBox) transferIssueBox.classList.add("hidden");
        if (portalStatus) portalStatus.textContent = "";
        // 初期は空（必要時だけ出す）
      }
      syncCoachPanelPlan();
    }

    function syncCoachPanelPlan() {
      const locked = document.getElementById("coach-locked");
      const controls = document.getElementById("coach-controls");
      if (!locked || !controls) return;
      if (isPro()) {
        locked.classList.add("hidden");
        controls.classList.remove("hidden");
      } else {
        locked.classList.remove("hidden");
        controls.classList.add("hidden");
      }
    }

    let __transferIssueInFlight = false;
    let __transferClaimInFlight = false;

    async function issueTransferCode() {
      if (__transferIssueInFlight) return;
      __transferIssueInFlight = true;

      const status = document.getElementById("transfer-issue-status");
      const out = document.getElementById("transfer-code-display");
      try {
        if (status) status.textContent = "発行中…";
        if (out) out.textContent = "";
        const res = await fetch("/api/transfer/issue", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}",
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok || !j.code) {
          if (status) status.textContent = (j && (j.message || j.error)) ? (j.message || j.error) : "発行できませんでした。";
          return;
        }
        if (out) out.textContent = j.code;
        if (status) status.textContent = "このコードを別ブラウザに入力してください。";
      } catch (e) {
        if (status) status.textContent = "通信に失敗しました。";
      } finally {
        __transferIssueInFlight = false;
      }
    }

    async function claimTransferCode() {
      if (__transferClaimInFlight) return;
      __transferClaimInFlight = true;

      const input = document.getElementById("transfer-code-input");
      const status = document.getElementById("transfer-claim-status");
      const code = (input && input.value) ? input.value : "";

      try {
        if (status) status.textContent = "引き継ぎ中…";
        const res = await fetch("/api/transfer/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          if (status) status.textContent = (j && (j.message || j.error)) ? (j.message || j.error) : "引き継げませんでした。";
          return;
        }
        if (status) status.textContent = "完了。再読み込みします…";
        window.location.reload();
      } catch (e) {
        if (status) status.textContent = "通信に失敗しました。";
      } finally {
        __transferClaimInFlight = false;
      }
    }

    async function openBillingPortal() {
      if (__portalInFlight) return;
      __portalInFlight = true;

      const btn = document.getElementById("billing-portal-btn");
      const status = document.getElementById("billing-portal-status");
      const prevText = btn ? btn.textContent : "";

      try {
        if (btn) {
          btn.disabled = true;
          btn.textContent = "開いています…";
        }
        if (status) status.textContent = "";

        const res = await fetch("/api/billing/portal", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}",
        });

        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok || !j.url) {
          const msg = (j && (j.message || j.error)) ? (j.message || j.error) : "ポータルを開けませんでした。";
          if (status) status.textContent = msg;
          return;
        }
        window.location.href = j.url;
      } catch (e) {
        if (status) status.textContent = "通信に失敗しました。";
      } finally {
        __portalInFlight = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = prevText || "請求管理（解約・カード変更）";
        }
      }
    }

    async function retryPlanSyncAfterCheckoutSuccess() {
      // Webhook反映のタイミング差を吸収（success時だけ短時間リトライ）
      const delays = [800, 1600, 3200];
      for (const d of delays) {
        if (isPro()) {
          setProCheckoutStatus("✅ 決済完了。Pro が有効になりました");
          syncProCtas();
          // 決済完了時に緑バッジを強調表示
          const badge = document.getElementById("pro-active-badge");
          if (badge) {
            badge.classList.remove("hidden");
            badge.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
          return;
        }
        await new Promise(r => setTimeout(r, d));
        await loadUserPlan();
      }
      if (isPro()) {
        setProCheckoutStatus("✅ 決済完了。Pro が有効になりました");
        syncProCtas();
        // 決済完了時に緑バッジを強調表示
        const badge = document.getElementById("pro-active-badge");
        if (badge) {
          badge.classList.remove("hidden");
          badge.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      } else {
        setProCheckoutStatus("決済完了。反映に少し時間がかかっています（数秒後に再読込してください）");
      }
    }

    async function startCheckout(plan = "pro_month") {
      if (isPro()) {
        alert("すでに Pro です。");
        return;
      }

      if (__checkoutInFlight) {
        setProCheckoutStatus("処理中です…");
        return;
      }

      const btn = document.getElementById("pro-checkout-btn");
      const prevText = btn ? btn.textContent : "";
      __checkoutInFlight = true;
      let didNavigate = false;
      try {
        if (btn) {
          btn.disabled = true;
          btn.textContent = "決済画面を開いています…";
        }
        setProCheckoutStatus("決済画面を準備中…");

        // 計測: checkout_click
        if (typeof dataLayer !== 'undefined') {
          dataLayer.push({
            event: 'checkout_click',
            plan: plan,
            timestamp: new Date().toISOString()
          });
        }

        const res = await fetch("/api/billing/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ plan }),
        });
        const j = await res.json();
        if (!j.ok) {
          setProCheckoutStatus("");
          alert(j.message || "決済を開始できませんでした。");
          return;
        }
        didNavigate = true;
        window.location.href = j.url;
      } catch (e) {
        setProCheckoutStatus("");
        alert("決済を開始できませんでした。通信環境を確認して再度お試しください。");
      } finally {
        if (!didNavigate) {
          __checkoutInFlight = false;
          if (btn) {
            btn.disabled = false;
            btn.textContent = prevText || "今すぐProで歌える";
          }
        }
      }
    }

    // 開発者モード状態を取得（ページ読み込み時）
    async function loadUserPlan() {
      try {
        // URLパラメータから dev_pro トークンを取得
        const urlParams = new URLSearchParams(window.location.search);
        const devProToken = urlParams.get("dev_pro");
        
        // dev_pro トークンがある場合は /api/me に渡す
        const apiUrl = devProToken ? `/api/me?dev_pro=${encodeURIComponent(devProToken)}` : "/api/me";
        
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (data.ok) {
          const prevEffectiveMode = PLAN.effectiveMode;
          PLAN.tier = data.plan || "free";
          PLAN.devProOverride = data.dev_pro_override || false;
          PLAN.effectiveMode = data.effective_mode || (PLAN.tier === "pro" ? "natural" : "basic");
          
          // 開発者モードバッジを表示
          // A1方針: 本番ホスト（*.singkana.com）では絶対に表示しない
          const badge = document.getElementById("dev-pro-badge");
          
          if (badge) {
            const host = String(window.location.hostname || "").toLowerCase();
            const isPublicProdHost =
              (host === "singkana.com" || host.endsWith(".singkana.com")) &&
              !host.startsWith("staging.") &&
              !host.startsWith("dev.");

            if (!isPublicProdHost && PLAN.devProOverride) {
              // バッジ文言はHTMLに埋め込まず、開発者モード時にだけ付与する（公開HTMLから除外）
              badge.textContent = "DEV PRO ON";
              badge.classList.remove("hidden");
            } else {
              badge.textContent = "";
              badge.classList.add("hidden");
            }
          }
          
          // Pricing側CTAも同期
          syncProCtas();

          // プラン更新により表示モードが変わった場合は結果を再描画
          if (prevEffectiveMode !== PLAN.effectiveMode && window.currentConvertedLines && window.currentConvertedLines.length) {
            _renderConvertResult(window.currentConvertedLines, !!window.__lastGptApplied);
          }

          // 解約予約中の表示（Webhookの subscription.updated が拾えていれば表示できる）
          try {
            const sub = data.subscription || null;
            if (sub && isPro() && sub.cancel_at_period_end) {
              setProCheckoutStatus("解約予約中（期限までは利用可）");
            }
          } catch (e) {}
          return data;
        }
      } catch (e) {
        // silently fail - plan defaults to free
      }
      return null;
    }

    // =========================
    // Tabs
    // =========================
    function setResultPlaceholderState(){
      const rp = document.getElementById("result-panel");
      if (!rp) return;
      const onlyP = rp.children.length === 1 && rp.firstElementChild && rp.firstElementChild.tagName === "P";
      rp.classList.toggle("is-placeholder", !!onlyP);
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ユーザープラン（開発者モード含む）を読み込み
      loadUserPlan();
      setCoachButtonsState();
      syncCoachPanelPlan();

      // UGC: panel open (best-effort)
      try {
        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "ugc_panel_open" }),
        }).catch(() => {});
      } catch (e) {}

      // Checkout戻り（success/cancel）を表示し、URLを掃除
      try {
        const url = new URL(window.location.href);
        const checkout = url.searchParams.get("checkout");
        const portal = url.searchParams.get("portal");
        const sheetCheckout = url.searchParams.get("sheet_checkout");
        const sheetSessionId = url.searchParams.get("session_id");
        if (checkout === "success") {
          setProCheckoutStatus("決済完了。Pro状態を確認中…");
          
          // 計測: checkout_success
          if (typeof dataLayer !== 'undefined') {
            dataLayer.push({
              event: 'checkout_success',
              timestamp: new Date().toISOString()
            });
          }
          
          // もう一度同期（Webhook反映直後のタイミング差を吸収）
          setTimeout(() => loadUserPlan(), 350);
          setTimeout(() => retryPlanSyncAfterCheckoutSuccess(), 500);
        } else if (checkout === "cancel") {
          setProCheckoutStatus("決済をキャンセルしました。");
        }
        if (sheetCheckout === "success" && sheetSessionId) {
          setStatus("決済を確認中…");
          _trackSheet("sheet_checkout_complete");
          const draft = loadSheetCheckoutDraft();
          const fallbackTitle = (draft && draft.title) ? String(draft.title) : getSongTitleSafe();
          (async () => {
            try {
              const token = await claimSheetToken(sheetSessionId);
              _trackSheet("sheet_claim_ok");
              if (!draft || !Array.isArray(draft.lines) || !draft.lines.length) {
                setStatus("PDF生成データが見つかりません。戻る前のタブで再度PDFを押してください。");
                return;
              }
              const resp = await requestPdfWithTokenAndPayload(token, draft);
              const ct = (resp.headers.get("content-type") || "").toLowerCase();
              if (resp.ok && ct.includes("application/pdf")) {
                _trackSheet("sheet_pdf_download_ok", { via: "oneshot" });
                await downloadPdfBlobResponse(resp, fallbackTitle);
                clearSheetCheckoutDraft();
              } else {
                let j = {};
                try { j = await resp.json(); } catch (_) {}
                const msg = (j && j.message) ? j.message : "PDFダウンロードに失敗しました。";
                _trackSheet("sheet_claim_fail", { reason: msg.slice(0, 80) });
                setStatus(msg);
              }
            } catch (e) {
              _trackSheet("sheet_claim_fail", { reason: ((e && e.message) || "unknown").slice(0, 80) });
              setStatus((e && e.message) ? e.message : "決済確認に失敗しました。");
            }
          })();
        } else if (sheetCheckout === "cancel") {
          setStatus("PDF決済をキャンセルしました。");
        }
        if (portal === "return") {
          const ps = document.getElementById("billing-portal-status");
          if (ps) ps.textContent = "請求管理から戻りました";
        }
        if (checkout) {
          url.searchParams.delete("checkout");
          window.history.replaceState({}, "", url.toString());
        }
        if (portal) {
          url.searchParams.delete("portal");
          window.history.replaceState({}, "", url.toString());
        }
        if (sheetCheckout) {
          url.searchParams.delete("sheet_checkout");
          url.searchParams.delete("session_id");
          window.history.replaceState({}, "", url.toString());
        }
      } catch (e) {}
      
      const tabButtons = document.querySelectorAll(".tab-btn");
      const panels = {
        result: document.getElementById("tab-result"),
        feedback: document.getElementById("tab-feedback"),
      };

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.toggle("active", b === btn));
          Object.entries(panels).forEach(([key, panel]) => {
            const active = key === tab;
            panel.classList.toggle("active", active);
            panel.classList.toggle("hidden", !active);
          });
        });
      });

      // 起動時に復元（localStorage）
      restoreStudioState(true);
      setResultPlaceholderState();

      // 自動保存
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");

      let t = null;
      function scheduleAutoSave(){
        if (t) clearTimeout(t);
        t = setTimeout(() => saveStudioState(true), 450);
      }
      [songEl, lyrEl, fbEl].forEach(el => {
        if (!el) return;
        el.addEventListener("input", scheduleAutoSave);
        el.addEventListener("change", scheduleAutoSave);
      });

    });

    // =========================
    // UGC (Generate -> Share -> Submit)
    // =========================
    const UGC = {
      ref_code: "",
      share_url: "",
      scripts: { "6s": "", "8s": "", "15s": "" },
      image_url: ""
    };

    function setUgcStatus(msg) {
      const el = document.getElementById("ugc-status");
      if (el) el.textContent = msg || "";
    }

    async function ugcLoadRef() {
      try {
        const res = await fetch("/api/me/ref");
        const j = await res.json().catch(() => ({}));
        if (res.ok && j && j.ok) {
          UGC.ref_code = j.ref_code || "";
          UGC.share_url = j.share_url || "";
        }
      } catch (e) {}
    }

    function ugcGetBeforeAfter() {
      // サーバに歌詞を送らないため、変換結果（Before/After）だけ送る
      // currentConvertedLines は { en, standard, singkana, ... } を想定
      if (!window.currentConvertedLines || !window.currentConvertedLines.length) {
        return { before_text: "", after_text: "" };
      }
      const mode = __getDisplayMode();
      const before_text = window.currentConvertedLines.map(x => (x.standard || x.kana || "").trim()).filter(Boolean).join("\n");
      const after_text = window.currentConvertedLines.map(x => (__modePrimaryKana(x, mode) || "").trim()).filter(Boolean).join("\n");
      return { before_text, after_text };
    }

    function ugcPickHook() {
      // v1: 固定フック（後でテンプレA/B/Cへ拡張）
      return "このローマ字、歌えない";
    }

    async function ugcGenerate() {
      if (!window.currentConvertedLines || !window.currentConvertedLines.length) {
        setUgcStatus("先に変換してください（結果が必要です）。");
        return;
      }
      setUgcStatus("UGC素材を生成中…");
      await ugcLoadRef();
      const { before_text, after_text } = ugcGetBeforeAfter();
      const hook = ugcPickHook();

      try {
        const res = await fetch("/api/ugc/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ before_text, after_text, hook }),
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          setUgcStatus((j && (j.message || j.error)) ? (j.message || j.error) : "UGC生成に失敗しました。");
          return;
        }
        UGC.image_url = j.image_url || "";
        UGC.ref_code = j.ref_code || UGC.ref_code;
        UGC.share_url = j.share_url || UGC.share_url;
        const scripts = j.scripts || {};
        UGC.scripts["6s"] = scripts["6s"] || "";
        UGC.scripts["8s"] = scripts["8s"] || "";
        UGC.scripts["15s"] = scripts["15s"] || "";

        const box = document.getElementById("ugc-script-box");
        if (box) box.value = UGC.scripts["8s"] || UGC.scripts["6s"] || UGC.scripts["15s"] || "";

        const link = document.getElementById("ugc-image-link");
        const img = document.getElementById("ugc-image-preview");
        if (UGC.image_url && link && img) {
          link.href = UGC.image_url;
          link.classList.remove("hidden");
          img.src = UGC.image_url;
          img.classList.remove("hidden");
        }

        setUgcStatus("生成しました。保存/コピーして投稿できます。");
      } catch (e) {
        setUgcStatus("通信に失敗しました。");
      }
    }

    async function ugcCopyScript(kind) {
      const k = String(kind || "8s");
      const text = (UGC.scripts[k] || "").trim();
      if (!text) {
        setUgcStatus("先にUGCを生成してください（台本がありません）。");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setUgcStatus(`台本をコピーしました（${k}）`);
      } catch (e) {
        setUgcStatus("コピーに失敗しました。");
      }
      try {
        fetch("/api/events", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: "ugc_script_copy", meta: { kind: k } }) }).catch(() => {});
      } catch (e) {}
    }

    async function ugcCopyLink() {
      await ugcLoadRef();
      const url = (UGC.share_url || "").trim();
      if (!url) {
        setUgcStatus("リンクの取得に失敗しました。");
        return;
      }
      try {
        await navigator.clipboard.writeText(url);
        setUgcStatus("拡散リンクをコピーしました");
      } catch (e) {
        setUgcStatus("コピーに失敗しました。");
      }
      try {
        fetch("/api/events", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: "ugc_link_copy" }) }).catch(() => {});
      } catch (e) {}
    }

    async function ugcSubmitPost() {
      const status = document.getElementById("ugc-submit-status");
      const platform = (document.getElementById("ugc-platform")?.value || "other").toString();
      const post_url = (document.getElementById("ugc-post-url")?.value || "").toString().trim();
      if (!post_url) {
        if (status) status.textContent = "投稿URLを入力してください。";
        return;
      }
      if (status) status.textContent = "送信中…";
      try {
        const res = await fetch("/api/ugc/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ platform, post_url }),
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          if (status) status.textContent = (j && (j.message || j.error)) ? (j.message || j.error) : "送信に失敗しました。";
          return;
        }
        if (status) status.textContent = "ありがとうございます。受け取りました。";
        try { document.getElementById("ugc-post-url").value = ""; } catch (e) {}
      } catch (e) {
        if (status) status.textContent = "通信に失敗しました。";
      }
    }

    // =========================
    // Studio Save/Restore/Templates
    // =========================
    const LS_KEY = "singkana.studio.v1";
    const TEMPLATES = {
      warmup: { label: "ウォームアップ（短文）", title: "warmup", lyrics: ["Take it easy, keep it steady","Breathe in slow, breathe out ready","Hold the note and let it glow"].join("\n") },
      chorus: { label: "サビ練習（汎用）", title: "chorus-practice", lyrics: ["We are rising, we are shining","In the night, we keep on flying","Let it go, and sing it loud"].join("\n") },
      speech: { label: "語尾・子音の練習", title: "consonants", lyrics: ["Just a little bit, step by step","Keep the beat, don't stop, don't slip","Bright light, night ride, right side"].join("\n") }
    };
    const USECASE_PRESETS = {
      utawaku: {
        label: "歌枠",
        title: "utawaku-set",
        lyrics: [
          "Hold on to me tonight",
          "We will rise and never hide",
          "Sing it out and keep the light",
        ].join("\n"),
      },
      cover: {
        label: "カバー制作",
        title: "cover-session",
        lyrics: [
          "I found a way through the dark",
          "Keep my heart steady and bright",
          "Take this line and make it yours",
        ].join("\n"),
      },
    };

    function _trackUiEvent(name, meta) {
      try {
        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, meta: meta || {} }),
        }).catch(() => {});
      } catch (_) {}
    }

    function setStudioStatus(msg) {
      const el = document.getElementById("studio-status");
      if (!el) return;
      el.textContent = msg || "";
      if (msg) setTimeout(() => { el.textContent = ""; }, 2200);
    }

    function readStudioStateFromUI() {
      const song = (document.getElementById("song-title")?.value || "").toString();
      const lyrics = (document.getElementById("lyrics-input")?.value || "").toString();
      const feedback = (document.getElementById("feedback-text")?.value || "").toString();
      return { song, lyrics, feedback, ts: new Date().toISOString() };
    }

    function writeStudioStateToUI(st) {
      if (!st) return;
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");
      if (songEl && typeof st.song === "string") songEl.value = st.song;
      if (lyrEl && typeof st.lyrics === "string") lyrEl.value = st.lyrics;
      if (fbEl && typeof st.feedback === "string") fbEl.value = st.feedback;
    }

    function saveStudioState(silent=false) {
      try {
        const st = readStudioStateFromUI();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        if (!silent) setStudioStatus("保存しました");
      } catch (e) {
        if (!silent) setStudioStatus("保存に失敗（localStorage不可）");
      }
    }

    function restoreStudioState(silent=false) {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) { if (!silent) setStudioStatus("保存データなし"); return; }
        const st = JSON.parse(raw);
        writeStudioStateToUI(st);
        if (!silent) setStudioStatus("復元しました");
      } catch (e) {
        if (!silent) setStudioStatus("復元に失敗");
      }
    }

    function clearStudioState() {
      try { localStorage.removeItem(LS_KEY); } catch (e) {}
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");
      if (songEl) songEl.value = "";
      if (lyrEl) lyrEl.value = "";
      if (fbEl) fbEl.value = "";
      setStudioStatus("クリアしました");
    }

    function applyTemplateByKey(key) {
      const t = TEMPLATES[key];
      if (!t) return;
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      if (songEl) songEl.value = t.title;
      if (lyrEl)  lyrEl.value = t.lyrics;
      saveStudioState(true);
      setStudioStatus(`テンプレ適用：${t.label || key}`);
    }

    function applyTemplateFromSelect(fromSelect=false) {
      const sel = document.getElementById("template-select");
      const key = sel ? sel.value : "";
      if (!key) return;
      // select経由だけ confirm（事故防止）
      const songEl = document.getElementById("song-title");
      const lyrEl = document.getElementById("lyrics-input");
      const hasSong = ((songEl && songEl.value) || "").trim().length > 0;
      const hasLyrics = ((lyrEl && lyrEl.value) || "").trim().length > 0;
      if (fromSelect && (hasSong || hasLyrics)) {
        const ok = confirm("現在の入力はテンプレで置き換わります。続行しますか？");
        if (!ok) {
          // 選択を戻して“押し間違い”を確定で無かったことにする
          if (sel) sel.value = "";
          return;
        }
      }
      applyTemplateByKey(key);
      // UX保険：適用後は「選択…」に戻す（連打/再選択の混乱防止）
      if (sel) sel.value = "";
    }

    function applyTemplate(key) {
      const sel = document.getElementById("template-select");
      if (sel) sel.value = "";
      applyTemplateByKey(key);
    }

    function applyUseCasePreset(kind) {
      const p = USECASE_PRESETS[kind];
      if (!p) return;
      const songEl = document.getElementById("song-title");
      const lyrEl = document.getElementById("lyrics-input");
      if (!lyrEl) return;

      const hasInput = ((lyrEl.value || "").trim().length > 0);
      if (hasInput) {
        const ok = confirm("現在の歌詞をプリセットで置き換えますか？");
        if (!ok) return;
      }

      if (songEl && !(songEl.value || "").trim()) {
        songEl.value = p.title;
      }
      lyrEl.value = p.lyrics;
      saveStudioState(true);
      setStudioStatus(`プリセット適用：${p.label}`);
      _trackUiEvent("preset_selected", { value: kind, source: "studio" });
    }

    // =========================
    // Coach V0 (Pro / recording scaffold)
    // =========================
    function setCoachStatus(msg, tone = "normal") {
      const el = document.getElementById("coach-status");
      if (!el) return;
      el.textContent = msg || "";
      el.classList.remove("text-slate-400", "text-rose-300", "text-emerald-300", "text-amber-200");
      if (tone === "error") {
        el.classList.add("text-rose-300");
      } else if (tone === "ok") {
        el.classList.add("text-emerald-300");
      } else if (tone === "warn") {
        el.classList.add("text-amber-200");
      } else {
        el.classList.add("text-slate-400");
      }
    }

    function coachStopTracks() {
      if (__coachStream && __coachStream.getTracks) {
        __coachStream.getTracks().forEach((t) => {
          try { t.stop(); } catch (_) {}
        });
      }
      __coachStream = null;
    }

    function setCoachButtonsState() {
      const recordBtn = document.getElementById("coach-record-btn");
      const analyzeBtn = document.getElementById("coach-analyze-btn");
      const clearBtn = document.getElementById("coach-clear-btn");
      if (recordBtn) {
        recordBtn.textContent = __coachRecording ? "■ 録音停止" : "● 録音開始";
        recordBtn.disabled = __coachAnalyzeInFlight;
      }
      if (analyzeBtn) analyzeBtn.disabled = !__coachAudioBlob || __coachRecording || __coachAnalyzeInFlight;
      if (clearBtn) clearBtn.disabled = (!__coachAudioBlob && !__coachRecording) || __coachAnalyzeInFlight;
    }

    function clearCoachResultView() {
      const resultBox = document.getElementById("coach-result");
      if (!resultBox) return;
      resultBox.classList.add("hidden");
      resultBox.innerHTML = "";
    }

    // MediaRecorderがwebmを返す環境向けに、送信前にWAV(16kHz/mono/PCM16)へ変換する。
    async function blobToWavBlob(blob, targetSampleRate = 16000) {
      const inputBuf = await blob.arrayBuffer();
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) throw new Error("AudioContext not supported");

      const ac = new AudioCtx();
      let decoded = null;
      try {
        decoded = await decodeAudioDataCompat(ac, inputBuf.slice(0));
      } finally {
        try { await ac.close(); } catch (_) {}
      }
      if (!decoded) throw new Error("decode failed");

      const mono = await resampleToMonoFloat32(decoded, targetSampleRate);
      const wavBuffer = encodeWavPCM16(mono, targetSampleRate);
      return new Blob([wavBuffer], { type: "audio/wav" });
    }

    function decodeAudioDataCompat(audioCtx, arrayBuffer) {
      // Safari互換: callback版decodeAudioDataを吸収する
      if (audioCtx.decodeAudioData.length >= 2) {
        return new Promise((resolve, reject) => {
          audioCtx.decodeAudioData(arrayBuffer, resolve, reject);
        });
      }
      return audioCtx.decodeAudioData(arrayBuffer);
    }

    async function resampleToMonoFloat32(audioBuffer, targetSampleRate) {
      const ch0 = audioBuffer.getChannelData(0);
      const ch1 = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : null;
      const mono = new Float32Array(audioBuffer.length);
      if (ch1) {
        for (let i = 0; i < mono.length; i += 1) mono[i] = (ch0[i] + ch1[i]) * 0.5;
      } else {
        mono.set(ch0);
      }

      if (audioBuffer.sampleRate === targetSampleRate) return mono;

      const OfflineCtx = window.OfflineAudioContext || window.webkitOfflineAudioContext;
      if (OfflineCtx) {
        const durationSec = mono.length / audioBuffer.sampleRate;
        const targetLength = Math.max(1, Math.round(durationSec * targetSampleRate));
        const oc = new OfflineCtx(1, targetLength, targetSampleRate);
        const srcBuf = oc.createBuffer(1, mono.length, audioBuffer.sampleRate);
        srcBuf.copyToChannel(mono, 0);
        const src = oc.createBufferSource();
        src.buffer = srcBuf;
        src.connect(oc.destination);
        src.start(0);
        const rendered = await oc.startRendering();
        return new Float32Array(rendered.getChannelData(0));
      }

      return linearResampleFloat32(mono, audioBuffer.sampleRate, targetSampleRate);
    }

    function linearResampleFloat32(input, srcRate, dstRate) {
      const ratio = srcRate / dstRate;
      const outLen = Math.max(1, Math.round(input.length / ratio));
      const out = new Float32Array(outLen);
      for (let i = 0; i < outLen; i += 1) {
        const t = i * ratio;
        const i0 = Math.floor(t);
        const i1 = Math.min(i0 + 1, input.length - 1);
        const a = t - i0;
        out[i] = input[i0] * (1 - a) + input[i1] * a;
      }
      return out;
    }

    function encodeWavPCM16(samples, sampleRate) {
      const dataSize = samples.length * 2;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);
      const numChannels = 1;
      const bitsPerSample = 16;
      const blockAlign = numChannels * (bitsPerSample / 8);
      const byteRate = sampleRate * blockAlign;

      writeAscii(view, 0, "RIFF");
      view.setUint32(4, 36 + dataSize, true);
      writeAscii(view, 8, "WAVE");
      writeAscii(view, 12, "fmt ");
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);
      writeAscii(view, 36, "data");
      view.setUint32(40, dataSize, true);

      let offset = 44;
      for (let i = 0; i < samples.length; i += 1) {
        const s = Math.max(-1, Math.min(1, samples[i]));
        const v = s < 0 ? Math.round(s * 32768) : Math.round(s * 32767);
        view.setInt16(offset, v, true);
        offset += 2;
      }
      return buffer;
    }

    function writeAscii(view, offset, text) {
      for (let i = 0; i < text.length; i += 1) {
        view.setUint8(offset + i, text.charCodeAt(i));
      }
    }

    function clearCoachRecording() {
      if (__coachRecording) {
        try { __coachMediaRecorder && __coachMediaRecorder.stop(); } catch (_) {}
      }
      if (__coachAutoStopTimer) {
        clearTimeout(__coachAutoStopTimer);
        __coachAutoStopTimer = null;
      }
      __coachChunks = [];
      __coachAudioBlob = null;
      __coachMediaRecorder = null;
      coachStopTracks();

      const audioEl = document.getElementById("coach-audio-preview");
      if (audioEl) {
        try { if (audioEl.src) URL.revokeObjectURL(audioEl.src); } catch (_) {}
        audioEl.removeAttribute("src");
        audioEl.classList.add("hidden");
      }
      clearCoachResultView();
      setCoachStatus("");
      __coachRecording = false;
      setCoachButtonsState();
    }

    async function toggleCoachRecording() {
      if (!isPro()) {
        setCoachStatus("CoachはProで利用できます。", "warn");
        return;
      }
      if (__coachAnalyzeInFlight) return;
      if (__coachRecording) {
        try { __coachMediaRecorder && __coachMediaRecorder.stop(); } catch (_) {}
        return;
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || typeof MediaRecorder === "undefined") {
        setCoachStatus("このブラウザは録音に対応していません。", "error");
        return;
      }

      try {
        clearCoachResultView();
        __coachChunks = [];
        __coachAudioBlob = null;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        __coachStream = stream;

        const prefer = "audio/webm;codecs=opus";
        const options = (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(prefer))
          ? { mimeType: prefer }
          : undefined;
        const rec = options ? new MediaRecorder(stream, options) : new MediaRecorder(stream);
        __coachMediaRecorder = rec;
        __coachRecording = true;
        setCoachButtonsState();
        setCoachStatus(`録音中… 最大 ${COACH_MAX_SECONDS} 秒`, "warn");

        rec.ondataavailable = (ev) => {
          if (ev && ev.data && ev.data.size > 0) __coachChunks.push(ev.data);
        };
        rec.onstop = () => {
          if (__coachAutoStopTimer) {
            clearTimeout(__coachAutoStopTimer);
            __coachAutoStopTimer = null;
          }
          __coachRecording = false;
          const mime = (rec.mimeType || "audio/webm").toLowerCase();
          __coachAudioBlob = new Blob(__coachChunks, { type: mime });
          __coachChunks = [];
          coachStopTracks();
          setCoachButtonsState();

          const audioEl = document.getElementById("coach-audio-preview");
          if (audioEl && __coachAudioBlob) {
            try { if (audioEl.src) URL.revokeObjectURL(audioEl.src); } catch (_) {}
            audioEl.src = URL.createObjectURL(__coachAudioBlob);
            audioEl.classList.remove("hidden");
          }
          const sec = Math.max(1, Math.round(__coachAudioBlob.size / 8000));
          setCoachStatus(`録音を保存しました（約 ${sec} 秒 / 解析可能）。`, "ok");
        };
        rec.onerror = () => {
          __coachRecording = false;
          coachStopTracks();
          setCoachButtonsState();
          setCoachStatus("録音でエラーが発生しました。", "error");
        };

        rec.start(300);
        __coachAutoStopTimer = setTimeout(() => {
          if (__coachRecording && __coachMediaRecorder && __coachMediaRecorder.state !== "inactive") {
            try { __coachMediaRecorder.stop(); } catch (_) {}
            setCoachStatus(`${COACH_MAX_SECONDS} 秒で自動停止しました。`, "warn");
          }
        }, COACH_MAX_SECONDS * 1000);
      } catch (e) {
        __coachRecording = false;
        coachStopTracks();
        setCoachButtonsState();
        setCoachStatus("マイクの利用が許可されていません。", "error");
      }
    }

    function renderCoachResult(result) {
      const box = document.getElementById("coach-result");
      if (!box) return;
      const duration = Number(result && result.duration_sec ? result.duration_sec : 0);
      const breaths = Array.isArray(result && result.breath_candidates_sec) ? result.breath_candidates_sec : [];
      const silenceSegments = Array.isArray(result && result.silence_segments) ? result.silence_segments : [];
      const stats = (result && result.stats && typeof result.stats === "object") ? result.stats : {};

      const breathItems = breaths.length
        ? breaths.map((s) => `<li>${Number.isFinite(Number(s)) ? Number(s).toFixed(2) : "-"}s</li>`).join("")
        : "<li>候補なし</li>";
      const segmentItems = silenceSegments.length
        ? silenceSegments.map((seg) => {
            const st = Number(seg && seg.start);
            const ed = Number(seg && seg.end);
            const stText = Number.isFinite(st) ? st.toFixed(2) : "-";
            const edText = Number.isFinite(ed) ? ed.toFixed(2) : "-";
            return `<li>${stText}s - ${edText}s</li>`;
          }).join("")
        : "<li>区間なし</li>";

      const statRows = [
        ["sample_rate", stats.sr_hz],
        ["channels", stats.channels],
        ["silence_db", stats.silence_db],
        ["frame_ms", stats.frame_ms],
        ["hop_ms", stats.hop_ms],
        ["min_silence_ms", stats.min_silence_ms],
      ].map(([k, v]) => `<div class="inline-flex items-center gap-1 rounded-full border border-white/15 bg-white/5 px-2 py-0.5">${escapeHtml(String(k))}: <strong>${escapeHtml(String(v ?? "-"))}</strong></div>`).join("");

      box.innerHTML = `
        <div class="text-[10px] text-slate-400 mb-1">解析結果（無音検出）</div>
        <div class="text-[11px] text-slate-200 mb-2">録音長: ${duration > 0 ? duration.toFixed(2) : "-"} 秒</div>
        <div class="text-[11px] text-slate-300 mb-1">ブレス候補</div>
        <ul class="list-disc pl-4 text-[11px] text-slate-200 space-y-0.5 mb-2">${breathItems}</ul>
        <div class="text-[11px] text-slate-300 mb-1">無音区間</div>
        <ul class="list-disc pl-4 text-[11px] text-slate-200 space-y-0.5 mb-2">${segmentItems}</ul>
        <div class="text-[11px] text-slate-300 mb-1">解析パラメータ</div>
        <div class="flex flex-wrap gap-1.5">${statRows}</div>
      `;
      box.classList.remove("hidden");
    }

    async function analyzeCoachRecording() {
      if (!isPro()) {
        setCoachStatus("CoachはProで利用できます。", "warn");
        return;
      }
      if (__coachAnalyzeInFlight) return;
      if (!__coachAudioBlob) {
        setCoachStatus("先に録音してください。", "warn");
        return;
      }

      __coachAnalyzeInFlight = true;
      setCoachButtonsState();
      setCoachStatus("解析中…", "warn");
      clearCoachResultView();
      try {
        let uploadBlob = __coachAudioBlob;
        if (!((uploadBlob.type || "").toLowerCase().includes("wav"))) {
          setCoachStatus("録音形式をWAVへ変換中…", "warn");
          uploadBlob = await blobToWavBlob(uploadBlob, 16000);
        }
        const fd = new FormData();
        fd.append("audio", uploadBlob, "coach_recording.wav");
        fd.append("meta", JSON.stringify({
          source: "user_recording",
        }));

        const res = await fetch("/api/coach/analyze", {
          method: "POST",
          body: fd,
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          const msg = (j && (j.message || j.error)) ? (j.message || j.error) : "解析に失敗しました。";
          setCoachStatus(msg, "error");
          return;
        }
        renderCoachResult(j.analysis || j.result || {});
        setCoachStatus("解析が完了しました。", "ok");
      } catch (e) {
        const detail = (e && e.message) ? String(e.message) : "";
        if (detail) {
          setCoachStatus(`解析に失敗しました: ${detail}`, "error");
        } else {
          setCoachStatus("通信に失敗しました。時間を置いて再試行してください。", "error");
        }
      } finally {
        __coachAnalyzeInFlight = false;
        setCoachButtonsState();
      }
    }

    // =========================
    // Export helpers
    // =========================
    function setStatus(msg) {
      const el = document.getElementById("export-status");
      if (!el) return;
      el.textContent = msg || "";
      if (msg) setTimeout(() => { el.textContent = ""; }, 2200);
    }
    function getSongTitleSafe() {
      const t = (document.getElementById("song-title")?.value || "").trim();
      return t ? t.replace(/[\\\/:*?"<>|]/g, "_") : "singkana";
    }
    function fmt2(n){ return String(n).padStart(2,"0"); }
    function secToSrtTime(sec){
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      const ms = Math.floor((sec - Math.floor(sec)) * 1000);
      return `${fmt2(h)}:${fmt2(m)}:${fmt2(s)},${String(ms).padStart(3,"0")}`;
    }
    function buildKanaOnlyText() {
      if (!window.currentConvertedLines.length) return "";
      const mode = __getDisplayMode();
      return window.currentConvertedLines
        .map(x => (__modePrimaryKana(x, mode) || "").trim())
        .filter(Boolean)
        .join("\n");
    }
    function buildEnKanaText() {
      if (!window.currentConvertedLines.length) return "";
      const mode = __getDisplayMode();
      return window.currentConvertedLines.map(x => {
        const en = (x.en || "").trim();
        const ka = (__modePrimaryKana(x, mode) || "").trim();
        const no = x.lineNo ? `#${x.lineNo}` : "";
        return `${no} ${en}\n${ka}`.trim();
      }).join("\n\n");
    }
    async function copyTextToClipboard(text) {
      if (!text) { setStatus("コピーする内容がありません"); return; }
      try {
        await navigator.clipboard.writeText(text);
        setStatus("コピーしました");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        setStatus("コピーしました");
      }
    }
    function downloadBlob(filename, content, mime) {
      const blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function downloadBlobFile(filename, blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function buildSheetPayloadFromCurrentResult() {
      if (!window.currentConvertedLines.length) return null;
      const mode = __getDisplayMode();
      const title = (document.getElementById("song-title")?.value || "").toString().trim();
      const lines = window.currentConvertedLines.map((line) => {
        const orig = (line.en || line.orig || "").toString().trim();
        const raw = (__modePrimaryKana(line, mode) || "").toString().trim();
        const kana = renderDisplay(raw, mode);
        return { orig, kana };
      }).filter((x) => x.orig || x.kana);
      if (!lines.length) return null;
      return { title, artist: "", lines };
    }
    function saveSheetCheckoutDraft(payload) {
      try { localStorage.setItem(SHEET_CHECKOUT_DRAFT_KEY, JSON.stringify(payload || {})); } catch (_) {}
    }
    function loadSheetCheckoutDraft() {
      try {
        const raw = localStorage.getItem(SHEET_CHECKOUT_DRAFT_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return null;
        return parsed;
      } catch (_) {
        return null;
      }
    }
    function clearSheetCheckoutDraft() {
      try { localStorage.removeItem(SHEET_CHECKOUT_DRAFT_KEY); } catch (_) {}
    }
    async function requestSheetCheckout(payload) {
      const p = payload && typeof payload === "object" ? payload : {};
      const res = await fetch("/api/sheet/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(p),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok || !j.url) {
        const msg = (j && j.message) ? j.message : "決済画面を開けませんでした。";
        throw new Error(msg);
      }
      return j.url;
    }
    async function claimSheetToken(sessionId) {
      const res = await fetch(`/api/sheet/claim?session_id=${encodeURIComponent(sessionId)}`);
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok || !j.sheet_token) {
        const msg = (j && j.message) ? j.message : "決済確認に失敗しました。";
        throw new Error(msg);
      }
      return j.sheet_token;
    }
    async function requestPdfWithPayload(payload) {
      return fetch("/api/sheet/pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    }
    async function requestPdfWithTokenAndPayload(sheetToken, payload) {
      const p = payload && typeof payload === "object" ? payload : {};
      return fetch("/api/sheet/pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // One-shotは token + payload を同時に送る（サーバは保存しない）
        body: JSON.stringify({ ...(p || {}), sheet_token: sheetToken }),
      });
    }
    async function downloadPdfBlobResponse(resp, fallbackTitle = "") {
      const blob = await resp.blob();
      const safeTitle = (fallbackTitle || getSongTitleSafe() || "singkana").trim();
      downloadBlobFile(`${safeTitle}_singkana.pdf`, blob);
      setStatus("PDFを保存しました");
    }
    function copyKanaOnly(){ copyTextToClipboard(buildKanaOnlyText()); }
    function copyEnKana(){ copyTextToClipboard(buildEnKanaText()); }
    function downloadTxt(){
      const text = buildEnKanaText();
      if (!text) { setStatus("出力がありません"); return; }
      downloadBlob(`${getSongTitleSafe()}_singkana.txt`, text + "\n", "text/plain;charset=utf-8");
      setStatus("TXTを保存しました");
    }
    function downloadSrt(){
      if (!window.currentConvertedLines.length) { setStatus("出力がありません"); return; }
      const mode = __getDisplayMode();
      const dur = 2.2;
      let t = 0;
      let idx = 1;
      const srt = window.currentConvertedLines.map(line => {
        const text = (__modePrimaryKana(line, mode) || line.en || "").trim();
        const start = secToSrtTime(t);
        const end = secToSrtTime(t + dur);
        t += dur;
        return `${idx++}\n${start} --> ${end}\n${text}\n`;
      }).join("\n");
      downloadBlob(`${getSongTitleSafe()}_singkana.srt`, srt, "text/plain;charset=utf-8");
      setStatus("SRT(簡易)を保存しました");
    }

    function primaryCtaPdf() {
      _trackUiEvent("cta_pdf_clicked", {
        has_result: !!(window.currentConvertedLines && window.currentConvertedLines.length),
        effective_mode: __getDisplayMode(),
      });
      downloadPdfSheet();
    }

    function _openSheetPreviewWindow(payload) {
      const title = escapeHtml((payload && payload.title) ? payload.title : "singkana-sheet");
      const rows = (payload && Array.isArray(payload.lines) ? payload.lines : []).map((line) => {
        const orig = escapeHtml(String(line?.orig || ""));
        const kana = escapeHtml(String(line?.kana || ""));
        return `<tr><td style="padding:6px 8px;border-bottom:1px solid #e5e7eb;color:#111827;">${orig}</td><td style="padding:6px 8px;border-bottom:1px solid #e5e7eb;color:#0f172a;font-weight:600;">${kana}</td></tr>`;
      }).join("");
      const html = `
<!doctype html>
<html><head><meta charset="utf-8"><title>${title}</title></head>
<body style="font-family:system-ui,sans-serif;background:#f8fafc;color:#111827;margin:24px;">
  <h1 style="font-size:18px;margin:0 0 8px;">${title}</h1>
  <p style="font-size:12px;color:#475569;margin:0 0 12px;">SingKANA Sheet Preview</p>
  <table style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e2e8f0;">
    <thead><tr style="background:#f1f5f9;"><th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Original</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Kana</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
</body></html>`;
      const w = window.open("", "_blank", "noopener,noreferrer");
      if (!w) return false;
      w.document.open();
      w.document.write(html);
      w.document.close();
      return true;
    }

    async function primaryCtaSheet() {
      const payload = buildSheetPayloadFromCurrentResult();
      _trackUiEvent("cta_sheet_clicked", {
        has_result: !!payload,
        effective_mode: __getDisplayMode(),
      });
      if (!payload) {
        setStatus("先に変換してください");
        return;
      }
      if (_openSheetPreviewWindow(payload)) {
        setStatus("Sheetプレビューを開きました");
        return;
      }
      // ポップアップ不可環境では共有用テキストをコピー
      const shareText = payload.lines.map((line) => `${line.orig}\n${line.kana}`).join("\n\n");
      await copyTextToClipboard(shareText);
      setStatus("Sheet共有用テキストをコピーしました");
    }

    // --- 事業KPI計測ヘルパー ---
    function _trackSheet(eventName, meta) {
      try {
        // GTM dataLayer
        if (typeof dataLayer !== 'undefined') {
          dataLayer.push({ event: eventName, timestamp: new Date().toISOString(), ...(meta || {}) });
        }
        // Backend /api/events
        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: eventName, meta: meta || {} }),
        }).catch(() => {});
      } catch (_) {}
    }

    async function downloadPdfSheet(){
      const payload = buildSheetPayloadFromCurrentResult();
      if (!payload) { setStatus("出力がありません"); return; }
      if (__sheetCheckoutInFlight) { setStatus("決済処理中です…"); return; }

      _trackSheet("sheet_try_submit", { has_title: !!(payload.title && String(payload.title).trim()) });
      setStatus("PDFを生成中…");
      try {
        // Proは payload を送って即PDF生成。Freeは payload を送らず、決済用の 402 を受け取る。
        const resp = await requestPdfWithPayload(isPro() ? payload : {});
        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (resp.ok && ct.includes("application/pdf")) {
          _trackSheet("sheet_pdf_download_ok", { via: "pro" });
          await downloadPdfBlobResponse(resp, payload.title || getSongTitleSafe());
          return;
        }

        let data = {};
        try { data = await resp.json(); } catch (_) {}
        if (resp.status === 402) {
          const amountJpy = data.amount_jpy || 300;
          _trackSheet("sheet_paywall_402", { amount_jpy: amountJpy });
          saveSheetCheckoutDraft(payload);
          setStatus("");

          // Paywall modal
          const existing = document.getElementById("sheet-paywall-modal");
          if (existing) existing.remove();

          const modal = document.createElement("div");
          modal.id = "sheet-paywall-modal";
          modal.style.cssText = "position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)";
          modal.innerHTML = `
            <div style="background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px 24px;max-width:380px;width:90%;text-align:center;color:#e2e8f0;font-family:system-ui,sans-serif">
              <div style="font-size:32px;margin-bottom:8px">📄</div>
              <h3 style="font-size:18px;font-weight:700;margin:0 0 6px;color:#fff">PDF練習シート</h3>
              <p style="font-size:13px;color:#94a3b8;margin:0 0 16px;line-height:1.6">
                歌詞・かな表記・ブレス記号入りの<br>
                <strong style="color:#c0aeff">印刷用練習シート</strong>を生成します
              </p>
              <div style="background:#0f172a;border-radius:10px;padding:14px;margin-bottom:16px">
                <div style="font-size:28px;font-weight:800;color:#a184ff">¥${amountJpy}</div>
                <div style="font-size:11px;color:#64748b;margin-top:2px">1回限り・買い切り</div>
              </div>
              <ul style="text-align:left;font-size:12px;color:#cbd5e1;margin:0 0 16px;padding-left:20px;line-height:1.8">
                <li>決済完了後すぐにPDFダウンロード</li>
                <li>QRコード付き（友達にもシェア可能）</li>
                <li>Stripe安全決済（カード情報は当社に届きません）</li>
              </ul>
              <button id="sheet-paywall-buy" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#8a5dff,#7441f0);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:opacity 0.2s">
                ¥${amountJpy} で購入する
              </button>
              <button id="sheet-paywall-close" style="display:block;margin:12px auto 0;background:none;border:none;color:#64748b;font-size:12px;cursor:pointer">
                キャンセル
              </button>
              <p style="font-size:10px;color:#475569;margin-top:12px">
                Proプラン（月額¥980）ならPDF無制限 + AI発音補正つき
              </p>
            </div>
          `;
          document.body.appendChild(modal);

          modal.querySelector("#sheet-paywall-close").onclick = () => {
            modal.remove();
            __sheetCheckoutInFlight = false;
          };
          modal.addEventListener("click", (ev) => {
            if (ev.target === modal) { modal.remove(); __sheetCheckoutInFlight = false; }
          });

          modal.querySelector("#sheet-paywall-buy").onclick = async () => {
            const btn = modal.querySelector("#sheet-paywall-buy");
            btn.textContent = "決済画面へ移動中…";
            btn.style.opacity = "0.6";
            btn.disabled = true;
            __sheetCheckoutInFlight = true;
            try {
              // checkout_url が無い場合のみ /api/sheet/checkout で再取得（payloadは送らない）
              const url = (data && data.checkout_url) ? data.checkout_url : await requestSheetCheckout({});
              _trackSheet("sheet_checkout_open");
              window.location.href = url;
            } catch (e) {
              btn.textContent = `¥${amountJpy} で購入する`;
              btn.style.opacity = "1";
              btn.disabled = false;
              setStatus((e && e.message) ? e.message : "決済を開始できませんでした。");
              __sheetCheckoutInFlight = false;
            }
          };
          return;
        }

        const msg = (data && data.message) ? data.message : "PDF生成に失敗しました";
        setStatus(msg);
      } catch (e) {
        setStatus("PDF生成に失敗しました");
      } finally {
        __sheetCheckoutInFlight = false;
      }
    }

    // =========================
    // Highlight / Speak
    // =========================
    function setActiveBlock(block) {
      if (currentActiveBlock && currentActiveBlock !== block) currentActiveBlock.classList.remove("active");
      currentActiveBlock = block;
      if (block) block.classList.add("active");
    }
    function scrollActiveIntoView() {
      const chk = document.getElementById("auto-scroll");
      if (chk && !chk.checked) return;
      if (currentActiveBlock) currentActiveBlock.scrollIntoView({ block: "center", behavior: "smooth" });
    }
    
    // ハッシュリンク（#terms, #privacy, #faq）の処理
    function showHashSection() {
      const hash = window.location.hash;
      if (hash === "#terms" || hash === "#privacy" || hash === "#faq") {
        const section = document.querySelector(hash);
        if (section) {
          // #terms と #privacy は hidden クラスを持つ
          if (hash === "#terms" || hash === "#privacy") {
            section.classList.remove("hidden");
          }
          section.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }
    }
    
    // ページ読み込み時とハッシュ変更時に実行
    showHashSection();
    window.addEventListener("hashchange", showHashSection);
    
    function speakKana(text) {
      if (!text || !text.trim()) return;
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const voices = window.speechSynthesis.getVoices();
      const jpVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith("ja"));
      if (jpVoice) utter.voice = jpVoice;
      window.speechSynthesis.speak(utter);
    }
    function setActiveIndex(i){
      if (!window.currentConvertedLines.length) return;
      window.activeIndex = Math.max(0, Math.min(i, window.currentConvertedLines.length - 1));
      const target = document.querySelector(`.result-block[data-line-no="${window.currentConvertedLines[window.activeIndex].lineNo}"]`);
      if (target) {
        setActiveBlock(target);
        const line = window.currentConvertedLines[window.activeIndex];
        const speakText = (__modePrimaryKana(line, __getDisplayMode()) || line.en || "");
        speakKana(speakText);
        scrollActiveIntoView();
      }
    }
    function nextLine(){ if (window.currentConvertedLines.length) setActiveIndex((window.activeIndex < 0 ? 0 : window.activeIndex + 1)); }
    function prevLine(){ if (window.currentConvertedLines.length) setActiveIndex((window.activeIndex < 0 ? 0 : window.activeIndex - 1)); }

    // =========================
    // Display Layer
    // =========================
    function __getDisplayMode(){
      const serverMode = (PLAN.effectiveMode || "").toLowerCase();
      if (serverMode === "natural" || serverMode === "basic") return serverMode;
      return isPro() ? "natural" : "basic";
    }

    // モードに応じて、実際に表示/出力するかな列を選ぶ
    function __modePrimaryKana(line, mode){
      if (!line) return "";
      const m = (mode || __getDisplayMode() || "natural").toLowerCase();
      if (m === "basic") {
        return line.standard || line.kana || line.singkana || "";
      }
      // natural は SingKANA 系を優先
      return line.singkana || line.kana || line.standard || "";
    }
    function _renderDisplayPlainText(coreText, mode){
      if (!coreText) return "";

      let t = String(coreText);
      // 表記ゆれ対策: ひらがな混入はカタカナへ寄せる
      t = t.replace(/[\u3041-\u3096]/g, (ch) => String.fromCharCode(ch.charCodeAt(0) + 0x60));
      t = t.replace(/\u3000/g, " ");
      t = t.replace(/\[.*?\]/g, "");
      t = t.replace(/[|\/]/g, "");
      // 区切り記号を統一（カンマを「｜」に置換）
      t = t.replace(/[,，]/g, "｜");
      t = t.replace(/\s{2,}/g, " ");

      if (mode === "basic") {
        t = t.replace(/\s+/g, " ").trim();
        t = t.replace(/([ぁ-んァ-ヶ一-龠々〆ヵヶ])\s+([ぁ-んァ-ヶ一-龠々〆ヵヶ])/g, "$1$2");
        t = t.replace(/\s+([、。！？])/g, "$1");
        t = t.replace(/([、。！？])\s+/g, "$1");
        t = t.replace(/ー{2,}/g, "ー");
        t = t.replace(/っ\s+([ぁ-んァ-ヶA-Za-z])/g, "っ$1");
        t = t.replace(/\s{2,}/g, " ");
        return t.trim();
      }

      t = t.replace(/\s+/g, " ");
      t = t.replace(/([、。！？])\s*/g, "$1 ");
      t = t.replace(/([ぁ-ん]{10,})/g, (m) => {
        const chunks = [];
        for (let i = 0; i < m.length; i += 5) chunks.push(m.slice(i, i + 5));
        return chunks.join(" ");
      });
      t = t.replace(/\s{2,}/g, " ");
      return t.trim();
    }

    function renderDisplay(coreText, mode){
      if (!coreText) return "";
      const t = String(coreText);

      // HTML（差分ハイライトやタグ）が混ざるケースでは、属性を壊さないよう text node のみ加工
      if (t.includes("<")) {
        const tpl = document.createElement("template");
        tpl.innerHTML = t;
        const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_TEXT);
        let node;
        while ((node = walker.nextNode())) {
          node.nodeValue = _renderDisplayPlainText(node.nodeValue, mode);
        }
        return tpl.innerHTML;
      }

      return _renderDisplayPlainText(t, mode);
    }

    function renderKanaHtml(kanaRaw){
      if (!kanaRaw) return "";
      const escaped = escapeHtml(String(kanaRaw));
      let out = "";
      let inElision = false;
      for (let i = 0; i < escaped.length; i++) {
        const ch = escaped[i];
        if (ch === "(") {
          if (!inElision) {
            inElision = true;
            out += '<span class="mk mk-paren">(</span><span class="mk mk-eli">';
          } else {
            out += "(";
          }
          continue;
        }
        if (ch === ")") {
          if (inElision) {
            inElision = false;
            out += '</span><span class="mk mk-paren">)</span>';
          } else {
            out += ")";
          }
          continue;
        }
        if (ch === "˘") {
          out += '<span class="mk mk-breath">˘</span><span class="mk-gap"></span>';
          continue;
        }
        if (ch === "↑") {
          out += '<span class="mk mk-up">↑</span>';
          continue;
        }
        if (ch === "↓") {
          out += '<span class="mk mk-down">↓</span>';
          continue;
        }
        if (ch === "～") {
          out += '<span class="mk mk-liaison">～</span>';
          continue;
        }
        out += ch;
      }
      if (inElision) {
        out += "</span>";
      }
      return out;
    }

    function renderKanaHtmlInHtml(html){
      if (!html) return "";
      const tpl = document.createElement("template");
      tpl.innerHTML = html;
      const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_TEXT);
      const targets = [];
      let node;
      while ((node = walker.nextNode())) {
        if (!node.nodeValue) continue;
        if (/[˘↑↓～()]/.test(node.nodeValue)) {
          targets.push(node);
        }
      }
      targets.forEach((textNode) => {
        if (!textNode.parentNode) return;
        const replacement = document.createElement("template");
        replacement.innerHTML = renderKanaHtml(textNode.nodeValue);
        textNode.parentNode.replaceChild(replacement.content, textNode);
      });
      return tpl.innerHTML;
    }

    function renderDisplayWithKanaMarks(coreText, mode, hasHtml = false){
      if (!coreText) return "";
      const rendered = renderDisplay(coreText, mode);
      if (!rendered) return "";
      return hasHtml ? renderKanaHtmlInHtml(rendered) : renderKanaHtml(rendered);
    }

    // 本文の可読性を壊さず、下段チップでガイド情報だけ提示する
    function inferGuideBadges(text, mode){
      const m = (mode || __getDisplayMode() || "natural").toLowerCase();
      if (m === "basic") return [];

      const src = String(text || "");
      const hasBR = /˘/.test(src);
      const hasHLD = /～/.test(src);
      const hasVIB = /[↑↓]/.test(src);
      const hasELI = /[()]/.test(src);

      const candidates = [
        { label: "BR(息)", active: hasBR },
        { label: "HLD(連結)", active: hasHLD },
        { label: "VIB(強調)", active: hasVIB },
      ];
      if (hasELI) {
        candidates.push({ label: "ELI(脱落)", active: true });
      }
      const active = candidates.filter((b) => b.active);
      return active.length ? active : [{ label: "マークなし", active: false }];
    }

    function createGuideBadgeRow(text, mode){
      const badges = inferGuideBadges(text, mode);
      if (!badges.length) return null;

      const row = document.createElement("div");
      row.className = "mt-1 flex flex-wrap items-center gap-1.5";

      badges.forEach((b) => {
        const chip = document.createElement("span");
        chip.className = b.active
          ? "rounded-full border border-white/20 bg-slate-800/60 px-2 py-0.5 text-[9px] text-slate-200"
          : "rounded-full border border-white/10 bg-slate-900/40 px-2 py-0.5 text-[9px] text-slate-500";
        chip.textContent = b.label;
        row.appendChild(chip);
      });

      return row;
    }

    // =========================
    // Convert (server is the source of truth)
    // =========================
    let __convertInFlight = false;

    function _normalizeServerConvertLines(lines) {
      if (!Array.isArray(lines)) return [];
      return lines.map((line, i) => {
        const en = String(line?.en || "");
        return {
          en,
          standard: String(line?.standard || convertToStandardKana(en) || ""),
          singkana: String(line?.singkana || line?.kana || line?.standard || ""),
          lineNo: Number(line?.lineNo || (i + 1)),
        };
      }).filter((x) => x.en || x.standard || x.singkana);
    }

    function _normalizeLocalConvertLines(lines) {
      if (!Array.isArray(lines)) return [];
      return lines.map((line) => {
        const en = String(line?.en || "");
        const basicKana = convertToStandardKana(en);
        return {
          en,
          standard: basicKana,
          // server failure時はBasic相当に寄せる（表示上の混乱を回避）
          singkana: basicKana,
          lineNo: Number(line?.lineNo || 0),
        };
      }).filter((x) => x.en || x.standard || x.singkana);
    }

    async function convertLyrics() {
      if (__convertInFlight) return;
      const errorBanner = document.getElementById("error-banner");
      const resultPanel = document.getElementById("result-panel");
      const lyrics = document.getElementById("lyrics-input").value || "";

      if (errorBanner) {
        errorBanner.style.display = "none";
        errorBanner.textContent = "";
      }
      if (!lyrics.trim()) {
        if (resultPanel) {
          resultPanel.innerHTML = "<p style='font-size:12px;color:#cbd5f5;'>歌詞を入力してください。</p>";
          setResultPlaceholderState();
        }
        return;
      }

      __convertInFlight = true;
      try {
        if (resultPanel) {
          resultPanel.innerHTML = "<p style='font-size:12px;color:#cbd5f5;'>変換中です...</p>";
          setResultPlaceholderState();
        }

        const resp = await fetch("/api/convert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: lyrics }),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok || !Array.isArray(data.result)) {
          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : "変換に失敗しました。";
          throw new Error(msg);
        }

        const linesWithComparison = _normalizeServerConvertLines(data.result);
        if (!linesWithComparison.length) {
          window.currentConvertedLines = [];
          window.activeIndex = -1;
          if (resultPanel) {
            resultPanel.innerHTML = "<p style='font-size:12px;color:#cbd5f5;'>有効な行がありませんでした。</p>";
            setResultPlaceholderState();
          }
          return;
        }

        window.__lastConvertMeta = {
          effective_mode: String(data.effective_mode || __getDisplayMode()),
          processing_mode: String(data.processing_mode || data.effective_mode || __getDisplayMode()),
          hard_case: !!data.hard_case,
          gpt_applied: !!data.gpt_applied,
        };
        _renderConvertResult(linesWithComparison, !!data.gpt_applied);
      } catch (error) {
        // サーバー失敗時のみローカル変換へフォールバック
        if (window.SingKanaCore && window.SingKanaCore.convertLyrics) {
          try {
            const localLines = _normalizeLocalConvertLines(window.SingKanaCore.convertLyrics(lyrics));
            if (localLines.length) {
              window.__lastConvertMeta = {
                effective_mode: "basic",
                processing_mode: "fallback_local",
                hard_case: false,
                gpt_applied: false,
              };
              _renderConvertResult(localLines, false);
              if (errorBanner) {
                errorBanner.textContent = "サーバー最適化に失敗したためローカル結果を表示しています。";
                errorBanner.style.display = "block";
              }
              return;
            }
          } catch (_) {}
        }
        if (resultPanel) {
          resultPanel.innerHTML = `<p style='font-size:12px;color:#ff6b6b;'>変換エラーが発生しました: ${error.message}</p>`;
          setResultPlaceholderState();
        }
      } finally {
        __convertInFlight = false;
      }
    }

    // 変換結果をDOMに描画する共通関数
    function _renderConvertResult(linesWithComparison, gptApplied) {
      const resultPanel = document.getElementById("result-panel");
      if (!resultPanel) return;
      const mode = __getDisplayMode();

      window.currentConvertedLines = linesWithComparison;
      window.activeIndex = -1;
      window.__lastGptApplied = !!gptApplied;

      // 2段比較表示を構築
      const frag = document.createDocumentFragment();
      
      // デフォルト表示: Pro結果のみ（比較は折りたたみ）
      linesWithComparison.forEach((line, i) => {
        const lineContainer = document.createElement("div");
        lineContainer.className = "mb-3 md:mb-4";

        // 英語原文（スマホで非表示 or 小さく）
        const enDiv = document.createElement("div");
        enDiv.className = "hidden md:block text-xs text-slate-400 mb-2";
        enDiv.textContent = line.en || "";
        lineContainer.appendChild(enDiv);

        // SingKANA（最適化あり）- メイン表示
        const singkanaBlock = createComparisonBlock(
          "singkana",
          (() => {
            if (mode === "natural") return "歌いやすさ優先カタカナ（Pro）";
            return "直訳寄りカタカナ（Free）";
          })(),
          __modePrimaryKana(line, mode),
          i,
          "singkana",
          (mode === "basic") ? null : (line.standard || "")
        );
        lineContainer.appendChild(singkanaBlock);

        // Basic以外は、比較トグル（Standard版）を表示
        if (mode !== "basic") {
          const compareToggle = document.createElement("div");
          compareToggle.className = "mt-2";
          const toggleBtn = document.createElement("button");
          toggleBtn.className = "text-[10px] text-slate-400 hover:text-slate-300 transition flex items-center gap-1";
          toggleBtn.innerHTML = `<span>▼</span> <span>一般的なカタカナと比較する（歌いにくさの原因を見る）</span>`;
          
          const standardContainer = document.createElement("div");
          standardContainer.className = "hidden mt-2";
          const standardBlock = createComparisonBlock(
            "standard",
            "一般的なカタカナ（歌いやすさ最適化なし）",
            line.standard || "",
            i,
            "standard",
            null
          );
          standardContainer.appendChild(standardBlock);
          
          toggleBtn.onclick = () => {
            const isHidden = standardContainer.classList.contains("hidden");
            if (isHidden) {
              standardContainer.classList.remove("hidden");
              toggleBtn.innerHTML = `<span>▲</span> <span>一般的なカタカナを非表示</span>`;
            } else {
              standardContainer.classList.add("hidden");
              toggleBtn.innerHTML = `<span>▼</span> <span>一般的なカタカナと比較する（歌いにくさの原因を見る）</span>`;
            }
          };
          
          compareToggle.appendChild(toggleBtn);
          compareToggle.appendChild(standardContainer);
          lineContainer.appendChild(compareToggle);
        }

        frag.appendChild(lineContainer);
      });

      // GPT AI発音補正が適用された場合のバッジ
      if (gptApplied && isPro()) {
        const gptBadge = document.createElement("div");
        gptBadge.className = "mb-3 rounded-lg border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200 flex items-center gap-2";
        gptBadge.innerHTML = `<span class="text-emerald-400">&#10003;</span> <span>AI発音補正が適用されました（Pro専用機能）</span>`;
        // fragの先頭に挿入
        if (frag.firstChild) {
          frag.insertBefore(gptBadge, frag.firstChild);
        } else {
          frag.appendChild(gptBadge);
        }
      }

      // Pro誘導ボタン（比較UIの直下に配置）
      if (!isPro()) {
        const proCta = document.createElement("div");
        proCta.className = "mt-4 p-4 rounded-xl bg-gradient-to-r from-singkana-500/20 to-fuchsia-500/20 border border-singkana-400/40";
        proCta.innerHTML = `
          <div class="flex flex-col md:flex-row items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-singkana-100 mb-1">さらに高品質に変換する</p>
              <p class="text-xs text-slate-300">Proで歌いやすさ最適化・無制限変換・台本出力を強化</p>
            </div>
            <button type="button" id="pro-start-btn" onclick="startCheckout('pro_month')" class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition whitespace-nowrap">
              <span>今すぐProで歌える</span>
              <span class="text-xs">▶</span>
            </button>
          </div>
        `;
        frag.appendChild(proCta);
      }

      resultPanel.innerHTML = "";
      resultPanel.appendChild(frag);
      setResultPlaceholderState();

      setActiveIndex(0);
      saveStudioState(true);

      // 計測: convert_success（歌詞は送らず、成功イベントだけ送る）
      try {
        const mode = __getDisplayMode();
        const meta = window.__lastConvertMeta || {};
        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: "convert_success",
            meta: {
              source: "client",
              effective_mode: meta.effective_mode || mode,
              processing_mode: meta.processing_mode || mode,
              hard_case: !!meta.hard_case,
              gpt_applied: (typeof meta.gpt_applied === "boolean") ? meta.gpt_applied : gptApplied,
            }
          }),
        }).catch(() => {});
      } catch (e) {}
    }


    // Standard変換（最適化なし）: クライアントサイド実装
    // 「機械的」「物足りない」「歌えない」を意図的に作る
    // WORD_OVERRIDESなし、フェイク発音なし、語尾ルールなし、ボーカルスタイルなし、伸ばしなし
    function convertToStandardKana(text) {
      if (!text || !text.trim()) return "";
      
      // 基本的な正規化のみ（アポストロフィ削除など）
      let line = text;
      line = line.replace(/[’'`´]/g, "");
      line = line.replace(/[:：]/g, " ");
      
      if (!line.trim()) return "";
      
      const words = line.split(/\s+/);
      const kanaWords = [];
      
      for (const raw of words) {
        if (!raw) continue;
        
        // 記号の処理
        const leadingPuncMatch = raw.match(/^[^A-Za-z0-9]+/);
        const trailingPuncMatch = raw.match(/[^A-Za-z0-9]+$/);
        const leadingPunc = leadingPuncMatch ? leadingPuncMatch[0] : "";
        const trailingPunc = trailingPuncMatch ? trailingPuncMatch[0] : "";
        
        const core = raw
          .replace(/^[^A-Za-z0-9]+/, "")
          .replace(/[^A-Za-z0-9]+$/, "");
        
        if (!core) {
          kanaWords.push(leadingPunc + trailingPunc);
          continue;
        }
        
        const kanaCore = romanToKanaStandard(core);
        kanaWords.push(leadingPunc + kanaCore + trailingPunc);
      }
      
      let kana = kanaWords.join(" ");
      
      // カタカナに統一（最適化なし、スペースはそのまま）
      kana = toKatakanaStandard(kana);
      
      return kana;
    }
    
    // 目的: 「物足りない」「歌えない」変換を作る
    function romanToKanaStandard(word) {
      if (!word) return "";
      
      let s = word.toLowerCase();
      
      // パターンマッチ一切なし（ph→ふ、sh→しなども使わない）
      // 文字単位の機械的な変換のみ
      const charMap = {
        a: "ア", e: "エ", i: "イ", o: "オ", u: "ウ",
        y: "イ",
        b: "ブ", c: "ク", d: "ド", f: "フ", g: "グ",
        h: "ハ", j: "ジ", k: "ク", l: "ル", m: "ム",
        n: "ン", p: "プ", q: "ク", r: "ル", s: "ス",
        t: "ト", v: "ヴ", w: "ウ", x: "クス", z: "ズ"
      };
      
      let result = [];
      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (charMap[ch]) {
          result.push(charMap[ch]);
        } else if (/[0-9]/.test(ch)) {
          result.push(ch);
        }
        // その他の文字は無視（機械的）
      }
      
      // スペースは入れない（単語ごとに区切るだけ）
      return result.join("");
    }
    
    // ひらがな→カタカナ変換（最適化なし）
    function toKatakanaStandard(str) {
      if (!str) return "";
      let result = str.replace(/[ぁ-ん]/g, function (ch) {
        return String.fromCharCode(ch.charCodeAt(0) + 0x60);
      });
      result = result.replace(/ゔ/g, "ヴ");
      return result;
    }
    
    // 差分ハイライト: Standard版とSingKANA版の違いを強調（本当に変わった部分だけ）
    function highlightDifferences(standard, singkana) {
      if (!standard || !singkana) {
        return escapeHtml(singkana || "");
      }

      // 単語単位で分割（スペース区切り）
      const standardWords = standard.split(/\s+/).filter(Boolean);
      const singkanaWords = singkana.split(/\s+/).filter(Boolean);
      
      // 単語単位で比較（本当に変わった部分だけをハイライト）
      const result = [];
      let sIdx = 0;
      let kIdx = 0;
      
      while (sIdx < standardWords.length || kIdx < singkanaWords.length) {
        if (sIdx < standardWords.length && kIdx < singkanaWords.length && 
            standardWords[sIdx] === singkanaWords[kIdx]) {
          // 一致する単語: 通常表示（色を付けない）
          result.push(escapeHtml(singkanaWords[kIdx]));
          sIdx++;
          kIdx++;
        } else {
          // 異なる単語: SingKANA側をハイライト（薄い背景のみ）
          if (kIdx < singkanaWords.length) {
            // 変更された部分だけを薄い背景で強調（色は控えめに）
            result.push(`<span class="bg-singkana-500/20 text-singkana-100 px-0.5 rounded">${escapeHtml(singkanaWords[kIdx])}</span>`);
            kIdx++;
          }
          // Standard側の異なる単語はスキップ
          if (sIdx < standardWords.length) {
            sIdx++;
          }
        }
        
        // スペースを追加（最後の単語以外）
        if (kIdx < singkanaWords.length || sIdx < standardWords.length) {
          result.push(" ");
        }
      }
      
      return result.join("");
    }
    
    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 比較ブロック（Standard/SingKANA）を作成
    function createComparisonBlock(type, label, text, lineIndex, mode, compareText) {
      const block = document.createElement("div");
      // SingKANA側は背景を少し暗くして主従を作る（Standardとの差を明度で取る）
      // Standard側は「安定させる」（背景・枠・装飾を削る）
      // スマホ最適化: パディング圧縮（p-4 → p-2.5 md:p-4）
      block.className = `rounded-lg md:rounded-xl border ${type === "singkana" ? "border-singkana-400/40 bg-slate-950/90 shadow-glow" : "border-slate-700/30 bg-transparent"} p-2.5 md:p-4`;

      // ヘッダー（ラベル + コピーボタン + 文字数）
      // スマホ最適化: マージン圧縮（mb-2 → mb-1.5 md:mb-2）
      const header = document.createElement("div");
      header.className = "flex items-center justify-between mb-1.5 md:mb-2 flex-wrap gap-1.5";
      
      const labelDiv = document.createElement("div");
      labelDiv.className = "flex items-center gap-1.5 flex-wrap";
      
      // ラベル（モードに応じて動的に変更）
      const labelText = document.createElement("span");
      labelText.className = `text-[10px] md:text-xs font-semibold ${type === "singkana" ? "text-singkana-100" : "text-slate-300"}`;
      
      // スマホでラベルを短縮（モードに応じて）
      let shortLabel;
      if (type === "singkana") {
        const mode = __getDisplayMode();
        if (mode === "natural") {
          shortLabel = "歌いやすさ優先";
        } else {
          shortLabel = "直訳寄り";
        }
      } else {
        shortLabel = "一般的なカタカナ";
      }
      
      labelText.textContent = shortLabel;
      labelText.innerHTML = `<span class="hidden md:inline">${label}</span><span class="md:hidden">${shortLabel}</span>`;
      labelDiv.appendChild(labelText);
      
      // SingKANA側にモードバッジを追加
      if (type === "singkana") {
        const mode = __getDisplayMode();
        const badge = document.createElement("span");
        
        // モードに応じたバッジを表示
        if (mode === "natural") {
          // ナチュラルモード：英語リズム保持バッジ
          badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-green-500/15 border border-green-400/25 text-[8px] font-medium text-green-200/80";
          badge.innerHTML = "🟩<span class=\"hidden md:inline\"> Pro / 歌いやすさ優先</span>";
        } else {
          // ベーシックモード：読む用バッジ
          badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-singkana-500/10 border border-singkana-400/20 text-[8px] font-medium text-singkana-200/70";
          badge.innerHTML = "🎤<span class=\"hidden md:inline\"> Free / 直訳寄り</span>";
        }
        
        labelDiv.appendChild(badge);
      }
      
      header.appendChild(labelDiv);

      const actions = document.createElement("div");
      actions.className = "flex items-center gap-1.5 md:gap-2";
      
      // 文字数（スマホで小さく）
      const charCount = document.createElement("span");
      charCount.className = "text-[9px] md:text-[10px] text-slate-400";
      const textLength = (text || "").replace(/\s/g, "").length;
      charCount.textContent = `${textLength}文字`;
      actions.appendChild(charCount);

      // コピーボタン（スマホで小さく）
      const copyBtn = document.createElement("button");
      copyBtn.className = "inline-flex items-center gap-0.5 md:gap-1 px-1.5 md:px-2 py-0.5 md:py-1 rounded text-[9px] md:text-[10px] font-medium text-slate-300 hover:text-slate-100 bg-slate-800/50 hover:bg-slate-700/50 transition";
      copyBtn.innerHTML = `<span>📋</span><span class="hidden md:inline">Copy</span>`;
      copyBtn.onclick = (e) => {
        e.stopPropagation();
        navigator.clipboard.writeText(text || "").then(() => {
          copyBtn.innerHTML = "✓";
          setTimeout(() => {
            copyBtn.innerHTML = `<span>📋</span><span class="hidden md:inline">Copy</span>`;
          }, 1000);
        });
      };
      actions.appendChild(copyBtn);

      header.appendChild(actions);
      block.appendChild(header);

      // 変換結果テキスト（差分ハイライト付き）
      // スマホ最適化: フォントサイズ圧縮（text-sm → text-xs md:text-sm）
      // 行間を広げる（歌唱用テキストは「口に出すもの」なので読みやすく）
      const textDiv = document.createElement("div");
      textDiv.className = "result-ka text-xs md:text-sm text-slate-100 leading-loose md:leading-loose whitespace-pre-wrap";
      
      if (type === "singkana") {
        const mode = __getDisplayMode();
        if (compareText) {
          // SingKANA版: 差分ハイライトを適用
          let highlighted = highlightDifferences(compareText, text);
          textDiv.innerHTML = renderDisplayWithKanaMarks(highlighted, mode, true);
          
          // 固定値の擬似スコアは誤解を招くため表示しない（将来は実測値のみ表示）
        } else {
          // Basic等: 差分ハイライトなしでそのまま表示
          textDiv.innerHTML = renderDisplayWithKanaMarks(text || "", mode, false);
        }
        const guideRow = createGuideBadgeRow(text || "", mode);
        if (guideRow) textDiv.appendChild(guideRow);
      } else {
        // Standard版: 通常表示（文字色は普通、背景・枠・装飾を削る）
        textDiv.textContent = renderDisplay(text || "", __getDisplayMode());
        textDiv.className += " text-slate-300";  // Standard版は安定した文字色
      }
      
      block.appendChild(textDiv);

      return block;
    }

    // =========================
    // ブロック境界（息継ぎ位置）の追加（Pro側のみ）
    // =========================
    function addBreathMarks(text) {
      if (!text) return text;
      
      // HTMLタグを一時的に保護
      const tagPlaceholders = [];
      let tagIndex = 0;
      let processed = text.replace(/<[^>]+>/g, (match) => {
        const placeholder = `__TAG_${tagIndex}__`;
        tagPlaceholders[tagIndex] = match;
        tagIndex++;
        return placeholder;
      });
      
      // 単語単位で分割（スペース区切り）
      const words = processed.split(/(\s+)/);
      const result = [];
      let wordCount = 0;
      
      for (let i = 0; i < words.length; i++) {
        const word = words[i];
        
        // タグプレースホルダーはそのまま
        if (word.startsWith('__TAG_')) {
          result.push(word);
          continue;
        }
        
        // スペースはそのまま
        if (/^\s+$/.test(word)) {
          result.push(word);
          continue;
        }
        
        // 単語をカウント
        wordCount++;
        
        // 3-4単語ごとに息継ぎ位置を挿入（自然な区切り）
        if (wordCount > 0 && (wordCount % 3 === 0 || wordCount % 4 === 0)) {
          result.push(word);
          // 軽いセパレータ「｜」を追加（色ではなく記号で、薄い色）
          result.push(' <span class="text-slate-500/30 text-xs mx-0.5">｜</span> ');
        } else {
          result.push(word);
        }
      }
      
      // タグプレースホルダーを元に戻す
      let final = result.join('');
      for (let i = 0; i < tagPlaceholders.length; i++) {
        final = final.replace(`__TAG_${i}__`, tagPlaceholders[i]);
      }
      
      return final;
    }

    // =========================
    // 例文挿入（1クリックで価値を踏ませる）
    // =========================
    function insertExample(type) {
      const lyricsInput = document.getElementById("lyrics-input");
      if (!lyricsInput) return;
      
      const examples = {
        fast: "Put your heart on the line, we'll be flying tonight",
        consonant: "I want you to know that I'm still here",
        vowel: "Fly me to the moon, let me play among the stars"
      };
      
      const example = examples[type] || examples.fast;
      
      // 既にテキストがある場合は確認
      if (lyricsInput.value.trim()) {
        if (!confirm("現在の入力内容を置き換えますか？")) {
          return;
        }
      }
      
      lyricsInput.value = example;
      lyricsInput.focus();
      
      // 自動変換（オプション）
      // convertLyrics();
    }

    // =========================
    // Feedback → /api/feedback (JSONL + Discord webhook)
    // =========================
    async function sendFeedback() {
      const textBox = document.getElementById("feedback-text");
      const status = document.getElementById("feedback-status");
      const text = (textBox.value || "").trim();
      status.textContent = "";

      if (!text) { status.textContent = "フィードバック内容を入力してください。"; return; }

      // NOTE: 歌詞/本文が混入しやすいので、曲名などの自由入力は送らない
      const meta = { client_side: true, engine_version: "js-core-v1.9" };

      try {
        const res = await fetch("/api/feedback", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ text, meta }),
        });

        const data = await res.json().catch(() => ({ ok: false }));
        if (data.ok) {
          status.textContent = "フィードバックありがとうございました。";
          textBox.value = "";
          saveStudioState(true);
        } else {
          status.textContent = "送信に失敗しました（API未接続の可能性）。";
        }
      } catch (e) {
        status.textContent = "送信に失敗しました（ネットワーク/API未接続）。";
      }
    }

    // =========================
    // 先行登録モーダル
    // =========================
    function openWaitlistModal() {
      const modal = document.getElementById("waitlist-modal");
      if (modal) {
        modal.classList.remove("hidden");
        document.body.style.overflow = "hidden"; // スクロール無効化
      }
    }

    function closeWaitlistModal() {
      const modal = document.getElementById("waitlist-modal");
      if (modal) {
        modal.classList.add("hidden");
        document.body.style.overflow = ""; // スクロール有効化
      }
    }

    async function submitWaitlist(event) {
      event.preventDefault();
      const emailInput = document.getElementById("waitlist-email");
      const agreeCheckbox = document.getElementById("waitlist-agree");
      const submitBtn = document.getElementById("waitlist-submit");
      const statusDiv = document.getElementById("waitlist-status");
      
      const email = (emailInput?.value || "").trim();
      
      if (!email) {
        statusDiv.textContent = "メールアドレスを入力してください。";
        statusDiv.className = "text-xs text-red-400 mt-2";
        return;
      }
      
      if (!agreeCheckbox?.checked) {
        statusDiv.textContent = "規約に同意してください。";
        statusDiv.className = "text-xs text-red-400 mt-2";
        return;
      }
      
      // 送信中
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "登録中...";
      }
      statusDiv.textContent = "";
      
      // 送信後2秒はdisable（連打防止）
      let disableTimeout = null;
      let disableDuration = 2000; // 基本2秒
      
      try {
        const res = await fetch("/api/waitlist", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, source: "ja_main" })
        });
        
        // HTTPステータスコードをチェック
        if (!res.ok) {
          // エラーレスポンスをパース
          let errorMessage = "登録に失敗しました。しばらくしてから再度お試しください。";
          let errorCode = null;
          try {
            const errorData = await res.json();
            if (errorData.message) {
              errorMessage = errorData.message;
            }
            if (errorData.code) {
              errorCode = errorData.code;
            }
          } catch (e) {
            // JSONパースに失敗した場合はデフォルトメッセージ
          }
          
          statusDiv.textContent = errorMessage;
          statusDiv.className = "text-xs text-red-400 mt-2";
          
          // 429エラーの場合は10秒disable
          if (res.status === 429 || errorCode === "rate_limited") {
            disableDuration = 10000;
          }
          
          // disable期間を設定
          if (submitBtn) {
            disableTimeout = setTimeout(() => {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "先行利用に登録する";
              }
            }, disableDuration);
          }
          return;
        }
        
        // 成功レスポンスをパース
        const data = await res.json().catch(() => ({ ok: false, message: "レスポンスの解析に失敗しました。" }));
        
        if (data.ok) {
          // 成功（登録済みも含む）
          const isAlreadyRegistered = data.already_registered === true;
          statusDiv.textContent = data.message || "登録完了しました！";
          statusDiv.className = "text-xs text-green-400 mt-2";
          
          // フォームをリセット
          if (emailInput) emailInput.value = "";
          if (agreeCheckbox) agreeCheckbox.checked = false;
          
          // 成功メッセージとSNSフォローボタンを表示
          const successMessage = document.getElementById("waitlist-success-message");
          const snsSection = document.getElementById("waitlist-sns-section");
          if (successMessage) {
            successMessage.classList.remove("hidden");
          }
          if (snsSection) {
            snsSection.classList.remove("hidden");
          }
          
          // フォームを非表示
          const form = document.querySelector("#waitlist-modal form");
          if (form) {
            form.classList.add("hidden");
          }
          
          // 5秒後にモーダルを閉じる（SNSボタンを見せる時間を確保）
          setTimeout(() => {
            closeWaitlistModal();
            // モーダルを閉じる際に状態をリセット
            if (successMessage) successMessage.classList.add("hidden");
            if (snsSection) snsSection.classList.add("hidden");
            if (form) form.classList.remove("hidden");
            statusDiv.textContent = "";
          }, 5000);
        } else {
          // エラー
          statusDiv.textContent = data.message || "登録に失敗しました。";
          statusDiv.className = "text-xs text-red-400 mt-2";
          
          // disable期間を設定
          if (submitBtn) {
            disableTimeout = setTimeout(() => {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "先行利用に登録する";
              }
            }, disableDuration);
          }
        }
      } catch (e) {
        statusDiv.textContent = "登録に失敗しました。しばらくしてから再度お試しください。";
        statusDiv.className = "text-xs text-red-400 mt-2";
        
        // disable期間を設定
        if (submitBtn) {
          disableTimeout = setTimeout(() => {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = "先行利用に登録する";
            }
          }, disableDuration);
        }
      } finally {
        // タイムアウトが設定されていない場合のみ即座に有効化
        if (!disableTimeout && submitBtn) {
          setTimeout(() => {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = "先行利用に登録する";
            }
          }, disableDuration);
        }
      }
    }
  </script>

  <!-- 先行登録モーダル -->
  <div id="waitlist-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="if(event.target===this) closeWaitlistModal()">
    <div class="relative w-full max-w-md mx-4 bg-slate-900 rounded-2xl border border-singkana-400/30 shadow-glow p-6" onclick="event.stopPropagation()">
      <!-- 閉じるボタン -->
      <button onclick="closeWaitlistModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-100 transition">
        <span class="text-2xl">×</span>
      </button>
      
      <!-- ヘッダー -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-slate-50 mb-1">協力テスターに応募</h3>
        <p class="text-xs text-slate-400">フィードバック協力者には、条件達成で期限付きPro特典を案内します。スパムなし。</p>
      </div>
      
      <!-- 特典表示 -->
      <div class="mb-4 p-3 rounded-lg bg-singkana-500/10 border border-singkana-400/20">
        <p class="text-[11px] font-semibold text-singkana-200 mb-1">🎁 協力テスター特典</p>
        <p class="text-[10px] text-slate-300">採用されたフィードバックで、期限付きPro特典（14日）を付与します。</p>
        <p class="text-[10px] text-slate-400 mt-1">※ 審査・条件達成後に付与（例：採用フィードバック3件）。</p>
      </div>
      
      <!-- フォーム -->
      <form onsubmit="submitWaitlist(event)">
        <div class="mb-4">
          <label for="waitlist-email" class="block text-xs font-semibold text-slate-300 mb-2">メールアドレス</label>
          <input
            id="waitlist-email"
            type="email"
            placeholder="your@email.com"
            required
            class="w-full px-4 py-2 rounded-lg bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:border-singkana-400"
          />
        </div>
        
        <div class="mb-4">
          <label class="flex items-start gap-2 text-xs text-slate-300 cursor-pointer">
            <input
              id="waitlist-agree"
              type="checkbox"
              required
              class="mt-0.5 accent-singkana-400"
            />
            <span>
              <a href="/terms.html" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">利用規約</a>と
              <a href="/privacy.html" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">プライバシーポリシー</a>および
              <a href="/tokusho.html" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">特定商取引法に基づく表記</a>に同意します
            </span>
          </label>
        </div>
        
        <div id="waitlist-status" class="text-xs mt-2"></div>
        
        <button
          id="waitlist-submit"
          type="submit"
          class="w-full mt-4 px-4 py-2 rounded-lg bg-singkana-500/20 text-singkana-100 font-semibold text-sm border border-singkana-400/40 hover:bg-singkana-500/25 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          先行利用に登録する
        </button>
      </form>
      
      <!-- 成功メッセージ（登録成功時に表示） -->
      <div id="waitlist-success-message" class="hidden mb-4">
        <div class="text-center">
          <p class="text-sm text-green-400 font-semibold mb-2">✓ 登録完了しました！</p>
          <p class="text-xs text-slate-400 mb-3">Pro開始時に優先案内します</p>
        </div>
      </div>
      
      <!-- SNSフォローボタン（登録成功時に表示） -->
      <div id="waitlist-sns-section" class="hidden mb-4 pt-4 border-t border-slate-700">
        <p class="text-xs text-slate-400 text-center mb-3">Xで進捗も告知します（任意）</p>
        <div class="flex justify-center gap-3">
          <a
            href="https://twitter.com/SingKANA_ai"
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold border border-slate-600 transition flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            フォローする
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- 利用規約セクション -->
  <section id="terms" class="hidden min-h-screen py-16 px-4 bg-slate-950">
    <div class="max-w-3xl mx-auto">
      <div class="bg-slate-900 rounded-2xl p-8 border border-slate-700">
        <h1 class="text-2xl font-bold text-slate-50 mb-6">SingKANA 利用規約</h1>
        <div class="prose prose-invert max-w-none text-slate-300 space-y-6">
          <p>この利用規約（以下「本規約」といいます。）は、SingKANA（以下「本サービス」といいます。）の利用条件を定めるものです。本サービスをご利用になる前に、本規約をよくお読みください。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第1条（適用）</h2>
          <p>1. 本規約は、本サービスの利用に関わる一切の関係に適用されます。</p>
          <p>2. 本サービスの利用者（以下「ユーザー」といいます。）は、本サービスを利用した時点で本規約に同意したものとみなします。</p>
          <p>3. 本規約の内容は、法令に基づき変更される場合があります。変更後の規約は、本サービス上に掲載された時点から効力を生じるものとします。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第2条（本サービスの概要）</h2>
          <p>1. 本サービスは、ユーザーが入力したテキスト（英語歌詞等）をもとに、日本語のかな表記による発音補助表示を行うツールです。</p>
          <p>2. 本サービスには、無料プラン（Free）と有料プラン（Pro）がございます。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>Freeプラン：基本的な変換機能を無料でご利用いただけます。</li>
            <li>Proプラン：より精密な変換、比較表示、Singabilityスコア等の高度な機能をご利用いただけます（月額980円）。</li>
          </ul>
          <p>3. 本サービスにおける基本変換処理は、ユーザーの端末（ブラウザ）内で行われます。ただし、Proプランの「AI発音補正」機能を利用する場合、歌詞テキストは当社サーバーを経由してOpenAI社のAPI（GPT）に送信され、発音補正処理が行われます。送信されたテキストは補正処理完了後、当社サーバーには保存されません（キャッシュを除く）。OpenAI社によるデータの取り扱いについては、同社のプライバシーポリシーをご確認ください。</p>
          <p>4. PDF練習シート（One-Shot購入）の生成時にも、歌詞テキストはサーバーに送信されPDF生成処理が行われます。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第3条（会員登録・アカウント）</h2>
          <p>1. 本サービスの利用にあたり、会員登録は不要です。ただし、Proプランをご利用いただく場合は、決済情報の登録が必要です。</p>
          <p>2. ユーザーは、本サービス上で提供される先行登録（waitlist）機能により、メールアドレスを登録することができます。先行登録により、Proプランの優先案内や特典を受けることができます。</p>
          <p>3. ユーザーは、登録したメールアドレスが正確かつ最新のものであることを保証するものとします。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第4条（料金・支払い）</h2>
          <p>1. Proプランの利用料金は、月額980円（税込）または年額9,600円（税込）です。</p>
          <p>2. 決済は、Stripe社が提供する決済サービスを通じて行われます。決済に関する詳細は、Stripe社の利用規約およびプライバシーポリシーをご確認ください。</p>
          <p>3. 料金は、初回登録時および毎月または毎年の更新日に自動的に課金されます（自動更新）。</p>
          <p>4. ユーザーは、本サービス上の請求管理ページからいつでもProプランを解約することができます。解約後は、現在の課金期間終了時点でProプランの利用が終了し、Freeプランに自動的に移行します。</p>
          <p>5. 解約後も、既に支払い済みの期間についてはProプランの機能をご利用いただけます。</p>
          <p>6. 返金については、デジタルサービスの性質上、原則として返金は行いません。二重課金など当社起因の不具合が確認できた場合は個別に対応します。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第5条（著作権等について）</h2>
          <p>1. 商用楽曲の歌詞は、作詞者・音楽出版社その他の権利者により著作権が保有されています。本サービスは、かかる権利を侵害する目的を一切有していません。</p>
          <p>2. 本サービスは、ユーザーの端末内で歌詞等のテキストをかな表記に変換する機能を提供するものであり、運営側サーバーは歌詞自体を保持しません。</p>
          <p>3. ユーザーは、本サービスを利用して得られたかな表記等の結果について、以下の行為を行わないものとします。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>歌詞内容が特定できる形での全文またはそれに近い範囲のインターネット上への公開</li>
            <li>権利者の許諾なく、商用利用（有償配布、販売物への組み込み等）を行うこと</li>
            <li>その他、各楽曲の権利者の定めるルール・ガイドラインに反する利用</li>
          </ul>
          <p>4. 本サービスの利用に関連してユーザーが第三者との間で紛争を生じさせた場合、ユーザーの責任と費用においてこれを解決するものとし、運営者は一切の責任を負いません。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第6条（禁止事項）</h2>
          <p>ユーザーは、本サービスの利用にあたり、以下の行為を行ってはなりません。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>法令または公序良俗に違反する行為</li>
            <li>第三者の著作権、商標権、その他の権利を侵害する行為</li>
            <li>本サービスの運営を妨げたり、サーバーやネットワークに過度な負荷を与える行為</li>
            <li>本サービスの不正アクセス、不正利用、リバースエンジニアリング等の行為</li>
            <li>レート制限を回避するための自動化ツールやスクリプトの使用</li>
            <li>その他、運営者が不適切と判断する行為</li>
          </ul>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第7条（免責事項）</h2>
          <p>1. 本サービスは「現状有姿」で提供されます。変換結果の正確性・完全性・歌唱上の適合性について、運営者は保証しません。</p>
          <p>2. 本サービスの利用によりユーザーに生じたいかなる損害についても、運営者は一切の責任を負わないものとします。</p>
          <p>3. 本サービスの仕様変更、中断、停止または終了によりユーザーに生じた損害についても、運営者は一切の責任を負いません。</p>
          <p>4. 決済サービス（Stripe）の不具合や停止により生じた損害についても、運営者は一切の責任を負いません。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第8条（サービス内容の変更等）</h2>
          <p>運営者は、ユーザーへの事前の通知なく、本サービスの内容変更・追加・停止・終了を行うことができるものとします。ただし、Proプランの料金変更や重要な機能変更については、可能な限り事前に通知いたします。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第9条（規約の変更）</h2>
          <p>運営者は、必要と判断した場合には、ユーザーへの事前通知なく本規約を変更することができます。変更後の規約は、本サービス上に掲載された時点から効力を生じるものとします。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">第10条（準拠法・裁判管轄）</h2>
          <p>1. 本規約の解釈には、日本法を準拠法とします。</p>
          <p>2. 本サービスに関して紛争が生じた場合、運営者の所在地を管轄する日本の裁判所を専属的合意管轄とします。</p>

          <p class="text-sm text-slate-400 mt-8">制定日：2026年1月14日<br>最終更新日：2026年2月16日</p>
        </div>
      </div>
    </div>
  </section>

  <!-- プライバシーポリシーセクション -->
  <section id="privacy" class="hidden min-h-screen py-16 px-4 bg-slate-950">
    <div class="max-w-3xl mx-auto">
      <div class="bg-slate-900 rounded-2xl p-8 border border-slate-700">
        <h1 class="text-2xl font-bold text-slate-50 mb-6">SingKANA プライバシーポリシー</h1>
        <div class="prose prose-invert max-w-none text-slate-300 space-y-6">
          <p>SingKANA（以下「本サービス」といいます。）は、ユーザーのプライバシーを尊重し、個人情報の保護に取り組みます。本プライバシーポリシーでは、本サービスにおける情報の取扱いについて説明します。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">1. 取得する情報</h2>
          <p>本サービスは、以下の情報を取得する場合があります。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li><strong>アクセス情報</strong>：IPアドレス、ブラウザ種別、OS情報、アクセス日時等のサーバーログ情報</li>
            <li><strong>統計情報</strong>：不具合解析やアクセス状況把握のための、匿名化された統計情報</li>
            <li><strong>メールアドレス</strong>：先行登録（waitlist）機能により、ユーザーが自ら入力したメールアドレス</li>
            <li><strong>決済情報</strong>：Proプランをご利用いただく場合、Stripe社を通じて決済情報（クレジットカード情報等）を取得します。決済情報はStripe社が管理し、本サービス運営者は直接取得・保存しません。</li>
            <li><strong>ユーザーID</strong>：本サービスの利用状況を管理するための、自動生成される識別子（Cookieに保存）</li>
          </ul>
          <p><strong>重要な点</strong>：本サービスのメイン機能である「テキストからかな表記への変換」に際して、Freeプランの基本変換ではユーザーが入力した歌詞・テキストの内容は運営側サーバーには送信されず、端末（ブラウザ）内のみで処理されます。ただし、Proプランの「AI発音補正」機能およびPDF練習シート生成時には、歌詞テキストがサーバーに送信されます。AI発音補正ではOpenAI社のAPI（GPT-4o-mini）を利用しており、歌詞テキストがOpenAI社に送信されます。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">2. 情報の利用目的</h2>
          <p>本サービスでは、取得した情報を以下の目的で利用します。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>本サービスの品質向上・不具合対応のため</li>
            <li>本サービスの利用状況の把握・分析のため</li>
            <li>サービス運営上必要なセキュリティ対策のため</li>
            <li>先行登録者へのProプラン案内・特典提供のため</li>
            <li>Proプランの課金・更新管理のため</li>
            <li>レート制限や不正利用の防止のため</li>
          </ul>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">3. 情報の保存期間</h2>
          <p>1. メールアドレス（先行登録）：Proプランの案内が完了するまで、またはユーザーからの削除依頼があるまで保存します。</p>
          <p>2. サーバーログ：セキュリティ対策のため、一定期間保存した後、自動的に削除します。</p>
          <p>3. ユーザーID（Cookie）：本サービスの利用を継続する限り保存されます。ブラウザの設定により削除することも可能です。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">4. 第三者提供について</h2>
          <p>1. 本サービスは、法令に基づく場合を除き、ユーザーに関する情報を第三者に提供することはありません。</p>
          <p>2. ただし、以下の場合には情報を提供することがあります。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li><strong>AI発音補正（OpenAI）</strong>：Proプランの「AI発音補正」機能利用時に、歌詞テキストがOpenAI社のAPI（GPT-4o-mini）に送信されます。OpenAI社のAPI利用ポリシーに基づき、API経由で送信されたデータはモデルの学習には使用されません。OpenAI社のプライバシーポリシーは<a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">こちら</a>をご確認ください。</li>
            <li><strong>決済サービス（Stripe）</strong>：Proプランおよび単品PDF購入の決済処理のため、Stripe社に必要最小限の情報（ユーザーID、メールアドレス等）を提供します。決済情報（クレジットカード情報等）はStripe社が直接管理します。</li>
            <li><strong>法的要請</strong>：法令に基づく要請がある場合、または裁判所・警察等の公的機関からの要請がある場合</li>
          </ul>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">5. クッキー（Cookie）等の利用について</h2>
          <p>1. 本サービスでは、以下の目的でクッキー（Cookie）を利用します。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>ユーザーIDの保存（本サービスの利用状況管理のため）</li>
            <li>開発者モード（Dev Pro）の一時的な有効化フラグ（開発・検証目的）</li>
            <li>利用状況の分析（匿名化された統計情報の取得）</li>
          </ul>
          <p>2. クッキーにより取得される情報には、特定の個人を直接識別する情報は含まれません。</p>
          <p>3. ブラウザの設定により、クッキーの受け入れを拒否することも可能ですが、その場合、本サービスの一部機能が正常に動作しない可能性があります。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">6. 外部サービスとの連携</h2>
          <p>本サービスでは、以下の外部サービスを利用しています。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li><strong>OpenAI</strong>：Proプランの「AI発音補正」機能で利用。歌詞テキストの発音補正処理のため。OpenAI社のプライバシーポリシーは<a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">こちら</a>をご確認ください。</li>
            <li><strong>Stripe</strong>：決済処理サービス。Stripe社のプライバシーポリシーは<a href="https://stripe.com/jp/privacy" target="_blank" rel="noopener" class="text-singkana-300 hover:text-singkana-100 underline">こちら</a>をご確認ください。</li>
            <li><strong>ホスティングサービス</strong>：本サービスのサーバー運用のため</li>
          </ul>
          <p>これらの外部サービスがクッキー等を通じて情報を取得する可能性がありますが、取得される情報は各サービス提供者のプライバシーポリシーに従って管理されます。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">7. 情報の安全管理</h2>
          <p>本サービスは、取得した情報について、不正アクセス・漏えい・改ざん・滅失等を防止するため、以下の対策を講じています。</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>HTTPSによる通信の暗号化</li>
            <li>サーバーへのアクセス制限・認証</li>
            <li>レート制限による不正利用の防止</li>
            <li>OriginチェックによるCSRF対策</li>
            <li>定期的なセキュリティ監査</li>
          </ul>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">8. ユーザーの権利</h2>
          <p>1. ユーザーは、本サービスが保有する自己の個人情報について、開示・訂正・削除を求める権利を有します。</p>
          <p>2. 個人情報の開示・訂正・削除を希望される場合は、本サービス運営者までご連絡ください。連絡先：<a href="mailto:singkana.official@gmail.com" class="text-singkana-300 hover:text-singkana-100 underline">singkana.official@gmail.com</a></p>
          <p>3. 先行登録のメールアドレスについては、本サービス上から削除依頼を行うことができます。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">9. ポリシーの変更</h2>
          <p>本プライバシーポリシーの内容は、必要に応じて変更されることがあります。変更後のプライバシーポリシーは、本サービス上に掲載された時点から効力を生じるものとします。</p>

          <h2 class="text-xl font-semibold text-slate-100 mt-8 mb-4">10. お問い合わせ</h2>
          <p>本プライバシーポリシーに関するお問い合わせは、以下のメールアドレスまでご連絡ください。</p>
          <p>メールアドレス：<a href="mailto:singkana.official@gmail.com" class="text-singkana-300 hover:text-singkana-100 underline">singkana.official@gmail.com</a></p>

          <p class="text-sm text-slate-400 mt-8">制定日：2026年1月14日<br>最終更新日：2026年2月16日</p>
        </div>
      </div>
    </div>
  </section>
  <script>
    (function(){
      const wrap = document.getElementById("glassWrap");
      const card = document.getElementById("glassCard");
      if (!wrap || !card) return;

      wrap.style.pointerEvents = "auto";

      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      const maxTilt = 6;
      const maxMove = 6;
      let rafId = null;
      let lastX = 0;
      let lastY = 0;

      function setVars(moveX, moveY, tiltX, tiltY){
        card.style.setProperty("--glass-move-x", `${moveX}px`);
        card.style.setProperty("--glass-move-y", `${moveY}px`);
        card.style.setProperty("--glass-tilt-x", `${tiltX}deg`);
        card.style.setProperty("--glass-tilt-y", `${tiltY}deg`);
      }

      function onMove(e){
        lastX = e.clientX;
        lastY = e.clientY;
        if (rafId) return;
        rafId = requestAnimationFrame(() => {
          rafId = null;
          const r = wrap.getBoundingClientRect();
          const x = (lastX - r.left) / r.width;
          const y = (lastY - r.top) / r.height;

          const tiltY = clamp((x - 0.5) * 2 * maxTilt, -maxTilt, maxTilt);
          const tiltX = clamp((0.5 - y) * 2 * maxTilt, -maxTilt, maxTilt);

          const moveX = (x - 0.5) * 2 * maxMove;
          const moveY = (y - 0.5) * 2 * maxMove;
          setVars(moveX, moveY, tiltX, tiltY);
        });
      }

      function onLeave(){
        setVars(0, 0, 0, 0);
      }

      const isFine = window.matchMedia("(hover: hover) and (pointer: fine)").matches;
      if (isFine) {
        wrap.addEventListener("mousemove", onMove, { passive: true });
        wrap.addEventListener("mouseleave", onLeave, { passive: true });
      } else {
        setVars(0, 0, 0, 0);
      }

      wrap.addEventListener("click", () => {
        card.classList.toggle("is-flipped");
      }, { passive: true });

      wrap.style.webkitTapHighlightColor = "transparent";
    })();
  </script>
</body>
</html>
