<!doctype html>
<html lang="ja">
<head>
  <!-- =========================================================
  0) Basics
  ========================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>SingKANA β｜英語歌詞を“歌えるかな”に変換（発音・ブレス・ロングトーン対応）</title>
  <meta name="description" content="SingKANA（シンカナ）は、英語歌詞を“歌えるかな（カタカナ）”に変換するAIスタジオ。発音ガイド・ブレス位置・ロングトーンを可視化し、歌ってみた/練習/収録を高速化します。Global users? Check English LP at en.singkana.com" />
  
  <!-- (任意) canonical / OG / twitter は本番で追加推奨 -->
  <!-- <link rel="canonical" href="https://singkana.com/" /> -->


  <!-- =========================================================
  SEO / AEO Boost (Canonical, OpenGraph, Twitter, Robots, Hreflang)
  ========================================================== -->
  <link rel="canonical" href="https://singkana.com/" />

  <!-- 基本 -->
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="application-name" content="SingKANA" />

  <!-- Favicon (iOS Safari対策: フル指定 + キャッシュ分離 ?v=3) -->
  <link rel="shortcut icon" href="/assets/favicon/favicon.ico?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16.png?v=3">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch.png?v=3">

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="SingKANA" />
  <meta property="og:title" content="SingKANA β – 英語歌詞かな変換スタジオ" />
  <meta property="og:description" content="英語歌詞を“歌えるかな表記”に変換。発音ガイド/ブレス/ロングトーンまで可視化して、好きな曲を好きな言語で歌える世界へ。" />
  <meta property="og:url" content="https://singkana.com/" />
  <meta property="og:image" content="https://singkana.com/assets/og/singkana_og.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="ja_JP" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="SingKANA β – 英語歌詞かな変換スタジオ" />
  <meta name="twitter:description" content="英語歌詞を“歌えるかな表記”に変換。発音ガイド/ブレス/ロングトーンまで可視化。" />
  <meta name="twitter:image" content="https://singkana.com/assets/og/singkana_og.png" />

  <!-- 言語（将来 en ページができたら追加） -->
  <link rel="alternate" href="https://singkana.com/" hreflang="ja" />
  <link rel="alternate" href="https://singkana.com/" hreflang="x-default" />

  <!-- パフォーマンス（CDNに preconnect） -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin />
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />


  <!-- =========================================================
  1) Google Tag Manager (head)
  ========================================================== -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M33GP2KP');
  </script>

  <!-- =========================================================
  2) Theme / CSS (first: your theme switch, then Tailwind, then custom)
  ========================================================== -->
  <link rel="stylesheet" href="/assets/themes/theme.switch.css" />
  <script defer src="/assets/js/theme_manager.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            singkana: {
              50: '#f7f4ff',
              100: '#ede7ff',
              200: '#d9ceff',
              300: '#c0aeff',
              400: '#a184ff',
              500: '#8a5dff',
              600: '#7441f0',
              700: '#5c32c4',
              800: '#472898',
              900: '#362073'
            }
          },
          boxShadow: {
            soft: '0 18px 45px rgba(0,0,0,0.35)',
            glow: '0 0 40px rgba(138,93,255,0.45)'
          },
          backdropBlur: {
            xs: '2px'
          }
        }
      }
    };
  </script>

  <!-- Studio CSS -->
  <style>
    .error-banner {
      display: none;
      background: #ffe5e8;
      color: #a4001d;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .tab-btn {
      flex: 1;
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid transparent;
      color: #e5e7eb;
      background: transparent;
      transition: all 0.15s ease;
    }
    .tab-btn.active {
      background: rgba(148, 163, 255, 0.18);
      border-color: rgba(165, 180, 252, 0.6);
      color: #e0f2fe;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
    }

    .result-panel {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 10px;
      max-height: 320px;
      overflow: auto;
      font-size: 13px;
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.18), rgba(15, 23, 42, 0.95));
    }

    .result-block {
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }
    .result-block:hover {
      background: rgba(30, 64, 175, 0.3);
      border-color: rgba(129, 140, 248, 0.6);
    }
    .result-block.active {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(196, 181, 253, 0.95);
      box-shadow: 0 0 0 1px rgba(196, 181, 253, 0.75);
    }
    .line-head {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .result-en {
      font-size: 13px;
      color: #e5e7eb;
      white-space: pre-wrap;
    }
    .result-ka {
      font-size: 12px;
      color: #e9d5ff;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
      margin-top: 4px;
    }
    .feedback-status {
      font-size: 11px;
      margin-top: 4px;
    }

    .mini-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.35);
      color: #e5e7eb;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .mini-btn:hover { background: rgba(148,163,255,0.15); border-color: rgba(165,180,252,0.7); }
    .mini-select {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(2, 6, 23, 0.35);
      color: #e5e7eb;
      outline: none;
    }
    .mini-hint {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }
  </style>

  <!-- =========================================================
  Structured Data (JSON-LD) for SEO/AEO
  ========================================================== -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebSite",
        "@id": "https://singkana.com/#website",
        "url": "https://singkana.com/",
        "name": "SingKANA",
        "description": "英語歌詞を“歌えるかな表記”に変換するAIスタジオ。発音ガイド、ブレス位置、ロングトーン、ニュアンスまで可視化。",
        "inLanguage": "ja",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://singkana.com/?q={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      },
      {
        "@type": "SoftwareApplication",
        "@id": "https://singkana.com/#app",
        "name": "SingKANA",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Web",
        "url": "https://singkana.com/",
        "description": "英語歌詞を“歌えるかな表記”に変換。発音ガイド/ブレス/ロングトーンまで可視化して練習と収録を効率化。",
        "offers": [
          {
            "@type": "Offer",
            "name": "Free (Basic)",
            "price": "0",
            "priceCurrency": "JPY",
            "availability": "https://schema.org/InStock",
            "url": "https://singkana.com/#pricing"
          },
          {
            "@type": "Offer",
            "name": "Pro",
            "price": "0",
            "priceCurrency": "JPY",
            "availability": "https://schema.org/PreOrder",
            "url": "https://singkana.com/#pricing"
          }
        ]
      },
      {
        "@type": "FAQPage",
        "@id": "https://singkana.com/#faq",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "著作権は大丈夫ですか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "SingKANAは歌詞テキストの“かな変換”を行うツールです。歌詞そのものの権利は権利者に帰属します。利用規約と法令の範囲で、個人の練習用途を想定してご利用ください。"
            }
          },
          {
            "@type": "Question",
            "name": "スマホだけでも使えますか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "はい。ブラウザで利用できます。推奨は最新版のChrome / Safari / Edgeです。"
            }
          },
          {
            "@type": "Question",
            "name": "フィードバック送信はどこに届きますか？",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "現状は準備中です。API未接続のため送信に失敗する場合があります。"
            }
          }
        ]
      }
    ]
  </script>


</head>

<body data-theme="dark" class="bg-slate-950 text-slate-100 antialiased">

  <!-- =========================================================
  GTM (noscript)
  ========================================================== -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M33GP2KP"
      height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>

  <!-- 背景 -->
  <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 h-80 w-80 rounded-full bg-singkana-500/40 blur-3xl"></div>
    <div class="absolute top-40 -left-40 h-96 w-96 rounded-full bg-fuchsia-500/30 blur-3xl"></div>
    <div class="absolute bottom-[-10rem] right-[-5rem] h-80 w-80 rounded-full bg-cyan-400/20 blur-3xl"></div>
  </div>

  <!-- ヘッダ -->
  <header class="border-b border-white/5 bg-slate-950/70 backdrop-blur-sm sticky top-0 z-30">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img
          src="/assets/favicon/favicon-32.png"
          alt="SingKANA"
          class="h-7 w-7 rounded-xl"
        />
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-lg font-semibold tracking-wide">SingKANA</span>
            <span class="rounded-full border border-white/15 px-2 py-0.5 text-[10px] uppercase tracking-[0.2em] text-slate-300">beta</span>
            <!-- 開発者モードバッジ（条件付き表示） -->
            <span id="dev-pro-badge" class="hidden rounded-full border border-amber-400/50 bg-amber-500/20 px-2 py-0.5 text-[9px] font-medium text-amber-200 uppercase tracking-[0.1em]">
              DEV PRO ON
            </span>
          </div>
          <p class="text-xs text-slate-400">歌詞かな変換 AI スタジオ</p>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-7 text-sm text-slate-200">
        <a href="#about" class="hover:text-singkana-200 transition">SingKANAとは</a>
        <a href="#features" class="hover:text-singkana-200 transition">機能</a>
        <a href="#how-it-works" class="hover:text-singkana-200 transition">使い方</a>
        <a href="#romaji-beta" class="hover:text-singkana-200 transition">Romaji β</a>
        <a href="#pricing" class="hover:text-singkana-200 transition">料金</a>
        <a href="#faq" class="hover:text-singkana-200 transition">FAQ</a>
        <a href="https://en.singkana.com" target="_blank" rel="noopener" class="hover:text-singkana-200 transition border-l border-white/10 pl-4 ml-2">
          English Version
        </a>
        <a href="#studio" class="rounded-full border border-singkana-400/70 bg-slate-950/80 px-4 py-1.5 text-xs font-semibold text-singkana-100 shadow-soft hover:bg-singkana-500/10 hover:shadow-glow transition">
          かな変換を試す
        </a>
      </nav>
    </div>
  </header>

  <!-- =========================================================
  MAIN
  （導線の鉄則：Hero → 問題 → About → 機能 → 使い方 → 体験（Romaji/Studio） → 価格 → FAQ → CTA）
  ========================================================== -->
  <main class="mx-auto max-w-6xl px-4 pb-24 pt-10 space-y-28">

    <!-- HERO -->
    <section id="hero" class="grid gap-12 md:grid-cols-2 md:items-center">
      <div class="space-y-6">
        <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 shadow-soft backdrop-blur-xs">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
          好きな曲を「読めない」から一瞬で「歌える」に。
        </div>

        <div class="space-y-3">
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-semibold leading-tight">
            好きな歌を、<br />
            <span class="bg-gradient-to-r from-singkana-200 via-fuchsia-200 to-cyan-200 bg-clip-text text-transparent">
              好きな言語で歌える世界へ。
            </span>
          </h1>
          <p class="text-sm md:text-base text-slate-300 leading-relaxed">
            SingKANA（シンカナ）は、英語の歌詞を
            <span class="font-semibold text-singkana-100">“歌えるかな表記”</span>
            に変換するAIスタジオ。発音ガイド、ブレス位置、ロングトーン、ニュアンスまで可視化して、あなたの「歌いたい」をその場で「歌える」に変えます。
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <a href="#studio"
            class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition">
            無料でかな変換を試す
            <span class="text-xs">▶</span>
          </a>
          <a href="#romaji-beta"
            class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-950/80 px-5 py-2 text-xs font-medium text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
            日本語曲 → Romaji も試す
          </a>
        </div>

        <p class="text-[11px] text-slate-400">
          ブラウザだけで完結 / PC・スマホ対応 / Freeは1日3回まで
        </p>
      </div>

      <!-- Demo -->
      <div class="relative">
        <div class="absolute -top-6 -left-4 h-20 w-20 rounded-full border border-slate-500/30 bg-gradient-to-br from-slate-900/10 via-slate-900/40 to-slate-900/80 blur-2xl"></div>
        <div class="absolute -bottom-10 -right-6 h-28 w-28 rounded-full bg-gradient-to-tr from-fuchsia-500/30 via-singkana-400/20 to-cyan-300/20 blur-3xl"></div>

        <div class="relative rounded-3xl border border-white/10 bg-slate-900/70 p-5 shadow-soft backdrop-blur-sm">
          <div class="flex items-center justify-between mb-3">
            <div class="space-y-0.5">
              <p class="text-xs text-slate-300">Demo Project</p>
              <p class="text-sm font-semibold">EN → 歌えるかな</p>
            </div>
            <div class="flex items-center gap-1.5 text-[10px] text-slate-400">
              <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
              AI Studio Online
            </div>
          </div>

          <div class="grid gap-3 text-[11px]">
            <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-3">
              <p class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1.5">Original Lyrics</p>
              <p class="text-slate-200">
                Put your <span class="underline decoration-dotted">heart</span> on the line, we’ll be <span class="underline decoration-dotted">flying</span> tonight...
              </p>
            </div>

            <div class="rounded-2xl border border-singkana-400/40 bg-gradient-to-br from-slate-900/90 via-slate-900/70 to-slate-900/90 p-3 shadow-glow">
              <p class="text-[10px] uppercase tracking-[0.16em] text-slate-300 mb-1.5">SingKANA Output</p>
              <p class="font-medium text-slate-100 leading-relaxed">
                プッ ユア <span class="text-singkana-200">ハート</span> オン ザ ライン<br />
                ウィー ビー <span class="text-singkana-200">フライイン</span> トゥナイッ
              </p>
              <div class="mt-2 flex flex-wrap gap-1.5">
                <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">BR</span>
                <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">HLD</span>
                <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">VIB</span>
                <span class="rounded-full bg-slate-950/60 px-2 py-0.5 text-[9px] text-slate-200 border border-white/15">SLD</span>
              </div>
            </div>

            <p class="text-[10px] text-slate-400">
              ※ 実際の変換結果は楽曲やモードによって異なります。
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- 問題 -->
    <section id="problems" class="space-y-6">
      <h2 class="text-xl md:text-2xl font-semibold">
        歌いたい曲がある。<br class="hidden md:block" />
        でも「発音わからない」で止まってしまうあなたへ。
      </h2>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">英語歌詞のカタカナ起こしが地獄</p>
          <p class="text-xs text-slate-300">歌詞サイトを見ながら、一行ずつカタカナを書いていくだけで、練習前に疲れてしまう。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">発音・ブレス・ニュアンスが掴めない</p>
          <p class="text-xs text-slate-300">どこで息継ぎするか、どこを伸ばすか、どこを強く歌うかが分からず、不安なまま歌うことになる。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">歌ってみた制作の準備が面倒すぎる</p>
          <p class="text-xs text-slate-300">台本用に整理しているうちに録音時間がなくなる。本当は本番に時間を使いたい。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-sm font-medium text-slate-100">「歌える日本語」に落ちてこない</p>
          <p class="text-xs text-slate-300">翻訳や普通の表記だとリズムが崩れる。耳では分かるのに口に乗らない。</p>
        </div>
      </div>
      <p class="text-sm text-slate-200">
        これ、全部 <span class="font-semibold text-singkana-100">SingKANA が代わりにやります。</span>
      </p>
    </section>

    <!-- About -->
    <section id="about" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">
        言語の壁を越えて歌える、<br class="hidden md:block" />
        “歌詞翻訳ではない” 新しい体験。
      </h2>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed">
        SingKANA は英語歌詞を日本語かなに変換するだけのツールではありません。<br />
        <span class="font-semibold text-singkana-100">声が自然に乗る「歌いやすさ」</span>を基準に、
        発音バランス / 音節の区切り / 歌い方のニュアンスを整える音楽特化AIです。
      </p>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed">
        目指すのは「読める」ではなく <span class="font-semibold text-singkana-100">“歌えるかな”</span>。
        直訳や普通のカタカナより、声に出したときの気持ちよさを優先します。
      </p>
    </section>

    <!-- Features -->
    <section id="features" class="space-y-6">
      <h2 class="text-xl md:text-2xl font-semibold">SingKANA の主な機能</h2>

      <div class="grid gap-5 md:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">01 / Kana Engine</p>
          <h3 class="text-sm font-semibold text-slate-50">歌いやすさ優先のかな変換エンジン</h3>
          <p class="text-xs text-slate-300 leading-relaxed">文章としての正しさより、歌ったときにリズムが崩れないことを重視。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">02 / Marking</p>
          <h3 class="text-sm font-semibold text-slate-50">カラオケ風 “歌い方マーク”</h3>
          <p class="text-xs text-slate-300 leading-relaxed">視覚ガイドで練習効率を上げる（今後拡張）。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">03 / Web Studio</p>
          <h3 class="text-sm font-semibold text-slate-50">ブラウザだけで即利用</h3>
          <p class="text-xs text-slate-300 leading-relaxed">PC・スマホ対応。思い立った瞬間に変換して歌える。</p>
        </div>
      </div>
    </section>

    <!-- How -->
    <section id="how-it-works" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">使い方は、シンプルに 3 ステップ</h2>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 01</p>
          <h3 class="text-sm font-semibold text-slate-50">歌詞を用意</h3>
          <p class="text-xs text-slate-300">歌詞テキストをコピペ（βはファイルUPは今後）。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 02</p>
          <h3 class="text-sm font-semibold text-slate-50">ワンクリックでかな変換</h3>
          <p class="text-xs text-slate-300">ボタンを押すだけ。数秒で“歌えるかな歌詞”が完成。</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Step 03</p>
          <h3 class="text-sm font-semibold text-slate-50">そのまま練習 or 収録へ</h3>
          <p class="text-xs text-slate-300">コピー/TXT/SRTで台本としてすぐ使える。</p>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- Romaji (Beta) Section -->
    <!-- （Hero直下だと雑に見えるので、説明後に配置） -->
    <!-- ===================== -->
    <section id="romaji-beta" class="space-y-4">
      <div class="flex items-end justify-between flex-wrap gap-3">
        <div>
          <h2 class="text-xl md:text-2xl font-semibold">Romaji（β）</h2>
          <p class="text-sm text-slate-300 mt-2">
            日本語のアニソン歌詞を貼ると、<span class="font-semibold text-slate-100">歌いやすいローマ字</span>に変換します。
            海外勢向けの入口（MVP）として実装中です。
          </p>
        </div>
        <a href="#studio"
          class="rounded-full border border-white/15 bg-slate-950/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
          英語→かな変換も試す
        </a>
      </div>

      <div class="rounded-3xl border border-white/10 bg-slate-900/50 p-5 shadow-soft">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <p class="text-xs text-slate-300">入力（日本語歌詞）</p>
            <textarea id="romaji_in" rows="7"
              placeholder="Paste Japanese lyrics here&#10;例）残酷な天使のテーゼ&#10;少年よ神話になれ"
              class="w-full rounded-2xl border border-white/10 bg-slate-950/40 p-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80"></textarea>

            <div class="flex gap-2 flex-wrap items-center">
              <button id="romaji_go" type="button"
                class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-5 py-2 text-xs font-semibold text-white shadow-glow hover:brightness-110 transition">
                Convert
              </button>
              <button id="romaji_copy" type="button"
                class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-950/60 px-5 py-2 text-xs font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
                Copy
              </button>
              <span id="romaji_status" class="text-[11px] text-slate-400"></span>
            </div>
          </div>

          <div class="space-y-2">
            <p class="text-xs text-slate-300">出力（Romaji）</p>
            <textarea id="romaji_out" rows="7" readonly
              placeholder="Romaji output will appear here"
              class="w-full rounded-2xl border border-white/10 bg-slate-950/30 p-3 text-sm text-slate-100 placeholder:text-slate-600"></textarea>

            <p class="text-[11px] text-slate-400 leading-relaxed">
              ※ βは“読みやすいRomaji”に寄せています。将来、<span class="text-slate-200">リズム/伸ばし/息継ぎ</span>を最適化します。
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing -->
    <section id="pricing" class="space-y-6">
      <div class="flex items-end justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl md:text-2xl font-semibold text-slate-50">料金プラン</h2>
          <p class="text-sm text-slate-300 mt-2">
            Free は <span class="font-semibold text-slate-100">1日3回まで</span>。<span class="font-semibold text-slate-100">Basic / Natural</span> のみ利用可能。<span class="font-semibold text-singkana-100">精密（日本語歌唱最適）</span> は Pro で解放されます。
          </p>
        </div>

        <a href="#studio"
          class="rounded-full border border-white/15 bg-slate-950/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
          まず無料で試す（Basic）
        </a>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 shadow-soft">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Free</p>
          <p class="text-sm text-slate-300 mt-2">まずは体験したい方向け。</p>
          <div class="mt-4">
            <p class="text-2xl font-semibold text-slate-50">¥0</p>
            <p class="text-[11px] text-slate-400 mt-1">1日3回まで</p>
          </div>
          <ul class="mt-4 space-y-2 text-xs text-slate-200">
            <li>✅ Basic（読むためのカタカナ）</li>
            <li>✅ Natural（英語っぽく歌う）</li>
            <li>✅ 比較UIで違いを確認</li>
            <li>✅ 登録不要で即利用</li>
            <li class="text-slate-400">❌ Precise（日本語として歌う・最適）</li>
          </ul>

          <a href="#studio"
            class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition">
            無料で試す
          </a>
        </div>

        <div class="rounded-2xl border border-singkana-400/30 bg-slate-950/60 p-5 shadow-glow">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-singkana-100">Pro</p>
          <p class="text-sm text-slate-300 mt-2">本格的に歌える形に仕上げたい方向け。</p>

          <div class="mt-4">
            <p class="text-2xl font-semibold text-slate-50">¥980</p>
            <p class="text-[11px] text-slate-400 mt-1">月額 / 無制限変換</p>
          </div>

          <ul class="mt-4 space-y-2 text-xs text-slate-200">
            <li>✅ 歌唱最適化（精密）モード</li>
            <li>✅ 無制限変換（回数制限なし）</li>
            <li>✅ 歌いやすさスコア表示</li>
            <li>✅ ブロック境界（息継ぎ位置）表示</li>
            <li>✅ 制作・録音用途に最適</li>
          </ul>

          <!-- API仕様に合わせておく（※今は閉鎖中の文言で制御） -->
          <a href="#"
            onclick="alert('Proは現在βテスト中のため一時閉鎖しています。'); return false;"
            class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-singkana-500/20 px-4 py-2 text-xs font-semibold text-singkana-100 border border-singkana-400/40 hover:bg-singkana-500/25 transition">
            Pro を開始（β テスト中につき閉鎖中）
          </a>

          <p class="text-[11px] text-slate-400 mt-2">
            ※ 自動更新・いつでも解約できます
          </p>
          
          <div class="mt-4 pt-4 border-t border-singkana-400/20">
            <p class="text-[11px] font-semibold text-singkana-200 mb-1">
              🎁 早期ユーザー特典
            </p>
            <p class="text-[10px] text-slate-400 leading-relaxed">
              正式リリース前に登録いただいた方には、Proアクセスを特別価格でご提供予定です。
            </p>
          </div>
        </div>

        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 shadow-soft">
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">Studio / School</p>
          <p class="text-sm text-slate-300 mt-2">教室・スタジオ導入向け。</p>
          <ul class="mt-4 space-y-2 text-xs text-slate-200">
            <li>✅ 複数人運用</li>
            <li>✅ 管理・請求の一括化</li>
            <li>✅ カスタム要件相談</li>
          </ul>
          <a href="/#contact"
            class="mt-5 inline-flex w-full items-center justify-center rounded-xl bg-slate-100/10 px-4 py-2 text-xs font-semibold text-slate-50 border border-white/10 hover:bg-slate-100/15 transition">
            お問い合わせ
          </a>
        </div>
      </div>

      <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-5">
        <p class="text-sm font-semibold text-slate-50">Free と Pro の違い</p>
        <div class="mt-4 overflow-x-auto">
          <table class="min-w-[560px] w-full text-xs">
            <thead>
              <tr class="text-slate-400">
                <th class="text-left py-2 pr-3 font-semibold">項目</th>
                <th class="text-left py-2 pr-3 font-semibold">Free（Basic）</th>
                <th class="text-left py-2 pr-3 font-semibold">Pro</th>
              </tr>
            </thead>
            <tbody class="text-slate-200">
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">価格</td><td class="py-2 pr-3">¥0</td><td class="py-2 pr-3">¥980/月</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">変換回数</td><td class="py-2 pr-3">1日3回まで</td><td class="py-2 pr-3">無制限</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">変換モード</td><td class="py-2 pr-3">Basic / Natural</td><td class="py-2 pr-3">Basic + Natural + Precise</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">精密（日本語歌唱最適）</td><td class="py-2 pr-3">—</td><td class="py-2 pr-3">✅</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">歌いやすさスコア</td><td class="py-2 pr-3">—</td><td class="py-2 pr-3">✅</td>
              </tr>
              <tr class="border-t border-white/10">
                <td class="py-2 pr-3">録音・制作向け</td><td class="py-2 pr-3">△</td><td class="py-2 pr-3">◎</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">よくある質問</h2>
      <div class="space-y-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. 著作権は大丈夫ですか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            SingKANA は「歌詞テキストのかな変換」ツールです。歌詞そのものの権利は権利者に帰属します。利用規約と法令の範囲で使用してください。
          </p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. スマホだけでも使えますか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            はい。ブラウザで使えます。推奨は最新版の Chrome / Safari / Edge。
          </p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-50 mb-1">Q. フィードバック送信はどこに届きますか？</p>
          <p class="text-xs text-slate-300 leading-relaxed">
            現状は準備中です（API未接続）。テキスト欄は今後のために残しています。
          </p>
        </div>
      </div>
    </section>

    <!-- Studio -->
    <section id="studio" class="space-y-5">
      <h2 class="text-xl md:text-2xl font-semibold">かな変換スタジオ（β版）</h2>
      <p class="text-sm text-slate-300">
        下のスタジオで、実際に英語の歌詞を「歌えるかな」に変換してみてください。
      </p>

      <div class="mt-2 rounded-3xl border border-singkana-400/40 bg-slate-950/80 p-5 shadow-glow">
        <p class="text-sm text-slate-200 font-semibold mb-2">SingKANA β</p>
        <p class="text-xs text-slate-400 mb-4">
          変換処理はお使いのブラウザ内のみで行われます（※現在のβ仕様）。
        </p>

        <div id="error-banner" class="error-banner"></div>

        <div class="grid gap-4 md:grid-cols-2">
          <!-- 左：入力 -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-4 space-y-3">
            <h3 class="text-sm font-semibold text-slate-50">歌詞入力</h3>

            <div class="space-y-1">
              <label for="song-title" class="block text-xs text-slate-200">1. 曲名（任意）</label>
              <input
                id="song-title"
                type="text"
                placeholder="例）golden"
                class="w-full rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80"
              />
            </div>

            <div class="space-y-1">
              <label for="lyrics-input" class="block text-xs text-slate-200">2. 歌詞を貼り付け</label>
              <textarea
                id="lyrics-input"
                placeholder="I was a ghost, I was alone, hah&#10;..."
                class="w-full min-h-[160px] rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80 font-mono leading-relaxed"
              ></textarea>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button type="button" class="mini-btn" onclick="saveStudioState()">💾 保存</button>
              <button type="button" class="mini-btn" onclick="restoreStudioState()">↩ 復元</button>
              <button type="button" class="mini-btn" onclick="clearStudioState()">🧹 クリア</button>

              <span class="mx-1 h-4 w-px bg-white/15"></span>

              <label class="mini-hint">例文：</label>
              <button type="button" class="mini-btn" onclick="insertExample('fast')" title="速い英語（詰むやつ）">⚡ 速い英語</button>
              <button type="button" class="mini-btn" onclick="insertExample('consonant')" title="子音連打（k/t/s）">🔤 子音連打</button>
              <button type="button" class="mini-btn" onclick="insertExample('vowel')" title="長母音（fly/line/night系）">🎵 長母音</button>

              <span class="mx-1 h-4 w-px bg-white/15"></span>

              <label class="mini-hint">テンプレ：</label>
              <select id="template-select" class="mini-select" onchange="applyTemplateFromSelect()">
                <option value="">選択…</option>
                <option value="warmup">ウォームアップ（短文）</option>
                <option value="chorus">サビ練習（汎用）</option>
                <option value="speech">語尾・子音の練習</option>
              </select>

              <span id="studio-status" class="text-[11px] text-slate-400 ml-auto"></span>
            </div>

            <button
              class="primary-btn inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-5 py-2 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition"
              type="button"
              onclick="convertLyrics()"
            >
              <span class="icon text-xs">▶</span>
              <span>この歌詞で変換する</span>
            </button>

            <p class="text-[11px] text-slate-400 mt-3 leading-relaxed">
              入力されたテキストは端末内のみで処理されます。サーバーには送信されません。<br />
              商用楽曲の歌詞は著作権で保護されています。本サービスは<strong>個人の練習用途</strong>を想定しています。
            </p>
          </div>

          <!-- 右：結果 -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-4 space-y-3">
            <div class="flex gap-2 mb-1">
              <button class="tab-btn active" data-tab="result">変換結果</button>
              <button class="tab-btn" data-tab="feedback">フィードバック</button>
            </div>

            <div id="tab-result" class="tab-panel active space-y-2">
              <p class="text-[11px] text-slate-400">
                各行をタップすると、その行だけハイライトされ、音声読み上げでかなを再生します（対応ブラウザのみ）。
              </p>

              <div class="flex flex-wrap items-center gap-2">
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="copyKanaOnly()">📋 かなだけコピー</button>

                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="copyEnKana()">📋 EN+かなコピー</button>

                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="downloadTxt()">⬇ TXT</button>

                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="downloadSrt()">⬇ SRT(簡易)</button>

                <label for="displayMode" class="inline-flex items-center gap-2 text-[11px] text-slate-300 select-none">
                  表示
                  <select id="displayMode" 
                    class="rounded-full bg-slate-950/60 border border-slate-600 px-3 py-1 text-[11px] text-slate-100">
                    <option value="basic">ベーシック（読むためのカタカナ）</option>
                    <option value="natural" selected>ナチュラル（英語っぽく歌う・英語感を残したい人向け）</option>
                    <option value="precise">精密（日本語として歌う・最適・失敗したくない人向け）</option>
                  </select>
                </label>

                <span class="mx-1 h-4 w-px bg-white/15"></span>

                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="prevLine()">◀ 前</button>

                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-3 py-1.5 text-[11px] font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                  onclick="nextLine()">次 ▶</button>

                <label class="ml-1 inline-flex items-center gap-2 text-[11px] text-slate-300 select-none">
                  <input id="auto-scroll" type="checkbox" class="accent-indigo-400" checked />
                  自動追従
                </label>

                <span id="export-status" class="text-[11px] text-slate-400 ml-auto"></span>
              </div>

              <div id="result-panel" class="result-panel">
                <p style="font-size:12px;color:#cbd5f5;">
                  歌詞を入力して「この歌詞で変換する」を押すと、ここに結果が表示されます。
                </p>
              </div>
            </div>

            <div id="tab-feedback" class="tab-panel hidden">
              <p class="text-xs font-semibold text-slate-100 mb-1">フィードバック</p>
              <p class="text-[11px] text-slate-400 mb-2">
                ※歌詞そのもののコピー＆ペーストはお控えください（行番号＋コメント推奨）。
              </p>
              <textarea
                id="feedback-text"
                placeholder="例）#12 の「believe」のところ、もう少し伸ばした表記だと歌いやすい。"
                class="w-full min-h-[120px] rounded-xl border border-slate-600 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-singkana-400/80"
              ></textarea>
              <button
                class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100/10 px-4 py-1.5 text-xs font-semibold text-slate-50 border border-slate-500 hover:bg-slate-100/20 transition"
                type="button"
                onclick="sendFeedback()"
              >
                <span class="icon text-xs">✉</span>
                <span>フィードバックを送信</span>
              </button>
              <div id="feedback-status" class="feedback-status text-[11px] text-slate-300 mt-1"></div>

              <div class="text-[11px] text-slate-400 mt-3">
                <a href="/terms.html" target="_blank" class="underline">利用規約</a> ・
                <a href="/privacy.html" target="_blank" class="underline">プライバシーポリシー</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section id="cta-bottom" class="space-y-4 pt-8 border-t border-white/10">
      <h2 class="text-xl md:text-2xl font-semibold">「歌いたい」を、今日「歌えた」に変える。</h2>
      <p class="text-sm md:text-base text-slate-300 leading-relaxed">
        英語が読めなくても、発音が苦手でも、あなたの声はもっと自由に歌える。<br />
        SingKANA は <span class="font-semibold text-singkana-100">“音楽と言語の境界線” を溶かす</span>ためのAIです。
      </p>
      <div class="flex flex-wrap items-center gap-3">
        <a href="#studio"
          class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition">
          無料でかな変換を試す
        </a>
        <a href="#hero"
          class="inline-flex items-center justify-center gap-2 rounded-full border border-white/20 bg-slate-950/80 px-5 py-2 text-xs font-medium text-slate-100 hover:border-singkana-300/70 hover:text-singkana-100 transition">
          ページの先頭に戻る
        </a>
      </div>
    </section>
  </main>

  <footer class="border-t border-white/10 bg-slate-950/80">
    <div class="mx-auto max-w-6xl px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-2">
      <p class="text-[11px] text-slate-500">© <span id="year"></span> SingKANA. All rights reserved.</p>
      <div class="flex items-center gap-4">
        <a href="https://en.singkana.com" target="_blank" rel="noopener" class="text-[11px] text-slate-400 hover:text-singkana-200 transition">
          Global users? Check English LP here →
        </a>
        <p class="text-[11px] text-slate-500">Powered by Sovereign Cognitive Architecture.</p>
      </div>
    </div>
  </footer>

  <!-- =========================================================
  Scripts (bottom)
  - core.js (依存)
  - page scripts (あなたのロジックを整理して1箇所に集約)
  ========================================================== -->
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Language Detection & Auto-Redirect (英語ユーザーをen.singkana.comへ) -->
  <script>
    (function() {
      // URLパラメータで ?lang=ja があればリダイレクトしない
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('lang') === 'ja') {
        return;
      }
      
      // ブラウザ言語が英語系の場合、en.singkana.comへリダイレクト
      const browserLang = navigator.language || navigator.userLanguage;
      const isEnglish = browserLang.startsWith('en');
      
      // 現在のドメインが singkana.com で、英語ユーザーの場合のみリダイレクト
      if (isEnglish && window.location.hostname === 'singkana.com' && !window.location.hostname.includes('en.')) {
        window.location.href = 'https://en.singkana.com' + window.location.pathname + window.location.search;
      }
    })();
  </script>

  <!-- クライアントサイド変換エンジン -->
  <script src="/singkana_core.js"></script>

  <script>
    // =========================
    // Global State
    // =========================
    window.currentConvertedLines = [];  // ← displayMode再描画のため、グローバルに確実に置く
    window.activeIndex = -1;
    let currentActiveBlock = null;

    // =========================
    // Plan Gate (Free / Pro)
    // =========================
    const PLAN = {
      tier: "free", // "free" | "pro"
      devProOverride: false // 開発者モードフラグ
    };

    function isPro() {
      return PLAN.tier === "pro";
    }

    // 開発者モード状態を取得（ページ読み込み時）
    async function loadUserPlan() {
      try {
        // URLパラメータから dev_pro トークンを取得
        const urlParams = new URLSearchParams(window.location.search);
        const devProToken = urlParams.get("dev_pro");
        
        // dev_pro トークンがある場合は /api/me に渡す
        const apiUrl = devProToken ? `/api/me?dev_pro=${encodeURIComponent(devProToken)}` : "/api/me";
        
        const res = await fetch(apiUrl);
        const data = await res.json();
        console.log("[loadUserPlan] API response:", data); // デバッグ用
        
        if (data.ok) {
          PLAN.tier = data.plan || "free";
          PLAN.devProOverride = data.dev_pro_override || false;
          
          console.log("[loadUserPlan] PLAN:", PLAN); // デバッグ用
          
          // 開発者モードバッジを表示
          const badge = document.getElementById("dev-pro-badge");
          console.log("[loadUserPlan] Badge element:", badge); // デバッグ用
          
          if (badge) {
            if (PLAN.devProOverride) {
              console.log("[loadUserPlan] Showing badge"); // デバッグ用
              badge.classList.remove("hidden");
            } else {
              console.log("[loadUserPlan] Hiding badge"); // デバッグ用
              badge.classList.add("hidden");
            }
          } else {
            console.warn("[loadUserPlan] Badge element not found!");
          }
          
          // 精密モードの選択肢を更新（Freeの場合は無効化）
          const preciseOption = document.querySelector('#displayMode option[value="precise"]');
          if (preciseOption) {
            if (isPro()) {
              preciseOption.removeAttribute('disabled');
              preciseOption.textContent = '精密（日本語として歌う・最適・失敗したくない人向け）';
            } else {
              preciseOption.setAttribute('disabled', 'disabled');
              preciseOption.textContent = '精密（日本語として歌う・最適・失敗したくない人向け） [Pro]';
            }
          }
        }
      } catch (e) {
        console.warn("Failed to load user plan:", e);
      }
    }

    function guardDisplayMode(mode) {
      if (isPro()) return true;

      // Freeでは精密モードのみ制限（Naturalは利用可能）
      if (mode === "precise") {
        alert("精密モード（日本語として歌う・最適）は Pro プランで利用できます。\n\nFree では Basic / Natural が利用可能です（1日3回まで）。");
        const sel = document.getElementById("displayMode");
        if (sel) sel.value = "natural"; // Naturalに戻す
        return false;
      }
      return true;
    }

    // =========================
    // Tabs
    // =========================
    document.addEventListener("DOMContentLoaded", () => {
      // ユーザープラン（開発者モード含む）を読み込み
      loadUserPlan();
      
      const tabButtons = document.querySelectorAll(".tab-btn");
      const panels = {
        result: document.getElementById("tab-result"),
        feedback: document.getElementById("tab-feedback"),
      };

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.toggle("active", b === btn));
          Object.entries(panels).forEach(([key, panel]) => {
            const active = key === tab;
            panel.classList.toggle("active", active);
            panel.classList.toggle("hidden", !active);
          });
        });
      });

      // 起動時に復元（localStorage）
      restoreStudioState(true);

      // 自動保存
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");

      let t = null;
      function scheduleAutoSave(){
        if (t) clearTimeout(t);
        t = setTimeout(() => saveStudioState(true), 450);
      }
      [songEl, lyrEl, fbEl].forEach(el => {
        if (!el) return;
        el.addEventListener("input", scheduleAutoSave);
        el.addEventListener("change", scheduleAutoSave);
      });

      // DisplayMode restore/persist
      const dm = document.getElementById("displayMode");
      if (dm) {
        const saved = localStorage.getItem("displayMode");
        if (saved) dm.value = saved;
        dm.addEventListener("change", () => {
          const mode = dm.value;
          if (!guardDisplayMode(mode)) return;

          try { localStorage.setItem("displayMode", mode); } catch(e){}
          __displayModeChangeHandler();
        });


        }
      });
    // =========================
    // Romaji (API)
    // =========================
    (function(){
      const $in = document.getElementById("romaji_in");
      const $out = document.getElementById("romaji_out");
      const $go = document.getElementById("romaji_go");
      const $copy = document.getElementById("romaji_copy");
      const $st = document.getElementById("romaji_status");

      if (!$in || !$out || !$go || !$copy || !$st) return;

      async function convert(){
        const text = ($in.value || "").trim();
        if(!text){ $st.textContent = "歌詞を貼ってください"; return; }
        $st.textContent = "変換中…";
        $out.value = "";

        try{
          const res = await fetch("/api/romaji", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({text})
          });
          const j = await res.json().catch(()=> ({}));
          if(!res.ok || !j.ok){
            $st.textContent = "エラー: " + (j.error || res.status);
            return;
          }
          $out.value = j.romaji || "";
          $st.textContent = "完了";
        }catch(e){
          $st.textContent = "ネットワークエラー";
        }
      }

      async function copy(){
        const v = ($out.value || "").trim();
        if(!v){ $st.textContent = "コピーする内容がありません"; return; }
        try{
          await navigator.clipboard.writeText(v);
          $st.textContent = "コピーしました";
        }catch(e){
          $st.textContent = "コピー失敗（ブラウザ制限）";
        }
      }

      $go.addEventListener("click", convert);
      $copy.addEventListener("click", copy);
    })();

    // =========================
    // Studio Save/Restore/Templates
    // =========================
    const LS_KEY = "singkana.studio.v1";
    const TEMPLATES = {
      warmup: { title: "warmup", lyrics: ["Take it easy, keep it steady","Breathe in slow, breathe out ready","Hold the note and let it glow"].join("\n") },
      chorus: { title: "chorus-practice", lyrics: ["We are rising, we are shining","In the night, we keep on flying","Let it go, and sing it loud"].join("\n") },
      speech: { title: "consonants", lyrics: ["Just a little bit, step by step","Keep the beat, don't stop, don't slip","Bright light, night ride, right side"].join("\n") }
    };

    function setStudioStatus(msg) {
      const el = document.getElementById("studio-status");
      if (!el) return;
      el.textContent = msg || "";
      if (msg) setTimeout(() => { el.textContent = ""; }, 2200);
    }

    function readStudioStateFromUI() {
      const song = (document.getElementById("song-title")?.value || "").toString();
      const lyrics = (document.getElementById("lyrics-input")?.value || "").toString();
      const feedback = (document.getElementById("feedback-text")?.value || "").toString();
      return { song, lyrics, feedback, ts: new Date().toISOString() };
    }

    function writeStudioStateToUI(st) {
      if (!st) return;
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");
      if (songEl && typeof st.song === "string") songEl.value = st.song;
      if (lyrEl && typeof st.lyrics === "string") lyrEl.value = st.lyrics;
      if (fbEl && typeof st.feedback === "string") fbEl.value = st.feedback;
    }

    function saveStudioState(silent=false) {
      try {
        const st = readStudioStateFromUI();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        if (!silent) setStudioStatus("保存しました");
      } catch (e) {
        console.warn(e);
        if (!silent) setStudioStatus("保存に失敗（localStorage不可）");
      }
    }

    function restoreStudioState(silent=false) {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) { if (!silent) setStudioStatus("保存データなし"); return; }
        const st = JSON.parse(raw);
        writeStudioStateToUI(st);
        if (!silent) setStudioStatus("復元しました");
      } catch (e) {
        console.warn(e);
        if (!silent) setStudioStatus("復元に失敗");
      }
    }

    function clearStudioState() {
      try { localStorage.removeItem(LS_KEY); } catch (e) {}
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      const fbEl   = document.getElementById("feedback-text");
      if (songEl) songEl.value = "";
      if (lyrEl) lyrEl.value = "";
      if (fbEl) fbEl.value = "";
      setStudioStatus("クリアしました");
    }

    function applyTemplateFromSelect() {
      const sel = document.getElementById("template-select");
      const key = sel ? sel.value : "";
      if (!key) return;
      const t = TEMPLATES[key];
      if (!t) return;
      const songEl = document.getElementById("song-title");
      const lyrEl  = document.getElementById("lyrics-input");
      if (songEl) songEl.value = t.title;
      if (lyrEl)  lyrEl.value = t.lyrics;
      saveStudioState(true);
      setStudioStatus("テンプレ適用");
    }

    // =========================
    // Export helpers
    // =========================
    function setStatus(msg) {
      const el = document.getElementById("export-status");
      if (!el) return;
      el.textContent = msg || "";
      if (msg) setTimeout(() => { el.textContent = ""; }, 2200);
    }
    function getSongTitleSafe() {
      const t = (document.getElementById("song-title")?.value || "").trim();
      return t ? t.replace(/[\\\/:*?"<>|]/g, "_") : "singkana";
    }
    function fmt2(n){ return String(n).padStart(2,"0"); }
    function secToSrtTime(sec){
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      const ms = Math.floor((sec - Math.floor(sec)) * 1000);
      return `${fmt2(h)}:${fmt2(m)}:${fmt2(s)},${String(ms).padStart(3,"0")}`;
    }
    function buildKanaOnlyText() {
      if (!window.currentConvertedLines.length) return "";
      return window.currentConvertedLines.map(x => (x.kana || "").trim()).filter(Boolean).join("\n");
    }
    function buildEnKanaText() {
      if (!window.currentConvertedLines.length) return "";
      return window.currentConvertedLines.map(x => {
        const en = (x.en || "").trim();
        const ka = (x.kana || "").trim();
        const no = x.lineNo ? `#${x.lineNo}` : "";
        return `${no} ${en}\n${ka}`.trim();
      }).join("\n\n");
    }
    async function copyTextToClipboard(text) {
      if (!text) { setStatus("コピーする内容がありません"); return; }
      try {
        await navigator.clipboard.writeText(text);
        setStatus("コピーしました");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        setStatus("コピーしました");
      }
    }
    function downloadBlob(filename, content, mime) {
      const blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function copyKanaOnly(){ copyTextToClipboard(buildKanaOnlyText()); }
    function copyEnKana(){ copyTextToClipboard(buildEnKanaText()); }
    function downloadTxt(){
      const text = buildEnKanaText();
      if (!text) { setStatus("出力がありません"); return; }
      downloadBlob(`${getSongTitleSafe()}_singkana.txt`, text + "\n", "text/plain;charset=utf-8");
      setStatus("TXTを保存しました");
    }
    function downloadSrt(){
      if (!window.currentConvertedLines.length) { setStatus("出力がありません"); return; }
      const dur = 2.2;
      let t = 0;
      let idx = 1;
      const srt = window.currentConvertedLines.map(line => {
        const text = (line.kana || line.en || "").trim();
        const start = secToSrtTime(t);
        const end = secToSrtTime(t + dur);
        t += dur;
        return `${idx++}\n${start} --> ${end}\n${text}\n`;
      }).join("\n");
      downloadBlob(`${getSongTitleSafe()}_singkana.srt`, srt, "text/plain;charset=utf-8");
      setStatus("SRT(簡易)を保存しました");
    }

    // =========================
    // Highlight / Speak
    // =========================
    function setActiveBlock(block) {
      if (currentActiveBlock && currentActiveBlock !== block) currentActiveBlock.classList.remove("active");
      currentActiveBlock = block;
      if (block) block.classList.add("active");
    }
    function scrollActiveIntoView() {
      const chk = document.getElementById("auto-scroll");
      if (chk && !chk.checked) return;
      if (currentActiveBlock) currentActiveBlock.scrollIntoView({ block: "center", behavior: "smooth" });
    }
    function speakKana(text) {
      if (!text || !text.trim()) return;
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const voices = window.speechSynthesis.getVoices();
      const jpVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith("ja"));
      if (jpVoice) utter.voice = jpVoice;
      window.speechSynthesis.speak(utter);
    }
    function setActiveIndex(i){
      if (!window.currentConvertedLines.length) return;
      window.activeIndex = Math.max(0, Math.min(i, window.currentConvertedLines.length - 1));
      const target = document.querySelector(`.result-block[data-line-no="${window.currentConvertedLines[window.activeIndex].lineNo}"]`);
      if (target) {
        setActiveBlock(target);
        const line = window.currentConvertedLines[window.activeIndex];
        const speakText = (line.kana && line.kana.trim()) ? line.kana : (line.en || "");
        speakKana(speakText);
        scrollActiveIntoView();
      }
    }
    function nextLine(){ if (window.currentConvertedLines.length) setActiveIndex((window.activeIndex < 0 ? 0 : window.activeIndex + 1)); }
    function prevLine(){ if (window.currentConvertedLines.length) setActiveIndex((window.activeIndex < 0 ? 0 : window.activeIndex - 1)); }

    // =========================
    // Display Layer
    // =========================
    function __getDisplayMode(){
      const el = document.getElementById("displayMode");
      return el ? el.value : "basic";
    }
    function renderDisplay(coreText, mode){
      if (!coreText) return "";
      
      let t = String(coreText);
      t = t.replace(/\[.*?\]/g, "");
      t = t.replace(/\(.*?\)/g, "");
      t = t.replace(/[|\/]/g, "");
      // 区切り記号を統一（カンマを「｜」に置換）
      t = t.replace(/[,，]/g, "｜");
      
      if (mode === "precise") {
        return t.trim();
      }

      if (mode === "basic") {
        t = t.replace(/\s+/g, " ").trim();
        t = t.replace(/([ぁ-んァ-ヶ一-龠々〆ヵヶ])\s+([ぁ-んァ-ヶ一-龠々〆ヵヶ])/g, "$1$2");
        t = t.replace(/\s+([、。！？])/g, "$1");
        t = t.replace(/([、。！？])\s+/g, "$1");
        t = t.replace(/ー{2,}/g, "ー");
        t = t.replace(/っ\s+([ぁ-んァ-ヶA-Za-z])/g, "っ$1");
        t = t.replace(/\s{2,}/g, " ");
        return t.trim();
      }

      t = t.replace(/\s+/g, " ");
      t = t.replace(/([、。！？])\s*/g, "$1 ");
      t = t.replace(/([ぁ-ん]{10,})/g, (m) => {
        const chunks = [];
        for (let i = 0; i < m.length; i += 5) chunks.push(m.slice(i, i + 5));
        return chunks.join(" ");
      });
      t = t.replace(/\s{2,}/g, " ");
      return t.trim();
    }

    function __displayModeChangeHandler(){
      if (!window.currentConvertedLines.length) return;
      const mode = __getDisplayMode();
      
      // モード切替時に結果が変わることを視覚的に示す（軽いアニメーション）
      const textDivs = document.querySelectorAll(".result-ka");
      textDivs.forEach((textDiv, i) => {
        // フェードアウト
        textDiv.style.opacity = "0.3";
        textDiv.style.transition = "opacity 0.15s ease";
        
        setTimeout(() => {
          const line = window.currentConvertedLines[i];
          if (textDiv && line) {
            // 比較UIの場合は差分ハイライトを適用
            const block = textDiv.closest(".rounded-lg, .rounded-xl");
            const isSingkana = block && block.classList.contains("border-singkana-400");
            
            if (isSingkana && line.standard) {
              // SingKANA版: 差分ハイライトを適用
              let highlighted = highlightDifferences(line.standard, line.singkana || "");
              if (isPro()) {
                highlighted = addBreathMarks(highlighted);
              }
              textDiv.innerHTML = renderDisplay(highlighted, mode);
            } else {
              // Standard版または通常表示
              textDiv.textContent = renderDisplay(line.kana || line.singkana || line.standard || "", mode);
            }
            
            // フェードイン
            textDiv.style.opacity = "1";
          }
        }, 100);
      });
      
      // モードバッジを更新（SingKANA側のブロックのみ）
      document.querySelectorAll(".border-singkana-400").forEach((block) => {
        const labelDiv = block.querySelector(".flex.items-center.gap-1.5");
        if (labelDiv) {
          // 既存のバッジを削除（ラベルテキスト以外のspan要素）
          const badges = labelDiv.querySelectorAll("span.inline-flex.items-center");
          badges.forEach(badge => badge.remove());
          
          // 新しいバッジを追加
          const badge = document.createElement("span");
          if (mode === "precise") {
            badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-purple-500/15 border border-purple-400/25 text-[8px] font-medium text-purple-200/80";
            badge.innerHTML = "🟪<span class=\"hidden md:inline\"> 日本語歌唱最適化</span>";
          } else if (mode === "natural") {
            badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-green-500/15 border border-green-400/25 text-[8px] font-medium text-green-200/80";
            badge.innerHTML = "🟩<span class=\"hidden md:inline\"> 英語リズム保持</span>";
          } else {
            badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-singkana-500/10 border border-singkana-400/20 text-[8px] font-medium text-singkana-200/70";
            badge.innerHTML = "🎤<span class=\"hidden md:inline\"> 歌唱向け</span>";
          }
          labelDiv.appendChild(badge);
          
          // 見出しテキストを更新
          const labelText = labelDiv.querySelector("span.text-\\[10px\\], span.text-singkana-100");
          if (labelText) {
            let newLabel, newShortLabel;
            if (mode === "precise") {
              newLabel = "日本語として歌えるカタカナ（最適）";
              newShortLabel = "日本語として歌える";
            } else if (mode === "natural") {
              newLabel = "英語っぽく歌えるカタカナ";
              newShortLabel = "英語っぽく歌える";
            } else {
              newLabel = "読むためのカタカナ";
              newShortLabel = "読むためのカタカナ";
            }
            labelText.innerHTML = `<span class="hidden md:inline">${newLabel}</span><span class="md:hidden">${newShortLabel}</span>`;
          }
        }
      });
    }

    // =========================
    // Convert (クライアントサイド一発変換 + 2段比較表示)
    // =========================
    function convertLyrics() {
      const errorBanner = document.getElementById("error-banner");
      const resultPanel = document.getElementById("result-panel");
      const lyrics = document.getElementById("lyrics-input").value || "";

      if (errorBanner) {
        errorBanner.style.display = "none";
        errorBanner.textContent = "";
      }

      if (!lyrics.trim()) {
        if (resultPanel) {
          resultPanel.innerHTML = "<p style='font-size:12px;color:#cbd5f5;'>歌詞を入力してください。</p>";
        }
        return;
      }

      // SingKanaCoreが読み込まれているか確認
      if (!window.SingKanaCore || !window.SingKanaCore.convertLyrics) {
        console.error("[convertLyrics] SingKanaCore is not loaded");
        if (errorBanner) {
          errorBanner.textContent = "変換エンジンが読み込まれていません。ページを再読み込みしてください。";
          errorBanner.style.display = "block";
        }
        if (resultPanel) {
          resultPanel.innerHTML = "<p style='font-size:12px;color:#ff6b6b;'>変換エンジンが読み込まれていません。ページを再読み込みしてください。</p>";
        }
        return;
      }

      let lines;
      try {
        // クライアントサイドで即座に変換（一発変換）
        lines = window.SingKanaCore.convertLyrics(lyrics);
        console.log("[convertLyrics] Converted lines:", lines);

        if (!lines || !lines.length) {
          window.currentConvertedLines = [];
          window.activeIndex = -1;
          if (resultPanel) {
            resultPanel.innerHTML = "<p style='font-size:12px;color:#cbd5f5;'>有効な行がありませんでした。</p>";
          }
          saveStudioState(true);
          return;
        }
      } catch (error) {
        console.error("[convertLyrics] Error:", error);
        if (errorBanner) {
          errorBanner.textContent = `変換エラー: ${error.message}`;
          errorBanner.style.display = "block";
        }
        if (resultPanel) {
          resultPanel.innerHTML = `<p style='font-size:12px;color:#ff6b6b;'>変換エラーが発生しました: ${error.message}</p>`;
        }
        return;
      }

      // 変換成功: 結果を表示
      // Standard変換（最適化なし）をクライアントサイドで生成
      const linesWithComparison = lines.map(line => {
        const standard = convertToStandardKana(line.en || "");
        return {
          en: line.en || "",
          standard: standard,
          singkana: line.kana || "",
          lineNo: line.lineNo || 0
        };
      });

      window.currentConvertedLines = linesWithComparison;
      window.activeIndex = -1;

      // 2段比較表示を構築
      const frag = document.createDocumentFragment();
      
      // デフォルト表示: Pro結果のみ（比較は折りたたみ）
      linesWithComparison.forEach((line, i) => {
        const lineContainer = document.createElement("div");
        lineContainer.className = "mb-3 md:mb-4";

        // 英語原文（スマホで非表示 or 小さく）
        const enDiv = document.createElement("div");
        enDiv.className = "hidden md:block text-xs text-slate-400 mb-2";
        enDiv.textContent = line.en || "";
        lineContainer.appendChild(enDiv);

        // SingKANA（最適化あり）- メイン表示
        const singkanaBlock = createComparisonBlock(
          "singkana",
          (() => {
            const mode = __getDisplayMode();
            if (mode === "precise") return "日本語として歌えるカタカナ（最適）";
            if (mode === "natural") return "英語っぽく歌えるカタカナ";
            return "読むためのカタカナ";
          })(),
          line.singkana || "",
          i,
          "singkana",
          line.standard || "" // Standard版と比較してハイライト
        );
        lineContainer.appendChild(singkanaBlock);

        // 比較トグル（Standard版を折りたたみ）
        const compareToggle = document.createElement("div");
        compareToggle.className = "mt-2";
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "text-[10px] text-slate-400 hover:text-slate-300 transition flex items-center gap-1";
        toggleBtn.innerHTML = `<span>▼</span> <span>一般的なカタカナと比較する（歌いにくさの原因を見る）</span>`;
        
        const standardContainer = document.createElement("div");
        standardContainer.className = "hidden mt-2";
        const standardBlock = createComparisonBlock(
          "standard",
          "一般的なカタカナ（歌いやすさ最適化なし）",
          line.standard || "",
          i,
          "standard",
          null
        );
        standardContainer.appendChild(standardBlock);
        
        toggleBtn.onclick = () => {
          const isHidden = standardContainer.classList.contains("hidden");
          if (isHidden) {
            standardContainer.classList.remove("hidden");
            toggleBtn.innerHTML = `<span>▲</span> <span>一般的なカタカナを非表示</span>`;
          } else {
            standardContainer.classList.add("hidden");
            toggleBtn.innerHTML = `<span>▼</span> <span>一般的なカタカナと比較する（歌いにくさの原因を見る）</span>`;
          }
        };
        
        compareToggle.appendChild(toggleBtn);
        compareToggle.appendChild(standardContainer);
        lineContainer.appendChild(compareToggle);

        frag.appendChild(lineContainer);
      });

      // Pro誘導ボタン（比較UIの直下に配置）
      if (!isPro()) {
        const proCta = document.createElement("div");
        proCta.className = "mt-4 p-4 rounded-xl bg-gradient-to-r from-singkana-500/20 to-fuchsia-500/20 border border-singkana-400/40";
        proCta.innerHTML = `
          <div class="flex flex-col md:flex-row items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-singkana-100 mb-1">この品質で変換し続ける</p>
              <p class="text-xs text-slate-300">Proで無制限変換・精密（日本語歌唱最適）・歌いやすさスコア</p>
            </div>
            <a href="#pricing" class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-singkana-500 to-fuchsia-500 px-6 py-2.5 text-sm font-semibold text-white shadow-glow hover:brightness-110 transition whitespace-nowrap">
              <span>Proを開始</span>
              <span class="text-xs">▶</span>
            </a>
          </div>
        `;
        frag.appendChild(proCta);
      }

      resultPanel.innerHTML = "";
      resultPanel.appendChild(frag);

      setActiveIndex(0);
      saveStudioState(true);
    }


    // Standard変換（最適化なし）: クライアントサイド実装
    // 「機械的」「物足りない」「歌えない」を意図的に作る
    // WORD_OVERRIDESなし、フェイク発音なし、語尾ルールなし、ボーカルスタイルなし、伸ばしなし
    function convertToStandardKana(text) {
      if (!text || !text.trim()) return "";
      
      // 基本的な正規化のみ（アポストロフィ削除など）
      let line = text;
      line = line.replace(/[’'`´]/g, "");
      line = line.replace(/[:：]/g, " ");
      
      if (!line.trim()) return "";
      
      const words = line.split(/\s+/);
      const kanaWords = [];
      
      for (const raw of words) {
        if (!raw) continue;
        
        // 記号の処理
        const leadingPuncMatch = raw.match(/^[^A-Za-z0-9]+/);
        const trailingPuncMatch = raw.match(/[^A-Za-z0-9]+$/);
        const leadingPunc = leadingPuncMatch ? leadingPuncMatch[0] : "";
        const trailingPunc = trailingPuncMatch ? trailingPuncMatch[0] : "";
        
        const core = raw
          .replace(/^[^A-Za-z0-9]+/, "")
          .replace(/[^A-Za-z0-9]+$/, "");
        
        if (!core) {
          kanaWords.push(leadingPunc + trailingPunc);
          continue;
        }
        
        // 機械的なローマ字→かな変換（最適化一切なし）
        const kanaCore = romanToKanaStandard(core);
        kanaWords.push(leadingPunc + kanaCore + trailingPunc);
      }
      
      let kana = kanaWords.join(" ");
      
      // カタカナに統一（最適化なし、スペースはそのまま）
      kana = toKatakanaStandard(kana);
      
      return kana;
    }
    
    // 機械的なローマ字→かな変換（最適化一切なし）
    // 目的: 「物足りない」「歌えない」変換を作る
    function romanToKanaStandard(word) {
      if (!word) return "";
      
      let s = word.toLowerCase();
      
      // パターンマッチ一切なし（ph→ふ、sh→しなども使わない）
      // 文字単位の機械的な変換のみ
      const charMap = {
        a: "ア", e: "エ", i: "イ", o: "オ", u: "ウ",
        y: "イ",
        b: "ブ", c: "ク", d: "ド", f: "フ", g: "グ",
        h: "ハ", j: "ジ", k: "ク", l: "ル", m: "ム",
        n: "ン", p: "プ", q: "ク", r: "ル", s: "ス",
        t: "ト", v: "ヴ", w: "ウ", x: "クス", z: "ズ"
      };
      
      let result = [];
      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (charMap[ch]) {
          result.push(charMap[ch]);
        } else if (/[0-9]/.test(ch)) {
          result.push(ch);
        }
        // その他の文字は無視（機械的）
      }
      
      // スペースは入れない（単語ごとに区切るだけ）
      return result.join("");
    }
    
    // ひらがな→カタカナ変換（最適化なし）
    function toKatakanaStandard(str) {
      if (!str) return "";
      let result = str.replace(/[ぁ-ん]/g, function (ch) {
        return String.fromCharCode(ch.charCodeAt(0) + 0x60);
      });
      result = result.replace(/ゔ/g, "ヴ");
      return result;
    }
    
    // 差分ハイライト: Standard版とSingKANA版の違いを強調（本当に変わった部分だけ）
    function highlightDifferences(standard, singkana) {
      if (!standard || !singkana) {
        return escapeHtml(singkana || "");
      }

      // 単語単位で分割（スペース区切り）
      const standardWords = standard.split(/\s+/).filter(Boolean);
      const singkanaWords = singkana.split(/\s+/).filter(Boolean);
      
      // 単語単位で比較（本当に変わった部分だけをハイライト）
      const result = [];
      let sIdx = 0;
      let kIdx = 0;
      
      while (sIdx < standardWords.length || kIdx < singkanaWords.length) {
        if (sIdx < standardWords.length && kIdx < singkanaWords.length && 
            standardWords[sIdx] === singkanaWords[kIdx]) {
          // 一致する単語: 通常表示（色を付けない）
          result.push(escapeHtml(singkanaWords[kIdx]));
          sIdx++;
          kIdx++;
        } else {
          // 異なる単語: SingKANA側をハイライト（薄い背景のみ）
          if (kIdx < singkanaWords.length) {
            // 変更された部分だけを薄い背景で強調（色は控えめに）
            result.push(`<span class="bg-singkana-500/20 text-singkana-100 px-0.5 rounded">${escapeHtml(singkanaWords[kIdx])}</span>`);
            kIdx++;
          }
          // Standard側の異なる単語はスキップ
          if (sIdx < standardWords.length) {
            sIdx++;
          }
        }
        
        // スペースを追加（最後の単語以外）
        if (kIdx < singkanaWords.length || sIdx < standardWords.length) {
          result.push(" ");
        }
      }
      
      return result.join("");
    }
    
    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 比較ブロック（Standard/SingKANA）を作成
    function createComparisonBlock(type, label, text, lineIndex, mode, compareText) {
      const block = document.createElement("div");
      // SingKANA側は背景を少し暗くして主従を作る（Standardとの差を明度で取る）
      // Standard側は「安定させる」（背景・枠・装飾を削る）
      // スマホ最適化: パディング圧縮（p-4 → p-2.5 md:p-4）
      block.className = `rounded-lg md:rounded-xl border ${type === "singkana" ? "border-singkana-400/40 bg-slate-950/90 shadow-glow" : "border-slate-700/30 bg-transparent"} p-2.5 md:p-4`;

      // ヘッダー（ラベル + コピーボタン + 文字数）
      // スマホ最適化: マージン圧縮（mb-2 → mb-1.5 md:mb-2）
      const header = document.createElement("div");
      header.className = "flex items-center justify-between mb-1.5 md:mb-2 flex-wrap gap-1.5";
      
      const labelDiv = document.createElement("div");
      labelDiv.className = "flex items-center gap-1.5 flex-wrap";
      
      // ラベル（モードに応じて動的に変更）
      const labelText = document.createElement("span");
      labelText.className = `text-[10px] md:text-xs font-semibold ${type === "singkana" ? "text-singkana-100" : "text-slate-300"}`;
      
      // スマホでラベルを短縮（モードに応じて）
      let shortLabel;
      if (type === "singkana") {
        const mode = __getDisplayMode();
        if (mode === "precise") {
          shortLabel = "日本語として歌える";
        } else if (mode === "natural") {
          shortLabel = "英語っぽく歌える";
        } else {
          shortLabel = "読むためのカタカナ";
        }
      } else {
        shortLabel = "一般的なカタカナ";
      }
      
      labelText.textContent = shortLabel;
      labelText.innerHTML = `<span class="hidden md:inline">${label}</span><span class="md:hidden">${shortLabel}</span>`;
      labelDiv.appendChild(labelText);
      
      // SingKANA側にモードバッジを追加
      if (type === "singkana") {
        const mode = __getDisplayMode();
        const badge = document.createElement("span");
        
        // モードに応じたバッジを表示
        if (mode === "precise") {
          // 精密モード：日本語歌唱最適化バッジ
          badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-purple-500/15 border border-purple-400/25 text-[8px] font-medium text-purple-200/80";
          badge.innerHTML = "🟪<span class=\"hidden md:inline\"> 日本語歌唱最適化</span>";
        } else if (mode === "natural") {
          // ナチュラルモード：英語リズム保持バッジ
          badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-green-500/15 border border-green-400/25 text-[8px] font-medium text-green-200/80";
          badge.innerHTML = "🟩<span class=\"hidden md:inline\"> 英語リズム保持</span>";
        } else {
          // ベーシックモード：読む用バッジ
          badge.className = "inline-flex items-center gap-0.5 px-1 py-0.5 rounded-full bg-singkana-500/10 border border-singkana-400/20 text-[8px] font-medium text-singkana-200/70";
          badge.innerHTML = "🎤<span class=\"hidden md:inline\"> 歌唱向け</span>";
        }
        
        labelDiv.appendChild(badge);
      }
      
      header.appendChild(labelDiv);

      const actions = document.createElement("div");
      actions.className = "flex items-center gap-1.5 md:gap-2";
      
      // 文字数（スマホで小さく）
      const charCount = document.createElement("span");
      charCount.className = "text-[9px] md:text-[10px] text-slate-400";
      const textLength = (text || "").replace(/\s/g, "").length;
      charCount.textContent = `${textLength}文字`;
      actions.appendChild(charCount);

      // コピーボタン（スマホで小さく）
      const copyBtn = document.createElement("button");
      copyBtn.className = "inline-flex items-center gap-0.5 md:gap-1 px-1.5 md:px-2 py-0.5 md:py-1 rounded text-[9px] md:text-[10px] font-medium text-slate-300 hover:text-slate-100 bg-slate-800/50 hover:bg-slate-700/50 transition";
      copyBtn.innerHTML = `<span>📋</span><span class="hidden md:inline">Copy</span>`;
      copyBtn.onclick = (e) => {
        e.stopPropagation();
        navigator.clipboard.writeText(text || "").then(() => {
          copyBtn.innerHTML = "✓";
          setTimeout(() => {
            copyBtn.innerHTML = `<span>📋</span><span class="hidden md:inline">Copy</span>`;
          }, 1000);
        });
      };
      actions.appendChild(copyBtn);

      header.appendChild(actions);
      block.appendChild(header);

      // 変換結果テキスト（差分ハイライト付き）
      // スマホ最適化: フォントサイズ圧縮（text-sm → text-xs md:text-sm）
      // 行間を広げる（歌唱用テキストは「口に出すもの」なので読みやすく）
      const textDiv = document.createElement("div");
      textDiv.className = "result-ka text-xs md:text-sm text-slate-100 leading-loose md:leading-loose whitespace-pre-wrap";
      
      if (type === "singkana" && compareText) {
        // SingKANA版: 差分ハイライトを適用
        let highlighted = highlightDifferences(compareText, text);
        
        // Pro側だけブロック境界（息継ぎ位置）を表示（色ではなく記号で）
        if (isPro()) {
          // 息継ぎ位置に「｜」セパレータを挿入（色ではなく記号で区切りを表現）
          highlighted = addBreathMarks(highlighted);
        }
        
        textDiv.innerHTML = renderDisplay(highlighted, __getDisplayMode());
        
        // Pro側だけ「歌いやすさスコア」を表示（仮実装）
        if (isPro()) {
          const scoreDiv = document.createElement("div");
          scoreDiv.className = "mt-2 pt-2 border-t border-singkana-400/20";
          scoreDiv.innerHTML = `
            <div class="flex items-center gap-2 text-[10px] text-singkana-200">
              <span class="font-semibold">Singability:</span>
              <span class="text-singkana-100 font-bold">86/100</span>
              <span class="text-slate-400 ml-1">（息継ぎ・母音安定・連結自然さ）</span>
            </div>
          `;
          textDiv.appendChild(scoreDiv);
        }
      } else {
        // Standard版: 通常表示（文字色は普通、背景・枠・装飾を削る）
        textDiv.textContent = renderDisplay(text || "", __getDisplayMode());
        textDiv.className += " text-slate-300";  // Standard版は安定した文字色
      }
      
      block.appendChild(textDiv);

      return block;
    }

    // =========================
    // ブロック境界（息継ぎ位置）の追加（Pro側のみ）
    // =========================
    function addBreathMarks(text) {
      if (!text) return text;
      
      // HTMLタグを一時的に保護
      const tagPlaceholders = [];
      let tagIndex = 0;
      let processed = text.replace(/<[^>]+>/g, (match) => {
        const placeholder = `__TAG_${tagIndex}__`;
        tagPlaceholders[tagIndex] = match;
        tagIndex++;
        return placeholder;
      });
      
      // 単語単位で分割（スペース区切り）
      const words = processed.split(/(\s+)/);
      const result = [];
      let wordCount = 0;
      
      for (let i = 0; i < words.length; i++) {
        const word = words[i];
        
        // タグプレースホルダーはそのまま
        if (word.startsWith('__TAG_')) {
          result.push(word);
          continue;
        }
        
        // スペースはそのまま
        if (/^\s+$/.test(word)) {
          result.push(word);
          continue;
        }
        
        // 単語をカウント
        wordCount++;
        
        // 3-4単語ごとに息継ぎ位置を挿入（自然な区切り）
        if (wordCount > 0 && (wordCount % 3 === 0 || wordCount % 4 === 0)) {
          result.push(word);
          // 軽いセパレータ「｜」を追加（色ではなく記号で、薄い色）
          result.push(' <span class="text-slate-500/30 text-xs mx-0.5">｜</span> ');
        } else {
          result.push(word);
        }
      }
      
      // タグプレースホルダーを元に戻す
      let final = result.join('');
      for (let i = 0; i < tagPlaceholders.length; i++) {
        final = final.replace(`__TAG_${i}__`, tagPlaceholders[i]);
      }
      
      return final;
    }

    // =========================
    // 例文挿入（1クリックで価値を踏ませる）
    // =========================
    function insertExample(type) {
      const lyricsInput = document.getElementById("lyrics-input");
      if (!lyricsInput) return;
      
      const examples = {
        fast: "Put your heart on the line, we'll be flying tonight",
        consonant: "I want you to know that I'm still here",
        vowel: "Fly me to the moon, let me play among the stars"
      };
      
      const example = examples[type] || examples.fast;
      
      // 既にテキストがある場合は確認
      if (lyricsInput.value.trim()) {
        if (!confirm("現在の入力内容を置き換えますか？")) {
          return;
        }
      }
      
      lyricsInput.value = example;
      lyricsInput.focus();
      
      // 自動変換（オプション）
      // convertLyrics();
    }

    // =========================
    // 例文挿入（1クリックで価値を踏ませる）
    // =========================
    function insertExample(type) {
      const lyricsInput = document.getElementById("lyrics-input");
      if (!lyricsInput) return;
      
      const examples = {
        fast: "Put your heart on the line, we'll be flying tonight",
        consonant: "I want you to know that I'm still here",
        vowel: "Fly me to the moon, let me play among the stars"
      };
      
      const example = examples[type] || examples.fast;
      
      // 既にテキストがある場合は確認
      if (lyricsInput.value.trim()) {
        if (!confirm("現在の入力内容を置き換えますか？")) {
          return;
        }
      }
      
      lyricsInput.value = example;
      lyricsInput.focus();
      
      // 自動変換（オプション）
      // convertLyrics();
    }

    // =========================
    // Feedback (NOTE: /api/feedback が未実装なら必ず失敗する)
    // → 失敗してもUXが壊れないようにする
    // =========================
    async function sendFeedback() {
      const textBox = document.getElementById("feedback-text");
      const status = document.getElementById("feedback-status");
      const text = (textBox.value || "").trim();
      status.textContent = "";

      if (!text) { status.textContent = "フィードバック内容を入力してください。"; return; }

      const title = document.getElementById("song-title").value || "";
      const meta = { song: title, client_side: true, engine_version: "js-core-v1.9" };

      try {
        const res = await fetch("/api/feedback", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ text, meta }),
        });

        const data = await res.json().catch(() => ({ ok: false }));
        if (data.ok) {
          status.textContent = "フィードバックありがとうございました。";
          textBox.value = "";
          saveStudioState(true);
        } else {
          status.textContent = "送信に失敗しました（API未接続の可能性）。";
        }
      } catch (e) {
        console.error(e);
        status.textContent = "送信に失敗しました（ネットワーク/API未接続）。";
      }
    }
  </script>
</body>
</html>
