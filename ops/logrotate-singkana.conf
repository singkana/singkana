# ================================================================
# SingKANA logrotate 設定
# 配置先: /etc/logrotate.d/singkana
#
# Install:
#   sudo cp /var/www/singkana/ops/logrotate-singkana.conf /etc/logrotate.d/singkana
#   sudo logrotate --debug /etc/logrotate.d/singkana   # dry-run確認
# ================================================================

# --- Gunicorn アクセスログ + エラーログ ---
/var/log/singkana/gunicorn-access.log
/var/log/singkana/gunicorn-error.log
{
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    dateext
    dateformat -%Y%m%d
    sharedscripts
    postrotate
        # Gunicorn の graceful reload（USR1 でログファイルを re-open）
        kill -USR1 $(cat /run/singkana/gunicorn.pid 2>/dev/null) 2>/dev/null || \
        systemctl kill --signal=USR1 singkana.service 2>/dev/null || true
    endscript
}

# --- Sheet API アクセスログ（KPI集計用） ---
/var/log/singkana/sheet_api.access.log
{
    daily
    missingok
    rotate 90
    compress
    delaycompress
    notifempty
    dateext
    dateformat -%Y%m%d
    sharedscripts
    postrotate
        kill -USR1 $(cat /run/singkana/gunicorn.pid 2>/dev/null) 2>/dev/null || \
        systemctl kill --signal=USR1 singkana.service 2>/dev/null || true
    endscript
}

# --- Nginx（SingKANA vhost用） ---
/var/log/nginx/singkana.access.log
/var/log/nginx/singkana.error.log
{
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    dateext
    dateformat -%Y%m%d
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 $(cat /var/run/nginx.pid) || true
    endscript
}
