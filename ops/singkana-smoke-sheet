#!/bin/bash
set -euo pipefail

PRO_UID='sk_01KGGTEJ1B5Y80A3MNRQY8C5YQ'
ENDPOINT='http://127.0.0.1:5000/api/sheet/pdf'
HEALTH='http://127.0.0.1:5000/'
PDF=/tmp/smoke-normalize.pdf
HDR=/tmp/smoke_hdr.txt
BODY=/tmp/smoke_body.json

cat > $BODY <<'JSON'
{"title":"smoke-normalize","artist":"","lines":[{"orig":"tilde-ascii","kana":"ア~ イ"},{"orig":"tilde-wave","kana":"ア〜 イ"},{"orig":"tilde-fw","kana":"ア～ イ"},{"orig":"paren-fw","kana":"（テスト）"},{"orig":"paren-ascii","kana":"(テスト)"},{"orig":"arrows","kana":"↑ ⬆ ↓ ⬇"},{"orig":"breath","kana":"ア ˘ イ ｜ ウ"}]}
JSON

echo '=== SingKANA Sheet PDF Smoke Test ==='
echo "Endpoint: $ENDPOINT"

echo -n 'Waiting for gunicorn...'
for i in $(seq 1 20); do
  if curl -fsS -o /dev/null "$HEALTH" 2>/dev/null; then
    echo " ready (${i})"
    break
  fi
  if [ "$i" -eq 20 ]; then
    echo ' TIMEOUT after 10s'
    exit 1
  fi
  sleep 0.5
done

curl -sS -D "$HDR" \
  -H 'Origin: https://singkana.com' \
  -H 'Content-Type: application/json' \
  -b "sk_uid=$PRO_UID" \
  --data @"$BODY" \
  "$ENDPOINT" \
  -o "$PDF"

STATUS=$(grep -m1 -oP 'HTTP/\S+ \K\d+' "$HDR")
MAGIC=$(head -c 4 "$PDF")

echo "HTTP status: $STATUS"
echo "File magic:  $MAGIC"

if [ "$STATUS" != '200' ] || [ "$MAGIC" != '%PDF' ]; then
  echo "FAIL: PDF generation failed (status=$STATUS magic=$MAGIC)"
  cat "$PDF"
  exit 1
fi
echo 'PASS: PDF generated (200 + %PDF)'

if ! command -v pdftotext &>/dev/null; then
  echo 'SKIP: pdftotext not installed, content check skipped'
  exit 0
fi

TEXT=$(pdftotext "$PDF" - 2>/dev/null)
FAIL=0

check() {
  local label="$1" pattern="$2"
  if echo "$TEXT" | grep -qP "$pattern"; then
    echo "  OK: $label"
  else
    echo "  NG: $label (pattern not found)"
    FAIL=1
  fi
}

echo '--- Content checks ---'
check 'tilde-norm'     'ア～ イ'
check 'paren-norm'     '\(テスト\)'
check 'arrows-norm'    '↑↑↓↓'
check 'breath-norm'    'ア ・ イ ・ ウ'
check 'legend-breath'  'ブレス: ・'
check 'legend-arrows'  '強調: ↑↓'
check 'legend-liaison' '連結: ～'
check 'legend-elision' '脱落: \( \)'

if [ "$FAIL" -eq 0 ]; then
  echo 'ALL PASS'
else
  echo 'SOME CHECKS FAILED'
  exit 1
fi
