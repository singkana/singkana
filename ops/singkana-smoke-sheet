#!/bin/bash set -euo pipefail  PRO_UID="sk_01KGGTEJ1B5Y80A3MNRQY8C5YQ" ENDPOINT="http://127.0.0.1:5000/api/sheet/pdf" HEALTH="http://127.0.0.1:5000/" PDF=/tmp/smoke-normalize.pdf HDR=/tmp/smoke_hdr.txt BODY=/tmp/smoke_body.json  cat > "$BODY" <<'JSON' {"title":"smoke-normalize","artist":"","lines":[{"orig":"tilde-ascii","kana":"繧｢~ 繧､"},{"orig":"tilde-wave","kana":"繧｢縲・繧､"},{"orig":"tilde-fw","kana":"繧｢・・繧､"},{"orig":"paren-fw","kana":"・医ユ繧ｹ繝茨ｼ・},{"orig":"paren-ascii","kana":"(繝・せ繝・"},{"orig":"arrows","kana":"竊・筮・竊・筮・},{"orig":"breath","kana":"繧｢ ﾋ・繧､ ・・繧ｦ"}]} JSON  echo "=== SingKANA Sheet PDF Smoke Test ===" echo "Endpoint: $ENDPOINT"  echo -n "Waiting for gunicorn..." for i in $(seq 1 20); do   if curl -fsS -o /dev/null "$HEALTH" 2>/dev/null; then     echo " ready (${i})"     break   fi   if [ "$i" -eq 20 ]; then     echo " TIMEOUT after 10s"     exit 1   fi   sleep 0.5 done  curl -sS -D "$HDR" \   -H "Origin: https://singkana.com" \   -H "Content-Type: application/json" \   -b "sk_uid=$PRO_UID" \   --data @"$BODY" \   "$ENDPOINT" \   -o "$PDF"  STATUS=$(grep -m1 -oP 'HTTP/\S+ \K\d+' "$HDR") MAGIC=$(head -c 4 "$PDF")  echo "HTTP status: $STATUS" echo "File magic:  $MAGIC"  if [ "$STATUS" != "200" ] || [ "$MAGIC" != "%PDF" ]; then   echo "FAIL: PDF generation failed (status=$STATUS magic=$MAGIC)"   cat "$PDF"   exit 1 fi echo "PASS: PDF generated (200 + %PDF)"  if ! command -v pdftotext &>/dev/null; then   echo "SKIP: pdftotext not installed, content check skipped"   exit 0 fi  TEXT=$(pdftotext "$PDF" - 2>/dev/null) FAIL=0  check() {   local label="$1" pattern="$2"   if echo "$TEXT" | grep -qP "$pattern"; then     echo "  OK: $label"   else     echo "  NG: $label (pattern not found)"     FAIL=1   fi }  echo "--- Content checks ---" check "tilde-norm"     "繧｢・・繧､" check "paren-norm"     "\(繝・せ繝・)" check "arrows-norm"    "竊鯛・竊凪・" check "breath-norm"    "繧｢ 繝ｻ 繧､ 繝ｻ 繧ｦ" check "legend-breath"  "繝悶Ξ繧ｹ: 繝ｻ" check "legend-arrows"  "蠑ｷ隱ｿ: 竊鯛・" check "legend-liaison" "騾｣邨・ ・・ check "legend-elision" "閼ｱ關ｽ: \( \)"  if [ "$FAIL" -eq 0 ]; then   echo "ALL PASS" else   echo "SOME CHECKS FAILED"   exit 1 fi